"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/payments/route";
exports.ids = ["app/api/payments/route"];
exports.modules = {

/***/ "../../client/components/action-async-storage.external":
/*!*******************************************************************************!*\
  !*** external "next/dist/client/components/action-async-storage.external.js" ***!
  \*******************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/client/components/action-async-storage.external.js");

/***/ }),

/***/ "../../client/components/request-async-storage.external":
/*!********************************************************************************!*\
  !*** external "next/dist/client/components/request-async-storage.external.js" ***!
  \********************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/client/components/request-async-storage.external.js");

/***/ }),

/***/ "../../client/components/static-generation-async-storage.external":
/*!******************************************************************************************!*\
  !*** external "next/dist/client/components/static-generation-async-storage.external.js" ***!
  \******************************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/client/components/static-generation-async-storage.external.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "buffer":
/*!*************************!*\
  !*** external "buffer" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("buffer");

/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "events":
/*!*************************!*\
  !*** external "events" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("events");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

module.exports = require("https");

/***/ }),

/***/ "net":
/*!**********************!*\
  !*** external "net" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("net");

/***/ }),

/***/ "punycode":
/*!***************************!*\
  !*** external "punycode" ***!
  \***************************/
/***/ ((module) => {

module.exports = require("punycode");

/***/ }),

/***/ "stream":
/*!*************************!*\
  !*** external "stream" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("stream");

/***/ }),

/***/ "tls":
/*!**********************!*\
  !*** external "tls" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("tls");

/***/ }),

/***/ "url":
/*!**********************!*\
  !*** external "url" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("url");

/***/ }),

/***/ "zlib":
/*!***********************!*\
  !*** external "zlib" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("zlib");

/***/ }),

/***/ "node:async_hooks":
/*!***********************************!*\
  !*** external "node:async_hooks" ***!
  \***********************************/
/***/ ((module) => {

module.exports = require("node:async_hooks");

/***/ }),

/***/ "node:crypto":
/*!******************************!*\
  !*** external "node:crypto" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:crypto");

/***/ }),

/***/ "node:fs":
/*!**************************!*\
  !*** external "node:fs" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("node:fs");

/***/ }),

/***/ "node:path":
/*!****************************!*\
  !*** external "node:path" ***!
  \****************************/
/***/ ((module) => {

module.exports = require("node:path");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fpayments%2Froute&page=%2Fapi%2Fpayments%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fpayments%2Froute.js&appDir=C%3A%5CUsers%5Cbacze%5CProject%5CGroupShare%5Cgroupshare-project%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Cbacze%5CProject%5CGroupShare%5Cgroupshare-project&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!******************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fpayments%2Froute&page=%2Fapi%2Fpayments%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fpayments%2Froute.js&appDir=C%3A%5CUsers%5Cbacze%5CProject%5CGroupShare%5Cgroupshare-project%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Cbacze%5CProject%5CGroupShare%5Cgroupshare-project&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \******************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var C_Users_bacze_Project_GroupShare_groupshare_project_src_app_api_payments_route_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./src/app/api/payments/route.js */ \"(rsc)/./src/app/api/payments/route.js\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/payments/route\",\n        pathname: \"/api/payments\",\n        filename: \"route\",\n        bundlePath: \"app/api/payments/route\"\n    },\n    resolvedPagePath: \"C:\\\\Users\\\\bacze\\\\Project\\\\GroupShare\\\\groupshare-project\\\\src\\\\app\\\\api\\\\payments\\\\route.js\",\n    nextConfigOutput,\n    userland: C_Users_bacze_Project_GroupShare_groupshare_project_src_app_api_payments_route_js__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/payments/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZwYXltZW50cyUyRnJvdXRlJnBhZ2U9JTJGYXBpJTJGcGF5bWVudHMlMkZyb3V0ZSZhcHBQYXRocz0mcGFnZVBhdGg9cHJpdmF0ZS1uZXh0LWFwcC1kaXIlMkZhcGklMkZwYXltZW50cyUyRnJvdXRlLmpzJmFwcERpcj1DJTNBJTVDVXNlcnMlNUNiYWN6ZSU1Q1Byb2plY3QlNUNHcm91cFNoYXJlJTVDZ3JvdXBzaGFyZS1wcm9qZWN0JTVDc3JjJTVDYXBwJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmcm9vdERpcj1DJTNBJTVDVXNlcnMlNUNiYWN6ZSU1Q1Byb2plY3QlNUNHcm91cFNoYXJlJTVDZ3JvdXBzaGFyZS1wcm9qZWN0JmlzRGV2PXRydWUmdHNjb25maWdQYXRoPXRzY29uZmlnLmpzb24mYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBc0c7QUFDdkM7QUFDYztBQUM0QztBQUN6SDtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsZ0hBQW1CO0FBQzNDO0FBQ0EsY0FBYyx5RUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsWUFBWTtBQUNaLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxRQUFRLGlFQUFpRTtBQUN6RTtBQUNBO0FBQ0EsV0FBVyw0RUFBVztBQUN0QjtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ3VIOztBQUV2SCIsInNvdXJjZXMiOlsid2VicGFjazovL2dyb3Vwc2hhcmUtcHJvamVjdC8/ZjFhMyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBSb3V0ZVJvdXRlTW9kdWxlIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IHBhdGNoRmV0Y2ggYXMgX3BhdGNoRmV0Y2ggfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9saWIvcGF0Y2gtZmV0Y2hcIjtcbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCJDOlxcXFxVc2Vyc1xcXFxiYWN6ZVxcXFxQcm9qZWN0XFxcXEdyb3VwU2hhcmVcXFxcZ3JvdXBzaGFyZS1wcm9qZWN0XFxcXHNyY1xcXFxhcHBcXFxcYXBpXFxcXHBheW1lbnRzXFxcXHJvdXRlLmpzXCI7XG4vLyBXZSBpbmplY3QgdGhlIG5leHRDb25maWdPdXRwdXQgaGVyZSBzbyB0aGF0IHdlIGNhbiB1c2UgdGhlbSBpbiB0aGUgcm91dGVcbi8vIG1vZHVsZS5cbmNvbnN0IG5leHRDb25maWdPdXRwdXQgPSBcIlwiXG5jb25zdCByb3V0ZU1vZHVsZSA9IG5ldyBBcHBSb3V0ZVJvdXRlTW9kdWxlKHtcbiAgICBkZWZpbml0aW9uOiB7XG4gICAgICAgIGtpbmQ6IFJvdXRlS2luZC5BUFBfUk9VVEUsXG4gICAgICAgIHBhZ2U6IFwiL2FwaS9wYXltZW50cy9yb3V0ZVwiLFxuICAgICAgICBwYXRobmFtZTogXCIvYXBpL3BheW1lbnRzXCIsXG4gICAgICAgIGZpbGVuYW1lOiBcInJvdXRlXCIsXG4gICAgICAgIGJ1bmRsZVBhdGg6IFwiYXBwL2FwaS9wYXltZW50cy9yb3V0ZVwiXG4gICAgfSxcbiAgICByZXNvbHZlZFBhZ2VQYXRoOiBcIkM6XFxcXFVzZXJzXFxcXGJhY3plXFxcXFByb2plY3RcXFxcR3JvdXBTaGFyZVxcXFxncm91cHNoYXJlLXByb2plY3RcXFxcc3JjXFxcXGFwcFxcXFxhcGlcXFxccGF5bWVudHNcXFxccm91dGUuanNcIixcbiAgICBuZXh0Q29uZmlnT3V0cHV0LFxuICAgIHVzZXJsYW5kXG59KTtcbi8vIFB1bGwgb3V0IHRoZSBleHBvcnRzIHRoYXQgd2UgbmVlZCB0byBleHBvc2UgZnJvbSB0aGUgbW9kdWxlLiBUaGlzIHNob3VsZFxuLy8gYmUgZWxpbWluYXRlZCB3aGVuIHdlJ3ZlIG1vdmVkIHRoZSBvdGhlciByb3V0ZXMgdG8gdGhlIG5ldyBmb3JtYXQuIFRoZXNlXG4vLyBhcmUgdXNlZCB0byBob29rIGludG8gdGhlIHJvdXRlLlxuY29uc3QgeyByZXF1ZXN0QXN5bmNTdG9yYWdlLCBzdGF0aWNHZW5lcmF0aW9uQXN5bmNTdG9yYWdlLCBzZXJ2ZXJIb29rcyB9ID0gcm91dGVNb2R1bGU7XG5jb25zdCBvcmlnaW5hbFBhdGhuYW1lID0gXCIvYXBpL3BheW1lbnRzL3JvdXRlXCI7XG5mdW5jdGlvbiBwYXRjaEZldGNoKCkge1xuICAgIHJldHVybiBfcGF0Y2hGZXRjaCh7XG4gICAgICAgIHNlcnZlckhvb2tzLFxuICAgICAgICBzdGF0aWNHZW5lcmF0aW9uQXN5bmNTdG9yYWdlXG4gICAgfSk7XG59XG5leHBvcnQgeyByb3V0ZU1vZHVsZSwgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MsIG9yaWdpbmFsUGF0aG5hbWUsIHBhdGNoRmV0Y2gsICB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcHAtcm91dGUuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fpayments%2Froute&page=%2Fapi%2Fpayments%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fpayments%2Froute.js&appDir=C%3A%5CUsers%5Cbacze%5CProject%5CGroupShare%5Cgroupshare-project%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Cbacze%5CProject%5CGroupShare%5Cgroupshare-project&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./src/app/api/payments/route.js":
/*!***************************************!*\
  !*** ./src/app/api/payments/route.js ***!
  \***************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var _clerk_nextjs_server__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @clerk/nextjs/server */ \"(rsc)/./node_modules/@clerk/nextjs/dist/esm/app-router/server/currentUser.js\");\n/* harmony import */ var _lib_database_supabase_client__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @/lib/database/supabase-client */ \"(rsc)/./src/lib/database/supabase-client.js\");\n/* harmony import */ var _services_payment_payment_service__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/services/payment/payment-service */ \"(rsc)/./src/services/payment/payment-service.js\");\n// src/app/api/payments/route.js\n\n\n\n\n/**\r\n * POST /api/payments\r\n * Przetwarza płatność za subskrypcję i automatycznie przyznaje dostęp\r\n * Zrefaktoryzowana wersja używająca PaymentService\r\n */ async function POST(request) {\n    try {\n        const { purchaseId, paymentMethod } = await request.json();\n        // Sprawdź autentykację\n        const user = await (0,_clerk_nextjs_server__WEBPACK_IMPORTED_MODULE_3__.currentUser)();\n        if (!user) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Unauthorized\"\n            }, {\n                status: 401\n            });\n        }\n        console.log(\"Processing payment for user:\", user.id);\n        // Pobierz profil użytkownika\n        let userProfile = await _lib_database_supabase_client__WEBPACK_IMPORTED_MODULE_1__.userRepository.getByAuthId(user.id);\n        // Jeśli nie znaleziono profilu, utwórz nowy\n        if (!userProfile) {\n            console.log(\"User profile not found, creating new profile\");\n            // Tworzenie nowego profilu\n            const newProfile = {\n                external_auth_id: user.id,\n                display_name: user.firstName ? `${user.firstName} ${user.lastName || \"\"}`.trim() : user.username || \"Nowy użytkownik\",\n                email: user.emailAddresses[0]?.emailAddress || \"\",\n                phone_number: user.phoneNumbers[0]?.phoneNumber || null,\n                profile_type: \"buyer\",\n                verification_level: \"basic\",\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString()\n            };\n            userProfile = await _lib_database_supabase_client__WEBPACK_IMPORTED_MODULE_1__.userRepository.create(newProfile);\n            if (!userProfile) {\n                return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                    error: \"Failed to create user profile\"\n                }, {\n                    status: 500\n                });\n            }\n        }\n        try {\n            // Przetwórz płatność za pomocą serwisu płatności\n            const result = await _services_payment_payment_service__WEBPACK_IMPORTED_MODULE_2__.paymentService.processPayment(purchaseId, paymentMethod, userProfile.id);\n            // Zwróć odpowiedź w formacie kompatybilnym z dotychczasowym API\n            // aby zachować zgodność z istniejącym kodem frontendu\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                success: true,\n                message: \"Payment processed successfully\",\n                purchaseId: purchaseId,\n                accessUrl: result.accessUrl,\n                recovered: result.recovered // dodane pole informujące o częściowym odzyskaniu\n            });\n        } catch (paymentError) {\n            // Sprawdź, czy komunikat błędu dotyczy braku miejsc\n            if (paymentError.message.includes(\"Brak dostępnych miejsc\")) {\n                return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                    error: \"Przepraszamy, ale wszystkie miejsca zostały już zajęte. Odśwież stronę, aby zobaczyć aktualne oferty.\",\n                    code: \"NO_AVAILABLE_SLOTS\"\n                }, {\n                    status: 400\n                });\n            }\n            // Inny błąd płatności\n            throw paymentError;\n        }\n    } catch (error) {\n        console.error(\"Error processing payment:\", error);\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: error.message || \"Failed to process payment\"\n        }, {\n            status: 500\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvYXBwL2FwaS9wYXltZW50cy9yb3V0ZS5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLGdDQUFnQztBQUNXO0FBQ1E7QUFDYTtBQUNJO0FBRXBFOzs7O0NBSUMsR0FDTSxlQUFlSSxLQUFLQyxPQUFPO0lBQ2hDLElBQUk7UUFDRixNQUFNLEVBQUVDLFVBQVUsRUFBRUMsYUFBYSxFQUFFLEdBQUcsTUFBTUYsUUFBUUcsSUFBSTtRQUV4RCx1QkFBdUI7UUFDdkIsTUFBTUMsT0FBTyxNQUFNUixpRUFBV0E7UUFDOUIsSUFBSSxDQUFDUSxNQUFNO1lBQ1QsT0FBT1QscURBQVlBLENBQUNRLElBQUksQ0FDdEI7Z0JBQUVFLE9BQU87WUFBZSxHQUN4QjtnQkFBRUMsUUFBUTtZQUFJO1FBRWxCO1FBRUFDLFFBQVFDLEdBQUcsQ0FBQyxnQ0FBZ0NKLEtBQUtLLEVBQUU7UUFFbkQsNkJBQTZCO1FBQzdCLElBQUlDLGNBQWMsTUFBTWIseUVBQWNBLENBQUNjLFdBQVcsQ0FBQ1AsS0FBS0ssRUFBRTtRQUUxRCw0Q0FBNEM7UUFDNUMsSUFBSSxDQUFDQyxhQUFhO1lBQ2hCSCxRQUFRQyxHQUFHLENBQUM7WUFFWiwyQkFBMkI7WUFDM0IsTUFBTUksYUFBYTtnQkFDakJDLGtCQUFrQlQsS0FBS0ssRUFBRTtnQkFDekJLLGNBQWNWLEtBQUtXLFNBQVMsR0FDeEIsQ0FBQyxFQUFFWCxLQUFLVyxTQUFTLENBQUMsQ0FBQyxFQUFFWCxLQUFLWSxRQUFRLElBQUksR0FBRyxDQUFDLENBQUNDLElBQUksS0FDOUNiLEtBQUtjLFFBQVEsSUFBSTtnQkFDdEJDLE9BQU9mLEtBQUtnQixjQUFjLENBQUMsRUFBRSxFQUFFQyxnQkFBZ0I7Z0JBQy9DQyxjQUFjbEIsS0FBS21CLFlBQVksQ0FBQyxFQUFFLEVBQUVDLGVBQWU7Z0JBQ25EQyxjQUFjO2dCQUNkQyxvQkFBb0I7Z0JBQ3BCQyxZQUFZLElBQUlDLE9BQU9DLFdBQVc7Z0JBQ2xDQyxZQUFZLElBQUlGLE9BQU9DLFdBQVc7WUFDcEM7WUFFQW5CLGNBQWMsTUFBTWIseUVBQWNBLENBQUNrQyxNQUFNLENBQUNuQjtZQUUxQyxJQUFJLENBQUNGLGFBQWE7Z0JBQ2hCLE9BQU9mLHFEQUFZQSxDQUFDUSxJQUFJLENBQ3RCO29CQUFFRSxPQUFPO2dCQUFnQyxHQUN6QztvQkFBRUMsUUFBUTtnQkFBSTtZQUVsQjtRQUNGO1FBRUEsSUFBSTtZQUNGLGlEQUFpRDtZQUNqRCxNQUFNMEIsU0FBUyxNQUFNbEMsNkVBQWNBLENBQUNtQyxjQUFjLENBQ2hEaEMsWUFDQUMsZUFDQVEsWUFBWUQsRUFBRTtZQUdoQixnRUFBZ0U7WUFDaEUsc0RBQXNEO1lBQ3RELE9BQU9kLHFEQUFZQSxDQUFDUSxJQUFJLENBQUM7Z0JBQ3ZCK0IsU0FBUztnQkFDVEMsU0FBUztnQkFDVGxDLFlBQVlBO2dCQUNabUMsV0FBV0osT0FBT0ksU0FBUztnQkFDM0JDLFdBQVdMLE9BQU9LLFNBQVMsQ0FBQyxrREFBa0Q7WUFDaEY7UUFDRixFQUFFLE9BQU9DLGNBQWM7WUFDckIsb0RBQW9EO1lBQ3BELElBQUlBLGFBQWFILE9BQU8sQ0FBQ0ksUUFBUSxDQUFDLDJCQUEyQjtnQkFDM0QsT0FBTzVDLHFEQUFZQSxDQUFDUSxJQUFJLENBQ3RCO29CQUNFRSxPQUFPO29CQUNQbUMsTUFBTTtnQkFDUixHQUNBO29CQUFFbEMsUUFBUTtnQkFBSTtZQUVsQjtZQUVBLHNCQUFzQjtZQUN0QixNQUFNZ0M7UUFDUjtJQUNGLEVBQUUsT0FBT2pDLE9BQU87UUFDZEUsUUFBUUYsS0FBSyxDQUFDLDZCQUE2QkE7UUFDM0MsT0FBT1YscURBQVlBLENBQUNRLElBQUksQ0FDdEI7WUFBRUUsT0FBT0EsTUFBTThCLE9BQU8sSUFBSTtRQUE0QixHQUN0RDtZQUFFN0IsUUFBUTtRQUFJO0lBRWxCO0FBQ0YiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9ncm91cHNoYXJlLXByb2plY3QvLi9zcmMvYXBwL2FwaS9wYXltZW50cy9yb3V0ZS5qcz9lNjhkIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9hcHAvYXBpL3BheW1lbnRzL3JvdXRlLmpzXHJcbmltcG9ydCB7IE5leHRSZXNwb25zZSB9IGZyb20gJ25leHQvc2VydmVyJztcclxuaW1wb3J0IHsgY3VycmVudFVzZXIgfSBmcm9tICdAY2xlcmsvbmV4dGpzL3NlcnZlcic7XHJcbmltcG9ydCB7IHVzZXJSZXBvc2l0b3J5IH0gZnJvbSAnQC9saWIvZGF0YWJhc2Uvc3VwYWJhc2UtY2xpZW50JztcclxuaW1wb3J0IHsgcGF5bWVudFNlcnZpY2UgfSBmcm9tICdAL3NlcnZpY2VzL3BheW1lbnQvcGF5bWVudC1zZXJ2aWNlJztcclxuXHJcbi8qKlxyXG4gKiBQT1NUIC9hcGkvcGF5bWVudHNcclxuICogUHJ6ZXR3YXJ6YSBwxYJhdG5vxZvEhyB6YSBzdWJza3J5cGNqxJkgaSBhdXRvbWF0eWN6bmllIHByenl6bmFqZSBkb3N0xJlwXHJcbiAqIFpyZWZha3Rvcnl6b3dhbmEgd2Vyc2phIHXFvHl3YWrEhWNhIFBheW1lbnRTZXJ2aWNlXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gUE9TVChyZXF1ZXN0KSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHsgcHVyY2hhc2VJZCwgcGF5bWVudE1ldGhvZCB9ID0gYXdhaXQgcmVxdWVzdC5qc29uKCk7XHJcbiAgICBcclxuICAgIC8vIFNwcmF3ZMW6IGF1dGVudHlrYWNqxJlcclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjdXJyZW50VXNlcigpO1xyXG4gICAgaWYgKCF1c2VyKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDEgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zb2xlLmxvZygnUHJvY2Vzc2luZyBwYXltZW50IGZvciB1c2VyOicsIHVzZXIuaWQpO1xyXG4gICAgXHJcbiAgICAvLyBQb2JpZXJ6IHByb2ZpbCB1xbx5dGtvd25pa2FcclxuICAgIGxldCB1c2VyUHJvZmlsZSA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LmdldEJ5QXV0aElkKHVzZXIuaWQpO1xyXG4gICAgXHJcbiAgICAvLyBKZcWbbGkgbmllIHpuYWxlemlvbm8gcHJvZmlsdSwgdXR3w7NyeiBub3d5XHJcbiAgICBpZiAoIXVzZXJQcm9maWxlKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdVc2VyIHByb2ZpbGUgbm90IGZvdW5kLCBjcmVhdGluZyBuZXcgcHJvZmlsZScpO1xyXG4gICAgICBcclxuICAgICAgLy8gVHdvcnplbmllIG5vd2VnbyBwcm9maWx1XHJcbiAgICAgIGNvbnN0IG5ld1Byb2ZpbGUgPSB7XHJcbiAgICAgICAgZXh0ZXJuYWxfYXV0aF9pZDogdXNlci5pZCxcclxuICAgICAgICBkaXNwbGF5X25hbWU6IHVzZXIuZmlyc3ROYW1lIFxyXG4gICAgICAgICAgPyBgJHt1c2VyLmZpcnN0TmFtZX0gJHt1c2VyLmxhc3ROYW1lIHx8ICcnfWAudHJpbSgpIFxyXG4gICAgICAgICAgOiAodXNlci51c2VybmFtZSB8fCAnTm93eSB1xbx5dGtvd25paycpLFxyXG4gICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsQWRkcmVzc2VzWzBdPy5lbWFpbEFkZHJlc3MgfHwgJycsXHJcbiAgICAgICAgcGhvbmVfbnVtYmVyOiB1c2VyLnBob25lTnVtYmVyc1swXT8ucGhvbmVOdW1iZXIgfHwgbnVsbCxcclxuICAgICAgICBwcm9maWxlX3R5cGU6ICdidXllcicsXHJcbiAgICAgICAgdmVyaWZpY2F0aW9uX2xldmVsOiAnYmFzaWMnLFxyXG4gICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgfTtcclxuICAgICAgXHJcbiAgICAgIHVzZXJQcm9maWxlID0gYXdhaXQgdXNlclJlcG9zaXRvcnkuY3JlYXRlKG5ld1Byb2ZpbGUpO1xyXG4gICAgICBcclxuICAgICAgaWYgKCF1c2VyUHJvZmlsZSkge1xyXG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICAgIHsgZXJyb3I6ICdGYWlsZWQgdG8gY3JlYXRlIHVzZXIgcHJvZmlsZScgfSxcclxuICAgICAgICAgIHsgc3RhdHVzOiA1MDAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gUHJ6ZXR3w7NyeiBwxYJhdG5vxZvEhyB6YSBwb21vY8SFIHNlcndpc3UgcMWCYXRub8WbY2lcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGF5bWVudFNlcnZpY2UucHJvY2Vzc1BheW1lbnQoXHJcbiAgICAgICAgcHVyY2hhc2VJZCwgXHJcbiAgICAgICAgcGF5bWVudE1ldGhvZCwgXHJcbiAgICAgICAgdXNlclByb2ZpbGUuaWRcclxuICAgICAgKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFp3csOzxIcgb2Rwb3dpZWTFuiB3IGZvcm1hY2llIGtvbXBhdHliaWxueW0geiBkb3R5Y2hjemFzb3d5bSBBUElcclxuICAgICAgLy8gYWJ5IHphY2hvd2HEhyB6Z29kbm/Fm8SHIHogaXN0bmllasSFY3ltIGtvZGVtIGZyb250ZW5kdVxyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgbWVzc2FnZTogJ1BheW1lbnQgcHJvY2Vzc2VkIHN1Y2Nlc3NmdWxseScsXHJcbiAgICAgICAgcHVyY2hhc2VJZDogcHVyY2hhc2VJZCxcclxuICAgICAgICBhY2Nlc3NVcmw6IHJlc3VsdC5hY2Nlc3NVcmwsXHJcbiAgICAgICAgcmVjb3ZlcmVkOiByZXN1bHQucmVjb3ZlcmVkIC8vIGRvZGFuZSBwb2xlIGluZm9ybXVqxIVjZSBvIGN6xJnFm2Npb3d5bSBvZHp5c2thbml1XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAocGF5bWVudEVycm9yKSB7XHJcbiAgICAgIC8vIFNwcmF3ZMW6LCBjenkga29tdW5pa2F0IGLFgsSZZHUgZG90eWN6eSBicmFrdSBtaWVqc2NcclxuICAgICAgaWYgKHBheW1lbnRFcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdCcmFrIGRvc3TEmXBueWNoIG1pZWpzYycpKSB7XHJcbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICAgICAgeyBcclxuICAgICAgICAgICAgZXJyb3I6ICdQcnplcHJhc3phbXksIGFsZSB3c3p5c3RraWUgbWllanNjYSB6b3N0YcWCeSBqdcW8IHphasSZdGUuIE9kxZt3aWXFvCBzdHJvbsSZLCBhYnkgem9iYWN6ecSHIGFrdHVhbG5lIG9mZXJ0eS4nLFxyXG4gICAgICAgICAgICBjb2RlOiAnTk9fQVZBSUxBQkxFX1NMT1RTJ1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIC8vIElubnkgYsWCxIVkIHDFgmF0bm/Fm2NpXHJcbiAgICAgIHRocm93IHBheW1lbnRFcnJvcjtcclxuICAgIH1cclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgcHJvY2Vzc2luZyBwYXltZW50OicsIGVycm9yKTtcclxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgeyBlcnJvcjogZXJyb3IubWVzc2FnZSB8fCAnRmFpbGVkIHRvIHByb2Nlc3MgcGF5bWVudCcgfSxcclxuICAgICAgeyBzdGF0dXM6IDUwMCB9XHJcbiAgICApO1xyXG4gIH1cclxufSJdLCJuYW1lcyI6WyJOZXh0UmVzcG9uc2UiLCJjdXJyZW50VXNlciIsInVzZXJSZXBvc2l0b3J5IiwicGF5bWVudFNlcnZpY2UiLCJQT1NUIiwicmVxdWVzdCIsInB1cmNoYXNlSWQiLCJwYXltZW50TWV0aG9kIiwianNvbiIsInVzZXIiLCJlcnJvciIsInN0YXR1cyIsImNvbnNvbGUiLCJsb2ciLCJpZCIsInVzZXJQcm9maWxlIiwiZ2V0QnlBdXRoSWQiLCJuZXdQcm9maWxlIiwiZXh0ZXJuYWxfYXV0aF9pZCIsImRpc3BsYXlfbmFtZSIsImZpcnN0TmFtZSIsImxhc3ROYW1lIiwidHJpbSIsInVzZXJuYW1lIiwiZW1haWwiLCJlbWFpbEFkZHJlc3NlcyIsImVtYWlsQWRkcmVzcyIsInBob25lX251bWJlciIsInBob25lTnVtYmVycyIsInBob25lTnVtYmVyIiwicHJvZmlsZV90eXBlIiwidmVyaWZpY2F0aW9uX2xldmVsIiwiY3JlYXRlZF9hdCIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsInVwZGF0ZWRfYXQiLCJjcmVhdGUiLCJyZXN1bHQiLCJwcm9jZXNzUGF5bWVudCIsInN1Y2Nlc3MiLCJtZXNzYWdlIiwiYWNjZXNzVXJsIiwicmVjb3ZlcmVkIiwicGF5bWVudEVycm9yIiwiaW5jbHVkZXMiLCJjb2RlIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./src/app/api/payments/route.js\n");

/***/ }),

/***/ "(rsc)/./src/lib/database/supabase-admin-client.js":
/*!***************************************************!*\
  !*** ./src/lib/database/supabase-admin-client.js ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   createUserProfileAdmin: () => (/* binding */ createUserProfileAdmin),\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__),\n/* harmony export */   getGroupMembersAdmin: () => (/* binding */ getGroupMembersAdmin),\n/* harmony export */   getSubscriptionPlatformsAdmin: () => (/* binding */ getSubscriptionPlatformsAdmin),\n/* harmony export */   getUserByAuthIdAdmin: () => (/* binding */ getUserByAuthIdAdmin),\n/* harmony export */   handleSupabaseAdminError: () => (/* binding */ handleSupabaseAdminError),\n/* harmony export */   logAdminActivity: () => (/* binding */ logAdminActivity),\n/* harmony export */   updateUserProfileAdmin: () => (/* binding */ updateUserProfileAdmin)\n/* harmony export */ });\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n// src/lib/supabase-admin-client.js\n\n// Inicjalizacja klienta Supabase z uprawnieniami administratora\nconst supabaseUrl = \"https://nimrnohkesysfppcmujb.supabase.co\";\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n// Sprawdzenie czy zmienne środowiskowe są ustawione\nif (!supabaseUrl || !supabaseServiceKey) {\n    console.error(\"Missing environment variables: NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY\");\n}\n// Uwaga: Ten klient ma pełne uprawnienia do bazy danych, używaj ostrożnie!\nconst supabaseAdmin = (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__.createClient)(supabaseUrl, supabaseServiceKey, {\n    auth: {\n        persistSession: false,\n        autoRefreshToken: false\n    }\n});\n// Funkcja pomocnicza do obsługi błędów Supabase\nconst handleSupabaseAdminError = (error)=>{\n    console.error(\"Supabase Admin error:\", error);\n    return {\n        error: true,\n        message: error.message || \"Nieoczekiwany błąd administratora\",\n        code: error.code || \"unknown_error\",\n        details: error.details || null\n    };\n};\n// Funkcje administratora do zarządzania użytkownikami\n// Funkcja do tworzenia profilu użytkownika przez administratora\nconst createUserProfileAdmin = async (userProfile)=>{\n    try {\n        const { data, error } = await supabaseAdmin.from(\"user_profiles\").insert([\n            userProfile\n        ]).select().single();\n        if (error) {\n            if (error.code === \"23505\") {\n                console.warn(\"Admin: Pr\\xf3ba utworzenia duplikatu profilu użytkownika:\", error);\n                // Jeśli profil już istnieje, pobierz go\n                const { data: existingUser, error: fetchError } = await supabaseAdmin.from(\"user_profiles\").select(\"*\").eq(\"external_auth_id\", userProfile.external_auth_id).single();\n                if (fetchError) {\n                    throw new Error(\"Nie można pobrać istniejącego profilu: \" + fetchError.message);\n                }\n                return existingUser;\n            } else {\n                throw new Error(error.message || \"Nie udało się utworzyć profilu użytkownika\");\n            }\n        }\n        return data;\n    } catch (error) {\n        handleSupabaseAdminError(error);\n        throw error;\n    }\n};\n// Funkcja do pobierania profilu użytkownika przez administratora\nconst getUserByAuthIdAdmin = async (authId)=>{\n    if (!authId) return null;\n    try {\n        const { data, error } = await supabaseAdmin.from(\"user_profiles\").select(\"*\").eq(\"external_auth_id\", authId).single();\n        if (error) {\n            if (error.code === \"PGRST116\") {\n                // Nie znaleziono - to normalny przypadek\n                return null;\n            } else {\n                console.error(\"Admin: Błąd pobierania profilu użytkownika:\", error);\n                throw new Error(error.message || \"Nie udało się pobrać profilu użytkownika\");\n            }\n        }\n        return data;\n    } catch (error) {\n        handleSupabaseAdminError(error);\n        throw error;\n    }\n};\n// Funkcja do aktualizacji profilu użytkownika przez administratora\nconst updateUserProfileAdmin = async (userId, updates)=>{\n    try {\n        const { data, error } = await supabaseAdmin.from(\"user_profiles\").update(updates).eq(\"id\", userId).select().single();\n        if (error) throw error;\n        return data;\n    } catch (error) {\n        handleSupabaseAdminError(error);\n        throw error;\n    }\n};\n// Funkcja do pobierania platform subskrypcyjnych przez administratora\nconst getSubscriptionPlatformsAdmin = async ()=>{\n    try {\n        const { data, error } = await supabaseAdmin.from(\"subscription_platforms\").select(\"*\").order(\"name\");\n        if (error) throw error;\n        return data;\n    } catch (error) {\n        handleSupabaseAdminError(error);\n        return [];\n    }\n};\n// Funkcja do pobierania członków grupy przez administratora\nconst getGroupMembersAdmin = async (groupId)=>{\n    try {\n        const { data, error } = await supabaseAdmin.from(\"group_members\").select(`\r\n        *,\r\n        user:user_profiles(id, display_name, avatar_url, email)\r\n      `).eq(\"group_id\", groupId);\n        if (error) throw error;\n        return data;\n    } catch (error) {\n        handleSupabaseAdminError(error);\n        return [];\n    }\n};\n// Zapisz wszystkie aktywności administratora do logu bezpieczeństwa\nconst logAdminActivity = async (action, resourceType, resourceId, details = {})=>{\n    try {\n        const { data, error } = await supabaseAdmin.from(\"security_logs\").insert([\n            {\n                action_type: action,\n                resource_type: resourceType,\n                resource_id: resourceId,\n                status: \"success\",\n                details: details\n            }\n        ]);\n        if (error) console.error(\"Błąd logowania aktywności administratora:\", error);\n    } catch (error) {\n        console.error(\"Wyjątek podczas logowania aktywności administratora:\", error);\n    }\n};\n// Eksport klienta administratora jako domyślny\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (supabaseAdmin);\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL2RhdGFiYXNlL3N1cGFiYXNlLWFkbWluLWNsaWVudC5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSxtQ0FBbUM7QUFDa0I7QUFFckQsZ0VBQWdFO0FBQ2hFLE1BQU1DLGNBQWNDLDBDQUFvQztBQUN4RCxNQUFNRyxxQkFBcUJILFFBQVFDLEdBQUcsQ0FBQ0cseUJBQXlCO0FBRWhFLG9EQUFvRDtBQUNwRCxJQUFJLENBQUNMLGVBQWUsQ0FBQ0ksb0JBQW9CO0lBQ3ZDRSxRQUFRQyxLQUFLLENBQ1g7QUFFSjtBQUVBLDJFQUEyRTtBQUMzRSxNQUFNQyxnQkFBZ0JULG1FQUFZQSxDQUFDQyxhQUFhSSxvQkFBb0I7SUFDbEVLLE1BQU07UUFDSkMsZ0JBQWdCO1FBQ2hCQyxrQkFBa0I7SUFDcEI7QUFDRjtBQUVBLGdEQUFnRDtBQUN6QyxNQUFNQywyQkFBMkIsQ0FBQ0w7SUFDdkNELFFBQVFDLEtBQUssQ0FBQyx5QkFBeUJBO0lBRXZDLE9BQU87UUFDTEEsT0FBTztRQUNQTSxTQUFTTixNQUFNTSxPQUFPLElBQUk7UUFDMUJDLE1BQU1QLE1BQU1PLElBQUksSUFBSTtRQUNwQkMsU0FBU1IsTUFBTVEsT0FBTyxJQUFJO0lBQzVCO0FBQ0YsRUFBRTtBQUVGLHNEQUFzRDtBQUV0RCxnRUFBZ0U7QUFDekQsTUFBTUMseUJBQXlCLE9BQU9DO0lBQzNDLElBQUk7UUFDRixNQUFNLEVBQUVDLElBQUksRUFBRVgsS0FBSyxFQUFFLEdBQUcsTUFBTUMsY0FDM0JXLElBQUksQ0FBQyxpQkFDTEMsTUFBTSxDQUFDO1lBQUNIO1NBQVksRUFDcEJJLE1BQU0sR0FDTkMsTUFBTTtRQUVULElBQUlmLE9BQU87WUFDVCxJQUFJQSxNQUFNTyxJQUFJLEtBQUssU0FBUztnQkFDMUJSLFFBQVFpQixJQUFJLENBQUMsNkRBQTBEaEI7Z0JBRXZFLHdDQUF3QztnQkFDeEMsTUFBTSxFQUFFVyxNQUFNTSxZQUFZLEVBQUVqQixPQUFPa0IsVUFBVSxFQUFFLEdB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QyxLQUFLLENBQUMsNkNBQTZDQTtJQUV4RSxFQUFFLE9BQU9BLE9BQU87UUFDZEQsUUFBUUMsS0FBSyxDQUFDLHdEQUF3REE7SUFDeEU7QUFDRixFQUFFO0FBRUYsK0NBQStDO0FBQy9DLGlFQUFlQyxhQUFhQSxFQUFDIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vZ3JvdXBzaGFyZS1wcm9qZWN0Ly4vc3JjL2xpYi9kYXRhYmFzZS9zdXBhYmFzZS1hZG1pbi1jbGllbnQuanM/MzQ3NyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvbGliL3N1cGFiYXNlLWFkbWluLWNsaWVudC5qc1xyXG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tICdAc3VwYWJhc2Uvc3VwYWJhc2UtanMnO1xyXG5cclxuLy8gSW5pY2phbGl6YWNqYSBrbGllbnRhIFN1cGFiYXNlIHogdXByYXduaWVuaWFtaSBhZG1pbmlzdHJhdG9yYVxyXG5jb25zdCBzdXBhYmFzZVVybCA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTDtcclxuY29uc3Qgc3VwYWJhc2VTZXJ2aWNlS2V5ID0gcHJvY2Vzcy5lbnYuU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWTtcclxuXHJcbi8vIFNwcmF3ZHplbmllIGN6eSB6bWllbm5lIMWbcm9kb3dpc2tvd2Ugc8SFIHVzdGF3aW9uZVxyXG5pZiAoIXN1cGFiYXNlVXJsIHx8ICFzdXBhYmFzZVNlcnZpY2VLZXkpIHtcclxuICBjb25zb2xlLmVycm9yKFxyXG4gICAgJ01pc3NpbmcgZW52aXJvbm1lbnQgdmFyaWFibGVzOiBORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwgb3IgU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSdcclxuICApO1xyXG59XHJcblxyXG4vLyBVd2FnYTogVGVuIGtsaWVudCBtYSBwZcWCbmUgdXByYXduaWVuaWEgZG8gYmF6eSBkYW55Y2gsIHXFvHl3YWogb3N0cm/FvG5pZSFcclxuY29uc3Qgc3VwYWJhc2VBZG1pbiA9IGNyZWF0ZUNsaWVudChzdXBhYmFzZVVybCwgc3VwYWJhc2VTZXJ2aWNlS2V5LCB7XHJcbiAgYXV0aDoge1xyXG4gICAgcGVyc2lzdFNlc3Npb246IGZhbHNlLFxyXG4gICAgYXV0b1JlZnJlc2hUb2tlbjogZmFsc2UsXHJcbiAgfSxcclxufSk7XHJcblxyXG4vLyBGdW5rY2phIHBvbW9jbmljemEgZG8gb2JzxYJ1Z2kgYsWCxJlkw7N3IFN1cGFiYXNlXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVTdXBhYmFzZUFkbWluRXJyb3IgPSAoZXJyb3IpID0+IHtcclxuICBjb25zb2xlLmVycm9yKCdTdXBhYmFzZSBBZG1pbiBlcnJvcjonLCBlcnJvcik7XHJcbiAgXHJcbiAgcmV0dXJuIHtcclxuICAgIGVycm9yOiB0cnVlLFxyXG4gICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB8fCAnTmllb2N6ZWtpd2FueSBixYLEhWQgYWRtaW5pc3RyYXRvcmEnLFxyXG4gICAgY29kZTogZXJyb3IuY29kZSB8fCAndW5rbm93bl9lcnJvcicsXHJcbiAgICBkZXRhaWxzOiBlcnJvci5kZXRhaWxzIHx8IG51bGwsXHJcbiAgfTtcclxufTtcclxuXHJcbi8vIEZ1bmtjamUgYWRtaW5pc3RyYXRvcmEgZG8gemFyesSFZHphbmlhIHXFvHl0a293bmlrYW1pXHJcblxyXG4vLyBGdW5rY2phIGRvIHR3b3J6ZW5pYSBwcm9maWx1IHXFvHl0a293bmlrYSBwcnpleiBhZG1pbmlzdHJhdG9yYVxyXG5leHBvcnQgY29uc3QgY3JlYXRlVXNlclByb2ZpbGVBZG1pbiA9IGFzeW5jICh1c2VyUHJvZmlsZSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgIC5mcm9tKCd1c2VyX3Byb2ZpbGVzJylcclxuICAgICAgLmluc2VydChbdXNlclByb2ZpbGVdKVxyXG4gICAgICAuc2VsZWN0KClcclxuICAgICAgLnNpbmdsZSgpO1xyXG4gICAgXHJcbiAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICcyMzUwNScpIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oJ0FkbWluOiBQcsOzYmEgdXR3b3J6ZW5pYSBkdXBsaWthdHUgcHJvZmlsdSB1xbx5dGtvd25pa2E6JywgZXJyb3IpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIEplxZtsaSBwcm9maWwganXFvCBpc3RuaWVqZSwgcG9iaWVyeiBnb1xyXG4gICAgICAgIGNvbnN0IHsgZGF0YTogZXhpc3RpbmdVc2VyLCBlcnJvcjogZmV0Y2hFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAgICAgLmZyb20oJ3VzZXJfcHJvZmlsZXMnKVxyXG4gICAgICAgICAgLnNlbGVjdCgnKicpXHJcbiAgICAgICAgICAuZXEoJ2V4dGVybmFsX2F1dGhfaWQnLCB1c2VyUHJvZmlsZS5leHRlcm5hbF9hdXRoX2lkKVxyXG4gICAgICAgICAgLnNpbmdsZSgpO1xyXG4gICAgICAgICAgXHJcbiAgICAgICAgaWYgKGZldGNoRXJyb3IpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTmllIG1vxbxuYSBwb2JyYcSHIGlzdG5pZWrEhWNlZ28gcHJvZmlsdTogJyArIGZldGNoRXJyb3IubWVzc2FnZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBleGlzdGluZ1VzZXI7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yLm1lc3NhZ2UgfHwgJ05pZSB1ZGHFgm8gc2nEmSB1dHdvcnp5xIcgcHJvZmlsdSB1xbx5dGtvd25pa2EnKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICByZXR1cm4gZGF0YTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgaGFuZGxlU3VwYWJhc2VBZG1pbkVycm9yKGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufTtcclxuXHJcbi8vIEZ1bmtjamEgZG8gcG9iaWVyYW5pYSBwcm9maWx1IHXFvHl0a293bmlrYSBwcnpleiBhZG1pbmlzdHJhdG9yYVxyXG5leHBvcnQgY29uc3QgZ2V0VXNlckJ5QXV0aElkQWRtaW4gPSBhc3luYyAoYXV0aElkKSA9PiB7XHJcbiAgaWYgKCFhdXRoSWQpIHJldHVybiBudWxsO1xyXG4gIFxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgIC5mcm9tKCd1c2VyX3Byb2ZpbGVzJylcclxuICAgICAgLnNlbGVjdCgnKicpXHJcbiAgICAgIC5lcSgnZXh0ZXJuYWxfYXV0aF9pZCcsIGF1dGhJZClcclxuICAgICAgLnNpbmdsZSgpO1xyXG4gICAgXHJcbiAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICdQR1JTVDExNicpIHtcclxuICAgICAgICAvLyBOaWUgem5hbGV6aW9ubyAtIHRvIG5vcm1hbG55IHByenlwYWRla1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0FkbWluOiBCxYLEhWQgcG9iaWVyYW5pYSBwcm9maWx1IHXFvHl0a293bmlrYTonLCBlcnJvcik7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yLm1lc3NhZ2UgfHwgJ05pZSB1ZGHFgm8gc2nEmSBwb2JyYcSHIHByb2ZpbHUgdcW8eXRrb3duaWthJyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgcmV0dXJuIGRhdGE7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGhhbmRsZVN1cGFiYXNlQWRtaW5FcnJvcihlcnJvcik7XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn07XHJcblxyXG4vLyBGdW5rY2phIGRvIGFrdHVhbGl6YWNqaSBwcm9maWx1IHXFvHl0a293bmlrYSBwcnpleiBhZG1pbmlzdHJhdG9yYVxyXG5leHBvcnQgY29uc3QgdXBkYXRlVXNlclByb2ZpbGVBZG1pbiA9IGFzeW5jICh1c2VySWQsIHVwZGF0ZXMpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAuZnJvbSgndXNlcl9wcm9maWxlcycpXHJcbiAgICAgIC51cGRhdGUodXBkYXRlcylcclxuICAgICAgLmVxKCdpZCcsIHVzZXJJZClcclxuICAgICAgLnNlbGVjdCgpXHJcbiAgICAgIC5zaW5nbGUoKTtcclxuICAgIFxyXG4gICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuICAgIFxyXG4gICAgcmV0dXJuIGRhdGE7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGhhbmRsZVN1cGFiYXNlQWRtaW5FcnJvcihlcnJvcik7XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn07XHJcblxyXG4vLyBGdW5rY2phIGRvIHBvYmllcmFuaWEgcGxhdGZvcm0gc3Vic2tyeXBjeWpueWNoIHByemV6IGFkbWluaXN0cmF0b3JhXHJcbmV4cG9ydCBjb25zdCBnZXRTdWJzY3JpcHRpb25QbGF0Zm9ybXNBZG1pbiA9IGFzeW5jICgpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAuZnJvbSgnc3Vic2NyaXB0aW9uX3BsYXRmb3JtcycpXHJcbiAgICAgIC5zZWxlY3QoJyonKVxyXG4gICAgICAub3JkZXIoJ25hbWUnKTtcclxuICAgIFxyXG4gICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuICAgIFxyXG4gICAgcmV0dXJuIGRhdGE7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGhhbmRsZVN1cGFiYXNlQWRtaW5FcnJvcihlcnJvcik7XHJcbiAgICByZXR1cm4gW107XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gRnVua2NqYSBkbyBwb2JpZXJhbmlhIGN6xYJvbmvDs3cgZ3J1cHkgcHJ6ZXogYWRtaW5pc3RyYXRvcmFcclxuZXhwb3J0IGNvbnN0IGdldEdyb3VwTWVtYmVyc0FkbWluID0gYXN5bmMgKGdyb3VwSWQpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAuZnJvbSgnZ3JvdXBfbWVtYmVycycpXHJcbiAgICAgIC5zZWxlY3QoYFxyXG4gICAgICAgICosXHJcbiAgICAgICAgdXNlcjp1c2VyX3Byb2ZpbGVzKGlkLCBkaXNwbGF5X25hbWUsIGF2YXRhcl91cmwsIGVtYWlsKVxyXG4gICAgICBgKVxyXG4gICAgICAuZXEoJ2dyb3VwX2lkJywgZ3JvdXBJZCk7XHJcbiAgICBcclxuICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcbiAgICBcclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBoYW5kbGVTdXBhYmFzZUFkbWluRXJyb3IoZXJyb3IpO1xyXG4gICAgcmV0dXJuIFtdO1xyXG4gIH1cclxufTtcclxuXHJcbi8vIFphcGlzeiB3c3p5c3RraWUgYWt0eXdub8WbY2kgYWRtaW5pc3RyYXRvcmEgZG8gbG9ndSBiZXpwaWVjemXFhHN0d2FcclxuZXhwb3J0IGNvbnN0IGxvZ0FkbWluQWN0aXZpdHkgPSBhc3luYyAoYWN0aW9uLCByZXNvdXJjZVR5cGUsIHJlc291cmNlSWQsIGRldGFpbHMgPSB7fSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgIC5mcm9tKCdzZWN1cml0eV9sb2dzJylcclxuICAgICAgLmluc2VydChbe1xyXG4gICAgICAgIGFjdGlvbl90eXBlOiBhY3Rpb24sXHJcbiAgICAgICAgcmVzb3VyY2VfdHlwZTogcmVzb3VyY2VUeXBlLFxyXG4gICAgICAgIHJlc291cmNlX2lkOiByZXNvdXJjZUlkLFxyXG4gICAgICAgIHN0YXR1czogJ3N1Y2Nlc3MnLFxyXG4gICAgICAgIGRldGFpbHM6IGRldGFpbHMsXHJcbiAgICAgIH1dKTtcclxuICAgIFxyXG4gICAgaWYgKGVycm9yKSBjb25zb2xlLmVycm9yKCdCxYLEhWQgbG9nb3dhbmlhIGFrdHl3bm/Fm2NpIGFkbWluaXN0cmF0b3JhOicsIGVycm9yKTtcclxuICAgIFxyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdXeWrEhXRlayBwb2RjemFzIGxvZ293YW5pYSBha3R5d25vxZtjaSBhZG1pbmlzdHJhdG9yYTonLCBlcnJvcik7XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gRWtzcG9ydCBrbGllbnRhIGFkbWluaXN0cmF0b3JhIGpha28gZG9tecWbbG55XHJcbmV4cG9ydCBkZWZhdWx0IHN1cGFiYXNlQWRtaW47Il0sIm5hbWVzIjpbImNyZWF0ZUNsaWVudCIsInN1cGFiYXNlVXJsIiwicHJvY2VzcyIsImVudiIsIk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCIsInN1cGFiYXNlU2VydmljZUtleSIsIlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkiLCJjb25zb2xlIiwiZXJyb3IiLCJzdXBhYmFzZUFkbWluIiwiYXV0aCIsInBlcnNpc3RTZXNzaW9uIiwiYXV0b1JlZnJlc2hUb2tlbiIsImhhbmRsZVN1cGFiYXNlQWRtaW5FcnJvciIsIm1lc3NhZ2UiLCJjb2RlIiwiZGV0YWlscyIsImNyZWF0ZVVzZXJQcm9maWxlQWRtaW4iLCJ1c2VyUHJvZmlsZSIsImRhdGEiLCJmcm9tIiwiaW5zZXJ0Iiwic2VsZWN0Iiwic2luZ2xlIiwid2FybiIsImV4aXN0aW5nVXNlciIsImZldGNoRXJyb3IiLCJlcSIsImV4dGVybmFsX2F1dGhfaWQiLCJFcnJvciIsImdldFVzZXJCeUF1dGhJZEFkbWluIiwiYXV0aElkIiwidXBkYXRlVXNlclByb2ZpbGVBZG1pbiIsInVzZXJJZCIsInVwZGF0ZXMiLCJ1cGRhdGUiLCJnZXRTdWJzY3JpcHRpb25QbGF0Zm9ybXNBZG1pbiIsIm9yZGVyIiwiZ2V0R3JvdXBNZW1iZXJzQWRtaW4iLCJncm91cElkIiwibG9nQWRtaW5BY3Rpdml0eSIsImFjdGlvbiIsInJlc291cmNlVHlwZSIsInJlc291cmNlSWQiLCJhY3Rpb25fdHlwZSIsInJlc291cmNlX3R5cGUiLCJyZXNvdXJjZV9pZCIsInN0YXR1cyJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/database/supabase-admin-client.js\n");

/***/ }),

/***/ "(rsc)/./src/lib/database/supabase-client.js":
/*!*********************************************!*\
  !*** ./src/lib/database/supabase-client.js ***!
  \*********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__),\n/* harmony export */   handleDatabaseError: () => (/* binding */ handleDatabaseError),\n/* harmony export */   offersRepository: () => (/* binding */ offersRepository),\n/* harmony export */   platformsRepository: () => (/* binding */ platformsRepository),\n/* harmony export */   purchasesRepository: () => (/* binding */ purchasesRepository),\n/* harmony export */   safeQueryExecution: () => (/* binding */ safeQueryExecution),\n/* harmony export */   userRepository: () => (/* binding */ userRepository)\n/* harmony export */ });\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n/* harmony import */ var _supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./supabase-admin-client */ \"(rsc)/./src/lib/database/supabase-admin-client.js\");\n// src/lib/database/supabase-client.js\n\n\n// Inicjalizacja klienta Supabase\nconst supabaseUrl = \"https://nimrnohkesysfppcmujb.supabase.co\";\nconst supabaseAnonKey = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pbXJub2hrZXN5c2ZwcGNtdWpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ2MzI1ODgsImV4cCI6MjA2MDIwODU4OH0.xanoTueWzP87TJEZj3zNa8qyC3eRMooobIL71bjxdEs\";\n// Sprawdzenie, czy zmienne środowiskowe są ustawione\nif (!supabaseUrl || !supabaseAnonKey) {\n    console.error(\"Brak wymaganych zmiennych środowiskowych: NEXT_PUBLIC_SUPABASE_URL lub NEXT_PUBLIC_SUPABASE_ANON_KEY\");\n}\n// Stała instancja klienta Supabase do ponownego użycia w całej aplikacji\nconst supabase = (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_1__.createClient)(supabaseUrl, supabaseAnonKey);\n/**\r\n * Standardowa obsługa błędów Supabase \r\n * @param {Error} error - Błąd zwrócony przez Supabase\r\n * @param {string} operation - Nazwa operacji, która spowodowała błąd\r\n * @param {boolean} throwError - Czy wyrzucić błąd (true) czy zwrócić obiekt błędu (false)\r\n * @returns {Object} - Standardowy obiekt błędu (jeśli throwError = false)\r\n * @throws {Error} - Rzuca błąd (jeśli throwError = true)\r\n */ const handleDatabaseError = (error, operation = \"database operation\", throwError = false)=>{\n    // Tworzenie standardowego obiektu błędu\n    const standardError = {\n        error: true,\n        message: error.message || `Wystąpił błąd podczas ${operation}`,\n        code: error.code || \"unknown_error\",\n        details: error.details || null,\n        operation,\n        data: [] // Dodano pustą tablicę dla kompatybilności z klientem\n    };\n    // Zapisz szczegółowy log błędu\n    console.error(`Database error during ${operation}:`, {\n        message: error.message,\n        code: error.code,\n        details: error.details,\n        stack: error.stack\n    });\n    if (throwError) {\n        // Stwórz nowy obiekt błędu z dodatkowymi metadanymi\n        const enhancedError = new Error(standardError.message);\n        enhancedError.code = standardError.code;\n        enhancedError.details = standardError.details;\n        enhancedError.operation = operation;\n        enhancedError.data = []; // Dodano pustą tablicę dla kompatybilności\n        throw enhancedError;\n    }\n    return standardError;\n};\n/**\r\n * Bezpieczne wykonanie operacji Supabase z obsługą błędów i fallbackiem do klienta administratora\r\n * @param {Function} operation - Funkcja operacji Supabase do wykonania\r\n * @param {string} operationName - Nazwa operacji (dla logów)\r\n * @param {boolean} useAdminOnFailure - Czy próbować z klientem admin w przypadku błędu uprawnień\r\n * @param {boolean} throwOnError - Czy wyrzucać błędy zamiast zwracać null/[] \r\n * @returns {Promise<any>} - Wynik operacji lub null/[] w przypadku błędu\r\n */ const safeQueryExecution = async (operation, operationName = \"database operation\", useAdminOnFailure = true, throwOnError = false)=>{\n    try {\n        // Próba wykonania operacji ze standardowym klientem\n        const result = await operation(supabase);\n        // Jeśli wynik zawiera błąd\n        if (result.error) {\n            // Jeśli to błąd uprawnień i mamy fallback do admina\n            if (result.error.code === \"42501\" && useAdminOnFailure) {\n                console.log(`Permission denied during ${operationName}, trying admin client`);\n                // Próba wykonania tej samej operacji z klientem administratora\n                const adminResult = await operation(_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"]);\n                if (adminResult.error) {\n                    return handleDatabaseError(adminResult.error, operationName, throwOnError);\n                }\n                // Upewnij się, że zwracamy dane w oczekiwanym formacie\n                if (Array.isArray(adminResult.data)) {\n                    return adminResult.data;\n                } else if (adminResult.data === null || adminResult.data === undefined) {\n                    return []; // Zwracamy pustą tablicę jeśli nie ma danych\n                } else {\n                    return adminResult.data; // Zwracamy pojedynczy obiekt\n                }\n            }\n            return handleDatabaseError(result.error, operationName, throwOnError);\n        }\n        // Upewnij się, że zwracamy dane w oczekiwanym formacie\n        if (Array.isArray(result.data)) {\n            return result.data;\n        } else if (result.data === null || result.data === undefined) {\n            return []; // Zwracamy pustą tablicę jeśli nie ma danych\n        } else {\n            return result.data; // Zwracamy pojedynczy obiekt\n        }\n    } catch (error) {\n        return handleDatabaseError(error, operationName, throwOnError);\n    }\n};\n// Repozytoria dostępu do danych - wysoki poziom abstrakcji\n/**\r\n * Repozytorium użytkowników\r\n */ const userRepository = {\n    /**\r\n   * Pobiera profil użytkownika na podstawie zewnętrznego ID uwierzytelniania\r\n   * @param {string} authId - ID uwierzytelniania (np. z Clerk)\r\n   * @returns {Promise<Object|null>} - Profil użytkownika lub null\r\n   */ async getByAuthId (authId) {\n        if (!authId) return null;\n        return safeQueryExecution((client)=>client.from(\"user_profiles\").select(\"*\").eq(\"external_auth_id\", authId).single(), \"getByAuthId\");\n    },\n    /**\r\n   * Tworzy nowy profil użytkownika\r\n   * @param {Object} userProfile - Dane profilu użytkownika\r\n   * @returns {Promise<Object|null>} - Utworzony profil użytkownika lub null\r\n   */ async create (userProfile) {\n        return safeQueryExecution((client)=>client.from(\"user_profiles\").insert([\n                userProfile\n            ]).select().single(), \"createUserProfile\", true // zawsze używaj klienta admina przy tworzeniu użytkownika\n        );\n    },\n    /**\r\n   * Aktualizuje istniejący profil użytkownika\r\n   * @param {string} userId - ID profilu użytkownika\r\n   * @param {Object} updates - Dane do aktualizacji\r\n   * @returns {Promise<Object|null>} - Zaktualizowany profil użytkownika lub null\r\n   */ async update (userId, updates) {\n        return safeQueryExecution((client)=>client.from(\"user_profiles\").update(updates).eq(\"id\", userId).select().single(), \"updateUserProfile\");\n    },\n    /**\r\n   * Pobiera profil użytkownika po ID\r\n   * @param {string} userId - ID profilu użytkownika\r\n   * @returns {Promise<Object|null>} - Profil użytkownika lub null\r\n   */ async getById (userId) {\n        return safeQueryExecution((client)=>client.from(\"user_profiles\").select(\"*\").eq(\"id\", userId).single(), \"getUserById\");\n    }\n};\n/**\r\n * Repozytorium ofert subskrypcji\r\n */ const offersRepository = {\n    /**\r\n   * Pobiera oferty subskrypcji z filtrowaniem\r\n   * @param {Object} filters - Filtry do zastosowania\r\n   * @returns {Promise<Array>} - Lista ofert\r\n   */ async getAll (filters = {}) {\n        // Przygotowanie bazowego zapytania\n        const queryBuilder = (client)=>{\n            let query = client.from(\"group_subs\").select(`\r\n          *,\r\n          subscription_platforms(*),\r\n          groups(id, name),\r\n          owner:groups!inner(owner_id, user_profiles!inner(id, display_name, avatar_url, rating_avg, rating_count, verification_level))\r\n        `).eq(\"status\", \"active\");\n            // Zastosowanie filtrów\n            if (filters.platformId) {\n                query = query.eq(\"platform_id\", filters.platformId);\n            }\n            if (filters.minPrice !== undefined) {\n                query = query.gte(\"price_per_slot\", filters.minPrice);\n            }\n            if (filters.maxPrice !== undefined) {\n                query = query.lte(\"price_per_slot\", filters.maxPrice);\n            }\n            if (filters.availableSlots === true) {\n                query = query.gt(\"slots_available\", 0);\n            }\n            // Sortowanie\n            const orderBy = filters.orderBy || \"created_at\";\n            const ascending = filters.ascending === true;\n            query = query.order(orderBy, {\n                ascending\n            });\n            // Paginacja\n            if (filters.limit) {\n                query = query.limit(filters.limit);\n            }\n            if (filters.offset) {\n                query = query.range(filters.offset, filters.offset + (filters.limit || 10) - 1);\n            }\n            return query;\n        };\n        return safeQueryExecution(queryBuilder, \"getAllOffers\") || [];\n    },\n    /**\r\n   * Pobiera ofertę subskrypcji po ID\r\n   * @param {string} offerId - ID oferty\r\n   * @returns {Promise<Object|null>} - Oferta subskrypcji lub null\r\n   */ async getById (offerId) {\n        return safeQueryExecution((client)=>client.from(\"group_subs\").select(`\r\n          *,\r\n          subscription_platforms(*),\r\n          groups(id, name, description),\r\n          owner:groups!inner(owner_id, user_profiles!inner(id, display_name, avatar_url, rating_avg, rating_count, verification_level, bio))\r\n        `).eq(\"id\", offerId).single(), \"getOfferById\");\n    },\n    /**\r\n   * Tworzy nową ofertę subskrypcji\r\n   * @param {Object} offerData - Dane oferty\r\n   * @returns {Promise<Object|null>} - Utworzona oferta lub null\r\n   */ async create (offerData) {\n        return safeQueryExecution((client)=>client.from(\"group_subs\").insert([\n                offerData\n            ]).select().single(), \"createOffer\");\n    },\n    /**\r\n   * Aktualizuje ofertę subskrypcji\r\n   * @param {string} offerId - ID oferty\r\n   * @param {Object} updates - Dane do aktualizacji\r\n   * @returns {Promise<Object|null>} - Zaktualizowana oferta lub null \r\n   */ async update (offerId, updates) {\n        return safeQueryExecution((client)=>client.from(\"group_subs\").update(updates).eq(\"id\", offerId).select().single(), \"updateOffer\");\n    },\n    /**\r\n   * Usuwa ofertę subskrypcji\r\n   * @param {string} offerId - ID oferty\r\n   * @returns {Promise<boolean>} - Czy operacja się powiodła\r\n   */ async delete (offerId) {\n        const result = await safeQueryExecution((client)=>client.from(\"group_subs\").delete().eq(\"id\", offerId), \"deleteOffer\");\n        return result !== null;\n    }\n};\n/**\r\n * Repozytorium platform subskrypcji\r\n */ const platformsRepository = {\n    /**\r\n   * Pobiera wszystkie aktywne platformy subskrypcji\r\n   * @returns {Promise<Array>} - Lista platform\r\n   */ async getAll () {\n        return safeQueryExecution((client)=>client.from(\"subscription_platforms\").select(\"*\").eq(\"active\", true).order(\"name\"), \"getAllPlatforms\") || [];\n    },\n    /**\r\n   * Pobiera platformę po ID\r\n   * @param {string} platformId - ID platformy\r\n   * @returns {Promise<Object|null>} - Platforma lub null\r\n   */ async getById (platformId) {\n        return safeQueryExecution((client)=>client.from(\"subscription_platforms\").select(\"*\").eq(\"id\", platformId).single(), \"getPlatformById\");\n    }\n};\n/**\r\n * Repozytorium zakupów\r\n */ const purchasesRepository = {\n    /**\r\n   * Tworzy nowy zakup\r\n   * @param {Object} purchaseData - Dane zakupu\r\n   * @returns {Promise<Object|null>} - Utworzony zakup lub null\r\n   */ async create (purchaseData) {\n        return safeQueryExecution((client)=>client.from(\"purchase_records\").insert([\n                purchaseData\n            ]).select().single(), \"createPurchase\", true // używaj klienta admin\n        );\n    },\n    /**\r\n   * Pobiera zakup po ID\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @returns {Promise<Object|null>} - Zakup lub null\r\n   */ async getById (purchaseId) {\n        return safeQueryExecution((client)=>client.from(\"purchase_records\").select(`\r\n          *,\r\n          group_sub:group_subs(\r\n            *,\r\n            subscription_platforms(\r\n              id,\r\n              name,\r\n              icon\r\n            )\r\n          )\r\n        `).eq(\"id\", purchaseId).single(), \"getPurchaseById\");\n    },\n    /**\r\n   * Aktualizuje zakup\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @param {Object} updates - Dane do aktualizacji\r\n   * @returns {Promise<Object|null>} - Zaktualizowany zakup lub null\r\n   */ async update (purchaseId, updates) {\n        return safeQueryExecution((client)=>client.from(\"purchase_records\").update(updates).eq(\"id\", purchaseId).select().single(), \"updatePurchase\");\n    },\n    /**\r\n   * Pobiera zakupy użytkownika\r\n   * @param {string} userId - ID użytkownika\r\n   * @returns {Promise<Array>} - Lista zakupów\r\n   */ async getByUserId (userId) {\n        return safeQueryExecution((client)=>client.from(\"purchase_records\").select(`\r\n          *,\r\n          group_sub:group_subs(\r\n            *,\r\n            subscription_platforms(\r\n              id,\r\n              name,\r\n              icon\r\n            )\r\n          )\r\n        `).eq(\"user_id\", userId).order(\"created_at\", {\n                ascending: false\n            }), \"getUserPurchases\") || [];\n    }\n};\n// Eksport podstawowego klienta Supabase\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (supabase);\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL2RhdGFiYXNlL3N1cGFiYXNlLWNsaWVudC5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSxzQ0FBc0M7QUFDZTtBQUNEO0FBRXBELGlDQUFpQztBQUNqQyxNQUFNRSxjQUFjQywwQ0FBb0M7QUFDeEQsTUFBTUcsa0JBQWtCSCxrTkFBeUM7QUFFakUscURBQXFEO0FBQ3JELElBQUksQ0FBQ0QsZUFBZSxDQUFDSSxpQkFBaUI7SUFDcENFLFFBQVFDLEtBQUssQ0FDWDtBQUVKO0FBRUEseUVBQXlFO0FBQ3pFLE1BQU1DLFdBQVdWLG1FQUFZQSxDQUFDRSxhQUFhSTtBQUUzQzs7Ozs7OztDQU9DLEdBQ00sTUFBTUssc0JBQXNCLENBQUNGLE9BQU9HLFlBQVksb0JBQW9CLEVBQUVDLGFBQWEsS0FBSztJQUM3Rix3Q0FBd0M7SUFDeEMsTUFBTUMsZ0JBQWdCO1FBQ3BCTCxPQUFPO1FBQ1BNLFNBQVNOLE1BQU1NLE9BQU8sSUFBSSxDQUFDLHNCQUFzQixFQUFFSCxVQUFVLENBQUM7UUFDOURJLE1BQU1QLE1BQU1PLElBQUksSUFBSTtRQUNwQkMsU0FBU1IsTUFBTVEsT0FBTyxJQUFJO1FBQzFCTDtRQUNBTSxNQUFNLEVBQUUsQ0FBQyxzREFBc0Q7SUFDakU7SUFFQSwrQkFBK0I7SUFDL0JWLFFBQVFDLEtBQUssQ0FBQyxDQUFDLHNCQUFzQixFQUFFRyxVQUFVLENBQUMsQ0FBQyxFQUFFO1FBQ25ERyxTQUFTTixNQUFNTSxPQUFPO1FBQ3RCQyxNQUFNUCxNQUFNTyxJQUFJO1FBQ2hCQyxTQUFTUixNQUFNUSxPQUFPO1FBQ3RCRSxPQUFPVixNQUFNVSxLQUFLO0lBQ3BCO0lBRUEsSUFBSU4sWUFBWTtRQUNkLG9EQUFvRDtRQUNwRCxNQUFNTyxnQkFBZ0IsSUFBSUMsTUFBTVAsY0FBY0MsT0FBTztRQUNyREssY0FBY0osSUFBSSxHQUFHRixjQUFjRSxJQUFJO1FBQ3ZDSSxjQUFjSCxPQUFPLEdBQUdILGNBQWNHLE9BQU87UUFDN0NHLGNB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QUVGLHdDQUF3QztBQUN4QyxpRUFBZWxELFFBQVFBLEVBQUMiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9ncm91cHNoYXJlLXByb2plY3QvLi9zcmMvbGliL2RhdGFiYXNlL3N1cGFiYXNlLWNsaWVudC5qcz9jNTc2Il0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9saWIvZGF0YWJhc2Uvc3VwYWJhc2UtY2xpZW50LmpzXHJcbmltcG9ydCB7IGNyZWF0ZUNsaWVudCB9IGZyb20gJ0BzdXBhYmFzZS9zdXBhYmFzZS1qcyc7XHJcbmltcG9ydCBzdXBhYmFzZUFkbWluIGZyb20gJy4vc3VwYWJhc2UtYWRtaW4tY2xpZW50JztcclxuXHJcbi8vIEluaWNqYWxpemFjamEga2xpZW50YSBTdXBhYmFzZVxyXG5jb25zdCBzdXBhYmFzZVVybCA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTDtcclxuY29uc3Qgc3VwYWJhc2VBbm9uS2V5ID0gcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfU1VQQUJBU0VfQU5PTl9LRVk7XHJcblxyXG4vLyBTcHJhd2R6ZW5pZSwgY3p5IHptaWVubmUgxZtyb2Rvd2lza293ZSBzxIUgdXN0YXdpb25lXHJcbmlmICghc3VwYWJhc2VVcmwgfHwgIXN1cGFiYXNlQW5vbktleSkge1xyXG4gIGNvbnNvbGUuZXJyb3IoXHJcbiAgICAnQnJhayB3eW1hZ2FueWNoIHptaWVubnljaCDFm3JvZG93aXNrb3d5Y2g6IE5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCBsdWIgTkVYVF9QVUJMSUNfU1VQQUJBU0VfQU5PTl9LRVknXHJcbiAgKTtcclxufVxyXG5cclxuLy8gU3RhxYJhIGluc3RhbmNqYSBrbGllbnRhIFN1cGFiYXNlIGRvIHBvbm93bmVnbyB1xbx5Y2lhIHcgY2HFgmVqIGFwbGlrYWNqaVxyXG5jb25zdCBzdXBhYmFzZSA9IGNyZWF0ZUNsaWVudChzdXBhYmFzZVVybCwgc3VwYWJhc2VBbm9uS2V5KTtcclxuXHJcbi8qKlxyXG4gKiBTdGFuZGFyZG93YSBvYnPFgnVnYSBixYLEmWTDs3cgU3VwYWJhc2UgXHJcbiAqIEBwYXJhbSB7RXJyb3J9IGVycm9yIC0gQsWCxIVkIHp3csOzY29ueSBwcnpleiBTdXBhYmFzZVxyXG4gKiBAcGFyYW0ge3N0cmluZ30gb3BlcmF0aW9uIC0gTmF6d2Egb3BlcmFjamksIGt0w7NyYSBzcG93b2Rvd2HFgmEgYsWCxIVkXHJcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gdGhyb3dFcnJvciAtIEN6eSB3eXJ6dWNpxIcgYsWCxIVkICh0cnVlKSBjenkgendyw7NjacSHIG9iaWVrdCBixYLEmWR1IChmYWxzZSlcclxuICogQHJldHVybnMge09iamVjdH0gLSBTdGFuZGFyZG93eSBvYmlla3QgYsWCxJlkdSAoamXFm2xpIHRocm93RXJyb3IgPSBmYWxzZSlcclxuICogQHRocm93cyB7RXJyb3J9IC0gUnp1Y2EgYsWCxIVkIChqZcWbbGkgdGhyb3dFcnJvciA9IHRydWUpXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgaGFuZGxlRGF0YWJhc2VFcnJvciA9IChlcnJvciwgb3BlcmF0aW9uID0gJ2RhdGFiYXNlIG9wZXJhdGlvbicsIHRocm93RXJyb3IgPSBmYWxzZSkgPT4ge1xyXG4gIC8vIFR3b3J6ZW5pZSBzdGFuZGFyZG93ZWdvIG9iaWVrdHUgYsWCxJlkdVxyXG4gIGNvbnN0IHN0YW5kYXJkRXJyb3IgPSB7XHJcbiAgICBlcnJvcjogdHJ1ZSxcclxuICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgYFd5c3TEhXBpxYIgYsWCxIVkIHBvZGN6YXMgJHtvcGVyYXRpb259YCxcclxuICAgIGNvZGU6IGVycm9yLmNvZGUgfHwgJ3Vua25vd25fZXJyb3InLFxyXG4gICAgZGV0YWlsczogZXJyb3IuZGV0YWlscyB8fCBudWxsLFxyXG4gICAgb3BlcmF0aW9uLFxyXG4gICAgZGF0YTogW10gLy8gRG9kYW5vIHB1c3TEhSB0YWJsaWPEmSBkbGEga29tcGF0eWJpbG5vxZtjaSB6IGtsaWVudGVtXHJcbiAgfTtcclxuXHJcbiAgLy8gWmFwaXN6IHN6Y3plZ8OzxYJvd3kgbG9nIGLFgsSZZHVcclxuICBjb25zb2xlLmVycm9yKGBEYXRhYmFzZSBlcnJvciBkdXJpbmcgJHtvcGVyYXRpb259OmAsIHtcclxuICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICBjb2RlOiBlcnJvci5jb2RlLFxyXG4gICAgZGV0YWlsczogZXJyb3IuZGV0YWlscyxcclxuICAgIHN0YWNrOiBlcnJvci5zdGFja1xyXG4gIH0pO1xyXG5cclxuICBpZiAodGhyb3dFcnJvcikge1xyXG4gICAgLy8gU3R3w7NyeiBub3d5IG9iaWVrdCBixYLEmWR1IHogZG9kYXRrb3d5bWkgbWV0YWRhbnltaVxyXG4gICAgY29uc3QgZW5oYW5jZWRFcnJvciA9IG5ldyBFcnJvcihzdGFuZGFyZEVycm9yLm1lc3NhZ2UpO1xyXG4gICAgZW5oYW5jZWRFcnJvci5jb2RlID0gc3RhbmRhcmRFcnJvci5jb2RlO1xyXG4gICAgZW5oYW5jZWRFcnJvci5kZXRhaWxzID0gc3RhbmRhcmRFcnJvci5kZXRhaWxzO1xyXG4gICAgZW5oYW5jZWRFcnJvci5vcGVyYXRpb24gPSBvcGVyYXRpb247XHJcbiAgICBlbmhhbmNlZEVycm9yLmRhdGEgPSBbXTsgLy8gRG9kYW5vIHB1c3TEhSB0YWJsaWPEmSBkbGEga29tcGF0eWJpbG5vxZtjaVxyXG4gICAgdGhyb3cgZW5oYW5jZWRFcnJvcjtcclxuICB9XHJcblxyXG4gIHJldHVybiBzdGFuZGFyZEVycm9yO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIEJlenBpZWN6bmUgd3lrb25hbmllIG9wZXJhY2ppIFN1cGFiYXNlIHogb2JzxYJ1Z8SFIGLFgsSZZMOzdyBpIGZhbGxiYWNraWVtIGRvIGtsaWVudGEgYWRtaW5pc3RyYXRvcmFcclxuICogQHBhcmFtIHtGdW5jdGlvbn0gb3BlcmF0aW9uIC0gRnVua2NqYSBvcGVyYWNqaSBTdXBhYmFzZSBkbyB3eWtvbmFuaWFcclxuICogQHBhcmFtIHtzdHJpbmd9IG9wZXJhdGlvbk5hbWUgLSBOYXp3YSBvcGVyYWNqaSAoZGxhIGxvZ8OzdylcclxuICogQHBhcmFtIHtib29sZWFufSB1c2VBZG1pbk9uRmFpbHVyZSAtIEN6eSBwcsOzYm93YcSHIHoga2xpZW50ZW0gYWRtaW4gdyBwcnp5cGFka3UgYsWCxJlkdSB1cHJhd25pZcWEXHJcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gdGhyb3dPbkVycm9yIC0gQ3p5IHd5cnp1Y2HEhyBixYLEmWR5IHphbWlhc3QgendyYWNhxIcgbnVsbC9bXSBcclxuICogQHJldHVybnMge1Byb21pc2U8YW55Pn0gLSBXeW5payBvcGVyYWNqaSBsdWIgbnVsbC9bXSB3IHByenlwYWRrdSBixYLEmWR1XHJcbiAqL1xyXG5leHBvcnQgY29uc3Qgc2FmZVF1ZXJ5RXhlY3V0aW9uID0gYXN5bmMgKFxyXG4gIG9wZXJhdGlvbixcclxuICBvcGVyYXRpb25OYW1lID0gJ2RhdGFiYXNlIG9wZXJhdGlvbicsXHJcbiAgdXNlQWRtaW5PbkZhaWx1cmUgPSB0cnVlLFxyXG4gIHRocm93T25FcnJvciA9IGZhbHNlXHJcbikgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICAvLyBQcsOzYmEgd3lrb25hbmlhIG9wZXJhY2ppIHplIHN0YW5kYXJkb3d5bSBrbGllbnRlbVxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgb3BlcmF0aW9uKHN1cGFiYXNlKTtcclxuICAgIFxyXG4gICAgLy8gSmXFm2xpIHd5bmlrIHphd2llcmEgYsWCxIVkXHJcbiAgICBpZiAocmVzdWx0LmVycm9yKSB7XHJcbiAgICAgIC8vIEplxZtsaSB0byBixYLEhWQgdXByYXduaWXFhCBpIG1hbXkgZmFsbGJhY2sgZG8gYWRtaW5hXHJcbiAgICAgIGlmIChyZXN1bHQuZXJyb3IuY29kZSA9PT0gJzQyNTAxJyAmJiB1c2VBZG1pbk9uRmFpbHVyZSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBQZXJtaXNzaW9uIGRlbmllZCBkdXJpbmcgJHtvcGVyYXRpb25OYW1lfSwgdHJ5aW5nIGFkbWluIGNsaWVudGApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIFByw7NiYSB3eWtvbmFuaWEgdGVqIHNhbWVqIG9wZXJhY2ppIHoga2xpZW50ZW0gYWRtaW5pc3RyYXRvcmFcclxuICAgICAgICBjb25zdCBhZG1pblJlc3VsdCA9IGF3YWl0IG9wZXJhdGlvbihzdXBhYmFzZUFkbWluKTtcclxuICAgICAgICBcclxuICAgICAgICBpZiAoYWRtaW5SZXN1bHQuZXJyb3IpIHtcclxuICAgICAgICAgIHJldHVybiBoYW5kbGVEYXRhYmFzZUVycm9yKGFkbWluUmVzdWx0LmVycm9yLCBvcGVyYXRpb25OYW1lLCB0aHJvd09uRXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICAvLyBVcGV3bmlqIHNpxJksIMW8ZSB6d3JhY2FteSBkYW5lIHcgb2N6ZWtpd2FueW0gZm9ybWFjaWVcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhZG1pblJlc3VsdC5kYXRhKSkge1xyXG4gICAgICAgICAgcmV0dXJuIGFkbWluUmVzdWx0LmRhdGE7XHJcbiAgICAgICAgfSBlbHNlIGlmIChhZG1pblJlc3VsdC5kYXRhID09PSBudWxsIHx8IGFkbWluUmVzdWx0LmRhdGEgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgcmV0dXJuIFtdOyAvLyBad3JhY2FteSBwdXN0xIUgdGFibGljxJkgamXFm2xpIG5pZSBtYSBkYW55Y2hcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIGFkbWluUmVzdWx0LmRhdGE7IC8vIFp3cmFjYW15IHBvamVkeW5jenkgb2JpZWt0XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICByZXR1cm4gaGFuZGxlRGF0YWJhc2VFcnJvcihyZXN1bHQuZXJyb3IsIG9wZXJhdGlvbk5hbWUsIHRocm93T25FcnJvcik7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIFVwZXduaWogc2nEmSwgxbxlIHp3cmFjYW15IGRhbmUgdyBvY3pla2l3YW55bSBmb3JtYWNpZVxyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0LmRhdGEpKSB7XHJcbiAgICAgIHJldHVybiByZXN1bHQuZGF0YTtcclxuICAgIH0gZWxzZSBpZiAocmVzdWx0LmRhdGEgPT09IG51bGwgfHwgcmVzdWx0LmRhdGEgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gW107IC8vIFp3cmFjYW15IHB1c3TEhSB0YWJsaWPEmSBqZcWbbGkgbmllIG1hIGRhbnljaFxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdC5kYXRhOyAvLyBad3JhY2FteSBwb2plZHluY3p5IG9iaWVrdFxyXG4gICAgfVxyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICByZXR1cm4gaGFuZGxlRGF0YWJhc2VFcnJvcihlcnJvciwgb3BlcmF0aW9uTmFtZSwgdGhyb3dPbkVycm9yKTtcclxuICB9XHJcbn07XHJcblxyXG4vLyBSZXBvenl0b3JpYSBkb3N0xJlwdSBkbyBkYW55Y2ggLSB3eXNva2kgcG96aW9tIGFic3RyYWtjamlcclxuXHJcbi8qKlxyXG4gKiBSZXBvenl0b3JpdW0gdcW8eXRrb3duaWvDs3dcclxuICovXHJcbmV4cG9ydCBjb25zdCB1c2VyUmVwb3NpdG9yeSA9IHtcclxuICAvKipcclxuICAgKiBQb2JpZXJhIHByb2ZpbCB1xbx5dGtvd25pa2EgbmEgcG9kc3Rhd2llIHpld27EmXRyem5lZ28gSUQgdXdpZXJ6eXRlbG5pYW5pYVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhdXRoSWQgLSBJRCB1d2llcnp5dGVsbmlhbmlhIChucC4geiBDbGVyaylcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3R8bnVsbD59IC0gUHJvZmlsIHXFvHl0a293bmlrYSBsdWIgbnVsbFxyXG4gICAqL1xyXG4gIGFzeW5jIGdldEJ5QXV0aElkKGF1dGhJZCkge1xyXG4gICAgaWYgKCFhdXRoSWQpIHJldHVybiBudWxsO1xyXG4gICAgXHJcbiAgICByZXR1cm4gc2FmZVF1ZXJ5RXhlY3V0aW9uKFxyXG4gICAgICAoY2xpZW50KSA9PiBjbGllbnRcclxuICAgICAgICAuZnJvbSgndXNlcl9wcm9maWxlcycpXHJcbiAgICAgICAgLnNlbGVjdCgnKicpXHJcbiAgICAgICAgLmVxKCdleHRlcm5hbF9hdXRoX2lkJywgYXV0aElkKVxyXG4gICAgICAgIC5zaW5nbGUoKSxcclxuICAgICAgJ2dldEJ5QXV0aElkJ1xyXG4gICAgKTtcclxuICB9LFxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIFR3b3J6eSBub3d5IHByb2ZpbCB1xbx5dGtvd25pa2FcclxuICAgKiBAcGFyYW0ge09iamVjdH0gdXNlclByb2ZpbGUgLSBEYW5lIHByb2ZpbHUgdcW8eXRrb3duaWthXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0fG51bGw+fSAtIFV0d29yem9ueSBwcm9maWwgdcW8eXRrb3duaWthIGx1YiBudWxsXHJcbiAgICovXHJcbiAgYXN5bmMgY3JlYXRlKHVzZXJQcm9maWxlKSB7XHJcbiAgICByZXR1cm4gc2FmZVF1ZXJ5RXhlY3V0aW9uKFxyXG4gICAgICAoY2xpZW50KSA9PiBjbGllbnRcclxuICAgICAgICAuZnJvbSgndXNlcl9wcm9maWxlcycpXHJcbiAgICAgICAgLmluc2VydChbdXNlclByb2ZpbGVdKVxyXG4gICAgICAgIC5zZWxlY3QoKVxyXG4gICAgICAgIC5zaW5nbGUoKSxcclxuICAgICAgJ2NyZWF0ZVVzZXJQcm9maWxlJyxcclxuICAgICAgdHJ1ZSAvLyB6YXdzemUgdcW8eXdhaiBrbGllbnRhIGFkbWluYSBwcnp5IHR3b3J6ZW5pdSB1xbx5dGtvd25pa2FcclxuICAgICk7XHJcbiAgfSxcclxuICBcclxuICAvKipcclxuICAgKiBBa3R1YWxpenVqZSBpc3RuaWVqxIVjeSBwcm9maWwgdcW8eXRrb3duaWthXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIElEIHByb2ZpbHUgdcW8eXRrb3duaWthXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IHVwZGF0ZXMgLSBEYW5lIGRvIGFrdHVhbGl6YWNqaVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdHxudWxsPn0gLSBaYWt0dWFsaXpvd2FueSBwcm9maWwgdcW8eXRrb3duaWthIGx1YiBudWxsXHJcbiAgICovXHJcbiAgYXN5bmMgdXBkYXRlKHVzZXJJZCwgdXBkYXRlcykge1xyXG4gICAgcmV0dXJuIHNhZmVRdWVyeUV4ZWN1dGlvbihcclxuICAgICAgKGNsaWVudCkgPT4gY2xpZW50XHJcbiAgICAgICAgLmZyb20oJ3VzZXJfcHJvZmlsZXMnKVxyXG4gICAgICAgIC51cGRhdGUodXBkYXRlcylcclxuICAgICAgICAuZXEoJ2lkJywgdXNlcklkKVxyXG4gICAgICAgIC5zZWxlY3QoKVxyXG4gICAgICAgIC5zaW5nbGUoKSxcclxuICAgICAgJ3VwZGF0ZVVzZXJQcm9maWxlJ1xyXG4gICAgKTtcclxuICB9LFxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIFBvYmllcmEgcHJvZmlsIHXFvHl0a293bmlrYSBwbyBJRFxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VySWQgLSBJRCBwcm9maWx1IHXFvHl0a293bmlrYVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdHxudWxsPn0gLSBQcm9maWwgdcW8eXRrb3duaWthIGx1YiBudWxsXHJcbiAgICovXHJcbiAgYXN5bmMgZ2V0QnlJZCh1c2VySWQpIHtcclxuICAgIHJldHVybiBzYWZlUXVlcnlFeGVjdXRpb24oXHJcbiAgICAgIChjbGllbnQpID0+IGNsaWVudFxyXG4gICAgICAgIC5mcm9tKCd1c2VyX3Byb2ZpbGVzJylcclxuICAgICAgICAuc2VsZWN0KCcqJylcclxuICAgICAgICAuZXEoJ2lkJywgdXNlcklkKVxyXG4gICAgICAgIC5zaW5nbGUoKSxcclxuICAgICAgJ2dldFVzZXJCeUlkJ1xyXG4gICAgKTtcclxuICB9XHJcbn07XHJcblxyXG4vKipcclxuICogUmVwb3p5dG9yaXVtIG9mZXJ0IHN1YnNrcnlwY2ppXHJcbiAqL1xyXG5leHBvcnQgY29uc3Qgb2ZmZXJzUmVwb3NpdG9yeSA9IHtcclxuICAvKipcclxuICAgKiBQb2JpZXJhIG9mZXJ0eSBzdWJza3J5cGNqaSB6IGZpbHRyb3dhbmllbVxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBmaWx0ZXJzIC0gRmlsdHJ5IGRvIHphc3Rvc293YW5pYVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPEFycmF5Pn0gLSBMaXN0YSBvZmVydFxyXG4gICAqL1xyXG4gIGFzeW5jIGdldEFsbChmaWx0ZXJzID0ge30pIHtcclxuICAgIC8vIFByenlnb3Rvd2FuaWUgYmF6b3dlZ28gemFweXRhbmlhXHJcbiAgICBjb25zdCBxdWVyeUJ1aWxkZXIgPSAoY2xpZW50KSA9PiB7XHJcbiAgICAgIGxldCBxdWVyeSA9IGNsaWVudFxyXG4gICAgICAgIC5mcm9tKCdncm91cF9zdWJzJylcclxuICAgICAgICAuc2VsZWN0KGBcclxuICAgICAgICAgICosXHJcbiAgICAgICAgICBzdWJzY3JpcHRpb25fcGxhdGZvcm1zKCopLFxyXG4gICAgICAgICAgZ3JvdXBzKGlkLCBuYW1lKSxcclxuICAgICAgICAgIG93bmVyOmdyb3VwcyFpbm5lcihvd25lcl9pZCwgdXNlcl9wcm9maWxlcyFpbm5lcihpZCwgZGlzcGxheV9uYW1lLCBhdmF0YXJfdXJsLCByYXRpbmdfYXZnLCByYXRpbmdfY291bnQsIHZlcmlmaWNhdGlvbl9sZXZlbCkpXHJcbiAgICAgICAgYClcclxuICAgICAgICAuZXEoJ3N0YXR1cycsICdhY3RpdmUnKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFphc3Rvc293YW5pZSBmaWx0csOzd1xyXG4gICAgICBpZiAoZmlsdGVycy5wbGF0Zm9ybUlkKSB7XHJcbiAgICAgICAgcXVlcnkgPSBxdWVyeS5lcSgncGxhdGZvcm1faWQnLCBmaWx0ZXJzLnBsYXRmb3JtSWQpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICBpZiAoZmlsdGVycy5taW5QcmljZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgcXVlcnkgPSBxdWVyeS5ndGUoJ3ByaWNlX3Blcl9zbG90JywgZmlsdGVycy5taW5QcmljZSk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIGlmIChmaWx0ZXJzLm1heFByaWNlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBxdWVyeSA9IHF1ZXJ5Lmx0ZSgncHJpY2VfcGVyX3Nsb3QnLCBmaWx0ZXJzLm1heFByaWNlKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgaWYgKGZpbHRlcnMuYXZhaWxhYmxlU2xvdHMgPT09IHRydWUpIHtcclxuICAgICAgICBxdWVyeSA9IHF1ZXJ5Lmd0KCdzbG90c19hdmFpbGFibGUnLCAwKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgLy8gU29ydG93YW5pZVxyXG4gICAgICBjb25zdCBvcmRlckJ5ID0gZmlsdGVycy5vcmRlckJ5IHx8ICdjcmVhdGVkX2F0JztcclxuICAgICAgY29uc3QgYXNjZW5kaW5nID0gZmlsdGVycy5hc2NlbmRpbmcgPT09IHRydWU7XHJcbiAgICAgIHF1ZXJ5ID0gcXVlcnkub3JkZXIob3JkZXJCeSwgeyBhc2NlbmRpbmcgfSk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBQYWdpbmFjamFcclxuICAgICAgaWYgKGZpbHRlcnMubGltaXQpIHtcclxuICAgICAgICBxdWVyeSA9IHF1ZXJ5LmxpbWl0KGZpbHRlcnMubGltaXQpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICBpZiAoZmlsdGVycy5vZmZzZXQpIHtcclxuICAgICAgICBxdWVyeSA9IHF1ZXJ5LnJhbmdlKGZpbHRlcnMub2Zmc2V0LCBmaWx0ZXJzLm9mZnNldCArIChmaWx0ZXJzLmxpbWl0IHx8IDEwKSAtIDEpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICByZXR1cm4gcXVlcnk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICByZXR1cm4gc2FmZVF1ZXJ5RXhlY3V0aW9uKHF1ZXJ5QnVpbGRlciwgJ2dldEFsbE9mZmVycycpIHx8IFtdO1xyXG4gIH0sXHJcbiAgXHJcbiAgLyoqXHJcbiAgICogUG9iaWVyYSBvZmVydMSZIHN1YnNrcnlwY2ppIHBvIElEXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9mZmVySWQgLSBJRCBvZmVydHlcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3R8bnVsbD59IC0gT2ZlcnRhIHN1YnNrcnlwY2ppIGx1YiBudWxsXHJcbiAgICovXHJcbiAgYXN5bmMgZ2V0QnlJZChvZmZlcklkKSB7XHJcbiAgICByZXR1cm4gc2FmZVF1ZXJ5RXhlY3V0aW9uKFxyXG4gICAgICAoY2xpZW50KSA9PiBjbGllbnRcclxuICAgICAgICAuZnJvbSgnZ3JvdXBfc3VicycpXHJcbiAgICAgICAgLnNlbGVjdChgXHJcbiAgICAgICAgICAqLFxyXG4gICAgICAgICAgc3Vic2NyaXB0aW9uX3BsYXRmb3JtcygqKSxcclxuICAgICAgICAgIGdyb3VwcyhpZCwgbmFtZSwgZGVzY3JpcHRpb24pLFxyXG4gICAgICAgICAgb3duZXI6Z3JvdXBzIWlubmVyKG93bmVyX2lkLCB1c2VyX3Byb2ZpbGVzIWlubmVyKGlkLCBkaXNwbGF5X25hbWUsIGF2YXRhcl91cmwsIHJhdGluZ19hdmcsIHJhdGluZ19jb3VudCwgdmVyaWZpY2F0aW9uX2xldmVsLCBiaW8pKVxyXG4gICAgICAgIGApXHJcbiAgICAgICAgLmVxKCdpZCcsIG9mZmVySWQpXHJcbiAgICAgICAgLnNpbmdsZSgpLFxyXG4gICAgICAnZ2V0T2ZmZXJCeUlkJ1xyXG4gICAgKTtcclxuICB9LFxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIFR3b3J6eSBub3fEhSBvZmVydMSZIHN1YnNrcnlwY2ppXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IG9mZmVyRGF0YSAtIERhbmUgb2ZlcnR5XHJcbiAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0fG51bGw+fSAtIFV0d29yem9uYSBvZmVydGEgbHViIG51bGxcclxuICAgKi9cclxuICBhc3luYyBjcmVhdGUob2ZmZXJEYXRhKSB7XHJcbiAgICByZXR1cm4gc2FmZVF1ZXJ5RXhlY3V0aW9uKFxyXG4gICAgICAoY2xpZW50KSA9PiBjbGllbnRcclxuICAgICAgICAuZnJvbSgnZ3JvdXBfc3VicycpXHJcbiAgICAgICAgLmluc2VydChbb2ZmZXJEYXRhXSlcclxuICAgICAgICAuc2VsZWN0KClcclxuICAgICAgICAuc2luZ2xlKCksXHJcbiAgICAgICdjcmVhdGVPZmZlcidcclxuICAgICk7XHJcbiAgfSxcclxuICBcclxuICAvKipcclxuICAgKiBBa3R1YWxpenVqZSBvZmVydMSZIHN1YnNrcnlwY2ppXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9mZmVySWQgLSBJRCBvZmVydHlcclxuICAgKiBAcGFyYW0ge09iamVjdH0gdXBkYXRlcyAtIERhbmUgZG8gYWt0dWFsaXphY2ppXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0fG51bGw+fSAtIFpha3R1YWxpem93YW5hIG9mZXJ0YSBsdWIgbnVsbCBcclxuICAgKi9cclxuICBhc3luYyB1cGRhdGUob2ZmZXJJZCwgdXBkYXRlcykge1xyXG4gICAgcmV0dXJuIHNhZmVRdWVyeUV4ZWN1dGlvbihcclxuICAgICAgKGNsaWVudCkgPT4gY2xpZW50XHJcbiAgICAgICAgLmZyb20oJ2dyb3VwX3N1YnMnKVxyXG4gICAgICAgIC51cGRhdGUodXBkYXRlcylcclxuICAgICAgICAuZXEoJ2lkJywgb2ZmZXJJZClcclxuICAgICAgICAuc2VsZWN0KClcclxuICAgICAgICAuc2luZ2xlKCksXHJcbiAgICAgICd1cGRhdGVPZmZlcidcclxuICAgICk7XHJcbiAgfSxcclxuICBcclxuICAvKipcclxuICAgKiBVc3V3YSBvZmVydMSZIHN1YnNrcnlwY2ppXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9mZmVySWQgLSBJRCBvZmVydHlcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gLSBDenkgb3BlcmFjamEgc2nEmSBwb3dpb2TFgmFcclxuICAgKi9cclxuICBhc3luYyBkZWxldGUob2ZmZXJJZCkge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2FmZVF1ZXJ5RXhlY3V0aW9uKFxyXG4gICAgICAoY2xpZW50KSA9PiBjbGllbnRcclxuICAgICAgICAuZnJvbSgnZ3JvdXBfc3VicycpXHJcbiAgICAgICAgLmRlbGV0ZSgpXHJcbiAgICAgICAgLmVxKCdpZCcsIG9mZmVySWQpLFxyXG4gICAgICAnZGVsZXRlT2ZmZXInXHJcbiAgICApO1xyXG4gICAgXHJcbiAgICByZXR1cm4gcmVzdWx0ICE9PSBudWxsO1xyXG4gIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiBSZXBvenl0b3JpdW0gcGxhdGZvcm0gc3Vic2tyeXBjamlcclxuICovXHJcbmV4cG9ydCBjb25zdCBwbGF0Zm9ybXNSZXBvc2l0b3J5ID0ge1xyXG4gIC8qKlxyXG4gICAqIFBvYmllcmEgd3N6eXN0a2llIGFrdHl3bmUgcGxhdGZvcm15IHN1YnNrcnlwY2ppXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXk+fSAtIExpc3RhIHBsYXRmb3JtXHJcbiAgICovXHJcbiAgYXN5bmMgZ2V0QWxsKCkge1xyXG4gICAgcmV0dXJuIHNhZmVRdWVyeUV4ZWN1dGlvbihcclxuICAgICAgKGNsaWVudCkgPT4gY2xpZW50XHJcbiAgICAgICAgLmZyb20oJ3N1YnNjcmlwdGlvbl9wbGF0Zm9ybXMnKVxyXG4gICAgICAgIC5zZWxlY3QoJyonKVxyXG4gICAgICAgIC5lcSgnYWN0aXZlJywgdHJ1ZSlcclxuICAgICAgICAub3JkZXIoJ25hbWUnKSxcclxuICAgICAgJ2dldEFsbFBsYXRmb3JtcydcclxuICAgICkgfHwgW107XHJcbiAgfSxcclxuICBcclxuICAvKipcclxuICAgKiBQb2JpZXJhIHBsYXRmb3JtxJkgcG8gSURcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm1JZCAtIElEIHBsYXRmb3JteVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdHxudWxsPn0gLSBQbGF0Zm9ybWEgbHViIG51bGxcclxuICAgKi9cclxuICBhc3luYyBnZXRCeUlkKHBsYXRmb3JtSWQpIHtcclxuICAgIHJldHVybiBzYWZlUXVlcnlFeGVjdXRpb24oXHJcbiAgICAgIChjbGllbnQpID0+IGNsaWVudFxyXG4gICAgICAgIC5mcm9tKCdzdWJzY3JpcHRpb25fcGxhdGZvcm1zJylcclxuICAgICAgICAuc2VsZWN0KCcqJylcclxuICAgICAgICAuZXEoJ2lkJywgcGxhdGZvcm1JZClcclxuICAgICAgICAuc2luZ2xlKCksXHJcbiAgICAgICdnZXRQbGF0Zm9ybUJ5SWQnXHJcbiAgICApO1xyXG4gIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiBSZXBvenl0b3JpdW0gemFrdXDDs3dcclxuICovXHJcbmV4cG9ydCBjb25zdCBwdXJjaGFzZXNSZXBvc2l0b3J5ID0ge1xyXG4gIC8qKlxyXG4gICAqIFR3b3J6eSBub3d5IHpha3VwXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IHB1cmNoYXNlRGF0YSAtIERhbmUgemFrdXB1XHJcbiAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0fG51bGw+fSAtIFV0d29yem9ueSB6YWt1cCBsdWIgbnVsbFxyXG4gICAqL1xyXG4gIGFzeW5jIGNyZWF0ZShwdXJjaGFzZURhdGEpIHtcclxuICAgIHJldHVybiBzYWZlUXVlcnlFeGVjdXRpb24oXHJcbiAgICAgIChjbGllbnQpID0+IGNsaWVudFxyXG4gICAgICAgIC5mcm9tKCdwdXJjaGFzZV9yZWNvcmRzJylcclxuICAgICAgICAuaW5zZXJ0KFtwdXJjaGFzZURhdGFdKVxyXG4gICAgICAgIC5zZWxlY3QoKVxyXG4gICAgICAgIC5zaW5nbGUoKSxcclxuICAgICAgJ2NyZWF0ZVB1cmNoYXNlJyxcclxuICAgICAgdHJ1ZSAvLyB1xbx5d2FqIGtsaWVudGEgYWRtaW5cclxuICAgICk7XHJcbiAgfSxcclxuICBcclxuICAvKipcclxuICAgKiBQb2JpZXJhIHpha3VwIHBvIElEXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHB1cmNoYXNlSWQgLSBJRCB6YWt1cHVcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3R8bnVsbD59IC0gWmFrdXAgbHViIG51bGxcclxuICAgKi9cclxuICBhc3luYyBnZXRCeUlkKHB1cmNoYXNlSWQpIHtcclxuICAgIHJldHVybiBzYWZlUXVlcnlFeGVjdXRpb24oXHJcbiAgICAgIChjbGllbnQpID0+IGNsaWVudFxyXG4gICAgICAgIC5mcm9tKCdwdXJjaGFzZV9yZWNvcmRzJylcclxuICAgICAgICAuc2VsZWN0KGBcclxuICAgICAgICAgICosXHJcbiAgICAgICAgICBncm91cF9zdWI6Z3JvdXBfc3VicyhcclxuICAgICAgICAgICAgKixcclxuICAgICAgICAgICAgc3Vic2NyaXB0aW9uX3BsYXRmb3JtcyhcclxuICAgICAgICAgICAgICBpZCxcclxuICAgICAgICAgICAgICBuYW1lLFxyXG4gICAgICAgICAgICAgIGljb25cclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgKVxyXG4gICAgICAgIGApXHJcbiAgICAgICAgLmVxKCdpZCcsIHB1cmNoYXNlSWQpXHJcbiAgICAgICAgLnNpbmdsZSgpLFxyXG4gICAgICAnZ2V0UHVyY2hhc2VCeUlkJ1xyXG4gICAgKTtcclxuICB9LFxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIEFrdHVhbGl6dWplIHpha3VwXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHB1cmNoYXNlSWQgLSBJRCB6YWt1cHVcclxuICAgKiBAcGFyYW0ge09iamVjdH0gdXBkYXRlcyAtIERhbmUgZG8gYWt0dWFsaXphY2ppXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0fG51bGw+fSAtIFpha3R1YWxpem93YW55IHpha3VwIGx1YiBudWxsXHJcbiAgICovXHJcbiAgYXN5bmMgdXBkYXRlKHB1cmNoYXNlSWQsIHVwZGF0ZXMpIHtcclxuICAgIHJldHVybiBzYWZlUXVlcnlFeGVjdXRpb24oXHJcbiAgICAgIChjbGllbnQpID0+IGNsaWVudFxyXG4gICAgICAgIC5mcm9tKCdwdXJjaGFzZV9yZWNvcmRzJylcclxuICAgICAgICAudXBkYXRlKHVwZGF0ZXMpXHJcbiAgICAgICAgLmVxKCdpZCcsIHB1cmNoYXNlSWQpXHJcbiAgICAgICAgLnNlbGVjdCgpXHJcbiAgICAgICAgLnNpbmdsZSgpLFxyXG4gICAgICAndXBkYXRlUHVyY2hhc2UnXHJcbiAgICApO1xyXG4gIH0sXHJcbiAgXHJcbiAgLyoqXHJcbiAgICogUG9iaWVyYSB6YWt1cHkgdcW8eXRrb3duaWthXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIElEIHXFvHl0a293bmlrYVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPEFycmF5Pn0gLSBMaXN0YSB6YWt1cMOzd1xyXG4gICAqL1xyXG4gIGFzeW5jIGdldEJ5VXNlcklkKHVzZXJJZCkge1xyXG4gICAgcmV0dXJuIHNhZmVRdWVyeUV4ZWN1dGlvbihcclxuICAgICAgKGNsaWVudCkgPT4gY2xpZW50XHJcbiAgICAgICAgLmZyb20oJ3B1cmNoYXNlX3JlY29yZHMnKVxyXG4gICAgICAgIC5zZWxlY3QoYFxyXG4gICAgICAgICAgKixcclxuICAgICAgICAgIGdyb3VwX3N1Yjpncm91cF9zdWJzKFxyXG4gICAgICAgICAgICAqLFxyXG4gICAgICAgICAgICBzdWJzY3JpcHRpb25fcGxhdGZvcm1zKFxyXG4gICAgICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgICAgIG5hbWUsXHJcbiAgICAgICAgICAgICAgaWNvblxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICApXHJcbiAgICAgICAgYClcclxuICAgICAgICAuZXEoJ3VzZXJfaWQnLCB1c2VySWQpXHJcbiAgICAgICAgLm9yZGVyKCdjcmVhdGVkX2F0JywgeyBhc2NlbmRpbmc6IGZhbHNlIH0pLFxyXG4gICAgICAnZ2V0VXNlclB1cmNoYXNlcydcclxuICAgICkgfHwgW107XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gRWtzcG9ydCBwb2RzdGF3b3dlZ28ga2xpZW50YSBTdXBhYmFzZVxyXG5leHBvcnQgZGVmYXVsdCBzdXBhYmFzZTsiXSwibmFtZXMiOlsiY3JlYXRlQ2xpZW50Iiwic3VwYWJhc2VBZG1pbiIsInN1cGFiYXNlVXJsIiwicHJvY2VzcyIsImVudiIsIk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCIsInN1cGFiYXNlQW5vbktleSIsIk5FWFRfUFVCTElDX1NVUEFCQVNFX0FOT05fS0VZIiwiY29uc29sZSIsImVycm9yIiwic3VwYWJhc2UiLCJoYW5kbGVEYXRhYmFzZUVycm9yIiwib3BlcmF0aW9uIiwidGhyb3dFcnJvciIsInN0YW5kYXJkRXJyb3IiLCJtZXNzYWdlIiwiY29kZSIsImRldGFpbHMiLCJkYXRhIiwic3RhY2siLCJlbmhhbmNlZEVycm9yIiwiRXJyb3IiLCJzYWZlUXVlcnlFeGVjdXRpb24iLCJvcGVyYXRpb25OYW1lIiwidXNlQWRtaW5PbkZhaWx1cmUiLCJ0aHJvd09uRXJyb3IiLCJyZXN1bHQiLCJsb2ciLCJhZG1pblJlc3VsdCIsIkFycmF5IiwiaXNBcnJheSIsInVuZGVmaW5lZCIsInVzZXJSZXBvc2l0b3J5IiwiZ2V0QnlBdXRoSWQiLCJhdXRoSWQiLCJjbGllbnQiLCJmcm9tIiwic2VsZWN0IiwiZXEiLCJzaW5nbGUiLCJjcmVhdGUiLCJ1c2VyUHJvZmlsZSIsImluc2VydCIsInVwZGF0ZSIsInVzZXJJZCIsInVwZGF0ZXMiLCJnZXRCeUlkIiwib2ZmZXJzUmVwb3NpdG9yeSIsImdldEFsbCIsImZpbHRlcnMiLCJxdWVyeUJ1aWxkZXIiLCJxdWVyeSIsInBsYXRmb3JtSWQiLCJtaW5QcmljZSIsImd0ZSIsIm1heFByaWNlIiwibHRlIiwiYXZhaWxhYmxlU2xvdHMiLCJndCIsIm9yZGVyQnkiLCJhc2NlbmRpbmciLCJvcmRlciIsImxpbWl0Iiwib2Zmc2V0IiwicmFuZ2UiLCJvZmZlcklkIiwib2ZmZXJEYXRhIiwiZGVsZXRlIiwicGxhdGZvcm1zUmVwb3NpdG9yeSIsInB1cmNoYXNlc1JlcG9zaXRvcnkiLCJwdXJjaGFzZURhdGEiLCJwdXJjaGFzZUlkIiwiZ2V0QnlVc2VySWQiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/database/supabase-client.js\n");

/***/ }),

/***/ "(rsc)/./src/lib/security/encryption/encryption-service.js":
/*!***********************************************************!*\
  !*** ./src/lib/security/encryption/encryption-service.js ***!
  \***********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   EncryptionService: () => (/* binding */ EncryptionService),\n/* harmony export */   generateMasterKey: () => (/* binding */ generateMasterKey),\n/* harmony export */   simpleDecrypt: () => (/* binding */ simpleDecrypt),\n/* harmony export */   simpleEncrypt: () => (/* binding */ simpleEncrypt)\n/* harmony export */ });\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! crypto */ \"crypto\");\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_0__);\n\n/**\r\n * Serwis szyfrowania do bezpiecznego zarządzania danymi dostępowymi\r\n * Implementacja wykorzystująca AES-256-GCM dla lepszego bezpieczeństwa\r\n */ class EncryptionService {\n    /**\r\n   * Inicjalizuje serwis szyfrowania\r\n   * @param {string} masterKey - Główny klucz szyfrowania (32 bajty jako hex)\r\n   * @param {Object} options - Opcje konfiguracyjne\r\n   */ constructor(masterKey, options = {}){\n        if (!masterKey) {\n            throw new Error(\"Master key is required for encryption service\");\n        }\n        // Konwertuj klucz hex na bufor\n        this.masterKey = Buffer.from(masterKey, \"hex\");\n        // Sprawdź długość klucza (AES-256 wymaga 32 bajtów)\n        if (this.masterKey.length !== 32) {\n            throw new Error(\"Master key must be 32 bytes (64 hex characters) for AES-256\");\n        }\n        this.algorithm = options.algorithm || \"aes-256-gcm\";\n        this.version = \"2.0\"; // Wersja formatu szyfrowania\n    }\n    /**\r\n   * Szyfruje dane\r\n   * @param {string} data - Dane do zaszyfrowania\r\n   * @param {Buffer} aad - Dodatkowe dane uwierzytelniające (opcjonalne)\r\n   * @returns {Object} - Obiekt z zaszyfrowanymi danymi i metadanymi\r\n   */ encrypt(data, aad = null) {\n        if (!data) {\n            throw new Error(\"Data is required for encryption\");\n        }\n        try {\n            // Generuj losowy wektor inicjalizacyjny (IV)\n            const iv = crypto__WEBPACK_IMPORTED_MODULE_0___default().randomBytes(16);\n            // Utwórz szyfr AES-256-GCM\n            const cipher = crypto__WEBPACK_IMPORTED_MODULE_0___default().createCipheriv(this.algorithm, this.masterKey, iv);\n            // Dodaj AAD jeśli dostarczone (dodatkowe dane uwierzytelniające)\n            if (aad) {\n                cipher.setAAD(aad);\n            }\n            // Zaszyfruj dane\n            let encrypted = cipher.update(data, \"utf8\", \"base64\");\n            encrypted += cipher.final(\"base64\");\n            // Pobierz tag uwierzytelniania\n            const authTag = cipher.getAuthTag();\n            // Zwróć kompletny pakiet zaszyfrowanych danych\n            return {\n                encryptedData: encrypted,\n                iv: iv.toString(\"base64\"),\n                authTag: authTag.toString(\"base64\"),\n                algorithm: this.algorithm,\n                version: this.version,\n                hasAAD: !!aad\n            };\n        } catch (error) {\n            console.error(\"Encryption error:\", error);\n            throw new Error(\"Failed to encrypt data\");\n        }\n    }\n    /**\r\n   * Deszyfruje dane\r\n   * @param {Object} encryptedPackage - Pakiet zaszyfrowanych danych\r\n   * @param {Buffer} aad - Dodatkowe dane uwierzytelniające (opcjonalne)\r\n   * @returns {string} - Odszyfrowane dane\r\n   */ decrypt(encryptedPackage, aad = null) {\n        if (!encryptedPackage || !encryptedPackage.encryptedData) {\n            throw new Error(\"Encrypted data package is required for decryption\");\n        }\n        try {\n            // Obsługa różnych wersji formatu szyfrowania\n            if (encryptedPackage.version && encryptedPackage.version !== this.version) {\n                // Implementacja obsługi starszych formatów szyfrowania\n                return this.decryptLegacy(encryptedPackage);\n            }\n            // Utwórz deszyfrator\n            const decipher = crypto__WEBPACK_IMPORTED_MODULE_0___default().createDecipheriv(encryptedPackage.algorithm || this.algorithm, this.masterKey, Buffer.from(encryptedPackage.iv, \"base64\"));\n            // Ustaw tag uwierzytelniania\n            decipher.setAuthTag(Buffer.from(encryptedPackage.authTag, \"base64\"));\n            // Dodaj AAD jeśli było używane\n            if (encryptedPackage.hasAAD && aad) {\n                decipher.setAAD(aad);\n            }\n            // Deszyfruj dane\n            let decrypted = decipher.update(encryptedPackage.encryptedData, \"base64\", \"utf8\");\n            decrypted += decipher.final(\"utf8\");\n            return decrypted;\n        } catch (error) {\n            console.error(\"Decryption error:\", error);\n            // Bardziej opisowe komunikaty błędów\n            if (error.message.includes(\"Unsupported state or unable to authenticate data\")) {\n                throw new Error(\"Authentication failed: the data may have been tampered with\");\n            } else if (error.message.includes(\"bad decrypt\")) {\n                throw new Error(\"Decryption failed: invalid key or corrupted data\");\n            } else {\n                throw new Error(`Failed to decrypt data: ${error.message}`);\n            }\n        }\n    }\n    /**\r\n   * Deszyfruje dane w starszym formacie\r\n   * @param {Object} encryptedPackage - Pakiet zaszyfrowanych danych\r\n   * @returns {string} - Odszyfrowane dane\r\n   */ decryptLegacy(encryptedPackage) {\n        // Obsługa formatu v1.0 (bez AAD, starsza implementacja)\n        if (encryptedPackage.version === \"1.0\") {\n            try {\n                // Starsza implementacja mogła używać IV w innym formacie\n                const iv = Buffer.from(encryptedPackage.iv, \"base64\");\n                // Utwórz deszyfrator dla starego formatu\n                const decipher = crypto__WEBPACK_IMPORTED_MODULE_0___default().createDecipheriv(encryptedPackage.algorithm || \"aes-256-gcm\", this.masterKey, iv);\n                // Ustaw tag uwierzytelniania (mógł być zapisany w innym formacie)\n                decipher.setAuthTag(Buffer.from(encryptedPackage.authTag || encryptedPackage.tag, \"base64\"));\n                // Deszyfruj dane\n                let decrypted = decipher.update(encryptedPackage.encryptedData, \"base64\", \"utf8\");\n                decrypted += decipher.final(\"utf8\");\n                return decrypted;\n            } catch (error) {\n                console.error(\"Legacy decryption error:\", error);\n                throw new Error(\"Failed to decrypt legacy data format\");\n            }\n        }\n        // Nieznany format\n        throw new Error(`Unsupported encryption format version: ${encryptedPackage.version}`);\n    }\n    /**\r\n   * Szyfruje instrukcje dostępowe dla oferty\r\n   * @param {string} instructions - Instrukcje do zaszyfrowania\r\n   * @param {string} groupSubId - ID oferty (do AAD)\r\n   * @returns {Object} - Zaszyfrowany pakiet\r\n   */ encryptAccessInstructions(instructions, groupSubId) {\n        if (!instructions) {\n            throw new Error(\"Instructions content is required\");\n        }\n        if (!groupSubId) {\n            throw new Error(\"Group subscription ID is required for context\");\n        }\n        // Przygotuj AAD (dodatkowe dane uwierzytelniające) z ID oferty\n        // AAD nie jest szyfrowane, ale zapewnia integralność kontekstu\n        const aad = Buffer.from(groupSubId);\n        // Zaszyfruj instrukcje z AAD\n        const encryptedPackage = this.encrypt(instructions, aad);\n        // Dodaj metadane\n        return {\n            ...encryptedPackage,\n            groupSubId,\n            timestamp: new Date().toISOString()\n        };\n    }\n    /**\r\n   * Deszyfruje instrukcje dostępowe\r\n   * @param {Object} encryptedPackage - Zaszyfrowany pakiet\r\n   * @param {string} expectedGroupSubId - Oczekiwane ID oferty do weryfikacji\r\n   * @returns {string} - Odszyfrowane instrukcje\r\n   */ decryptAccessInstructions(encryptedPackage, expectedGroupSubId) {\n        if (!encryptedPackage) {\n            throw new Error(\"Encrypted package is required\");\n        }\n        if (!expectedGroupSubId) {\n            throw new Error(\"Expected group subscription ID is required for verification\");\n        }\n        // Sprawdź, czy pakiet zawiera prawidłowe ID oferty\n        if (encryptedPackage.groupSubId !== expectedGroupSubId) {\n            throw new Error(\"Security context mismatch: incorrect group subscription ID\");\n        }\n        // Przygotuj AAD dla weryfikacji\n        const aad = Buffer.from(expectedGroupSubId);\n        // Deszyfruj instrukcje z weryfikacją AAD\n        return this.decrypt(encryptedPackage, aad);\n    }\n    /**\r\n   * Format współczesny: szyfruje dane używając simple API\r\n   * Dla prostszych przypadków użycia\r\n   * @param {string} data - Dane do zaszyfrowania\r\n   * @returns {string} - Zaszyfrowane dane w formacie string (JSON)\r\n   */ encryptToString(data) {\n        const encryptedPackage = this.encrypt(data);\n        return JSON.stringify(encryptedPackage);\n    }\n    /**\r\n   * Deszyfruje dane z formatu string\r\n   * @param {string} encryptedString - Zaszyfrowane dane w formacie string (JSON)\r\n   * @returns {string} - Odszyfrowane dane\r\n   */ decryptFromString(encryptedString) {\n        const encryptedPackage = JSON.parse(encryptedString);\n        return this.decrypt(encryptedPackage);\n    }\n}\n// Funkcja pomocnicza do generowania bezpiecznego klucza głównego\nfunction generateMasterKey() {\n    return crypto__WEBPACK_IMPORTED_MODULE_0___default().randomBytes(32).toString(\"hex\");\n}\n// Fallback - uproszczone szyfrowanie dla kompatybilności wstecznej\n// Dla zachowania kompatybilności ze starszym kodem\nfunction simpleEncrypt(data, key) {\n    if (!key) {\n        throw new Error(\"Encryption key is required\");\n    }\n    // Derive 32-byte key from the provided key using PBKDF2\n    const derivedKey = crypto__WEBPACK_IMPORTED_MODULE_0___default().pbkdf2Sync(key, \"salt\", 1000, 32, \"sha256\");\n    const iv = crypto__WEBPACK_IMPORTED_MODULE_0___default().randomBytes(16);\n    const cipher = crypto__WEBPACK_IMPORTED_MODULE_0___default().createCipheriv(\"aes-256-gcm\", derivedKey, iv);\n    let encrypted = cipher.update(data, \"utf8\", \"base64\");\n    encrypted += cipher.final(\"base64\");\n    const authTag = cipher.getAuthTag();\n    return {\n        encryptedData: encrypted,\n        iv: iv.toString(\"base64\"),\n        authTag: authTag.toString(\"base64\")\n    };\n}\nfunction simpleDecrypt(encryptedPackage, key) {\n    if (!key) {\n        throw new Error(\"Decryption key is required\");\n    }\n    // Derive the same key using the same parameters\n    const derivedKey = crypto__WEBPACK_IMPORTED_MODULE_0___default().pbkdf2Sync(key, \"salt\", 1000, 32, \"sha256\");\n    const decipher = crypto__WEBPACK_IMPORTED_MODULE_0___default().createDecipheriv(\"aes-256-gcm\", derivedKey, Buffer.from(encryptedPackage.iv, \"base64\"));\n    decipher.setAuthTag(Buffer.from(encryptedPackage.authTag, \"base64\"));\n    let decrypted = decipher.update(encryptedPackage.encryptedData, \"base64\", \"utf8\");\n    decrypted += decipher.final(\"utf8\");\n    return decrypted;\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL3NlY3VyaXR5L2VuY3J5cHRpb24vZW5jcnlwdGlvbi1zZXJ2aWNlLmpzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUE0QjtBQUU1Qjs7O0NBR0MsR0FDTSxNQUFNQztJQUNYOzs7O0dBSUMsR0FDREMsWUFBWUMsU0FBUyxFQUFFQyxVQUFVLENBQUMsQ0FBQyxDQUFFO1FBQ25DLElBQUksQ0FBQ0QsV0FBVztZQUNkLE1BQU0sSUFBSUUsTUFBTTtRQUNsQjtRQUVBLCtCQUErQjtRQUMvQixJQUFJLENBQUNGLFNBQVMsR0FBR0csT0FBT0MsSUFBSSxDQUFDSixXQUFXO1FBRXhDLG9EQUFvRDtRQUNwRCxJQUFJLElBQUksQ0FBQ0EsU0FBUyxDQUFDSyxNQUFNLEtBQUssSUFBSTtZQUNoQyxNQUFNLElBQUlILE1BQU07UUFDbEI7UUFFQSxJQUFJLENBQUNJLFNBQVMsR0FBR0wsUUFBUUssU0FBUyxJQUFJO1FBQ3RDLElBQUksQ0FBQ0MsT0FBTyxHQUFHLE9BQU8sNkJBQTZCO0lBQ3JEO0lBRUE7Ozs7O0dBS0MsR0FDREMsUUFBUUMsSUFBSSxFQUFFQyxNQUFNLElBQUksRUFBRTtRQUN4QixJQUFJLENBQUNELE1BQU07WUFDVCxNQUFNLElBQUlQLE1BQU07UUFDbEI7UUFFQSxJQUFJO1lBQ0YsNkNBQTZDO1lBQzdDLE1BQU1TLEtBQUtkLHlEQUFrQixDQUFDO1lBRTlCLDJCQUEyQjtZQUMzQixNQUFNZ0IsU0FBU2hCLDREQUFxQixDQUFDLElBQUksQ0FBQ1MsU0FBUyxFQUFFLElBQUksQ0FBQ04sU0FBUyxFQUFFVztZQUVyRSxpRUFBaUU7WUFDakUsSUFBSUQsS0FBSztnQkFDUEcsT0FBT0UsTUFBTSxDQUFDTDtZQUNoQjtZQUVBLGlCQUFpQjtZQUNqQixJQUFJTSxZQUFZSCxPQUFPSSxNQUFNLENBQUNSLE1BQU0sUUFBUTtZQUM1Q08sYUFBYUgsT0FBT0ssS0FBSyxDQUFDO1lBRTFCLCtCQUErQjtZQUMvQixNQUFNQyxVQUFVTixPQUFPTyxV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LElBQUksQ0FBQ3VCLGlCQUFpQmhCLEVBQUUsRUFBRTtJQUduQ2tCLFNBQVNFLFVBQVUsQ0FBQzVCLE9BQU9DLElBQUksQ0FBQ3VCLGlCQUFpQlIsT0FBTyxFQUFFO0lBRTFELElBQUlhLFlBQVlILFNBQVNaLE1BQU0sQ0FBQ1UsaUJBQWlCTixhQUFhLEVBQUUsVUFBVTtJQUMxRVcsYUFBYUgsU0FBU1gsS0FBSyxDQUFDO0lBRTVCLE9BQU9jO0FBQ1QiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9ncm91cHNoYXJlLXByb2plY3QvLi9zcmMvbGliL3NlY3VyaXR5L2VuY3J5cHRpb24vZW5jcnlwdGlvbi1zZXJ2aWNlLmpzP2M2MGQiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xyXG5cclxuLyoqXHJcbiAqIFNlcndpcyBzenlmcm93YW5pYSBkbyBiZXpwaWVjem5lZ28gemFyesSFZHphbmlhIGRhbnltaSBkb3N0xJlwb3d5bWlcclxuICogSW1wbGVtZW50YWNqYSB3eWtvcnp5c3R1asSFY2EgQUVTLTI1Ni1HQ00gZGxhIGxlcHN6ZWdvIGJlenBpZWN6ZcWEc3R3YVxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEVuY3J5cHRpb25TZXJ2aWNlIHtcclxuICAvKipcclxuICAgKiBJbmljamFsaXp1amUgc2Vyd2lzIHN6eWZyb3dhbmlhXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG1hc3RlcktleSAtIEfFgsOzd255IGtsdWN6IHN6eWZyb3dhbmlhICgzMiBiYWp0eSBqYWtvIGhleClcclxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIE9wY2plIGtvbmZpZ3VyYWN5am5lXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IobWFzdGVyS2V5LCBvcHRpb25zID0ge30pIHtcclxuICAgIGlmICghbWFzdGVyS2V5KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWFzdGVyIGtleSBpcyByZXF1aXJlZCBmb3IgZW5jcnlwdGlvbiBzZXJ2aWNlJyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIEtvbndlcnR1aiBrbHVjeiBoZXggbmEgYnVmb3JcclxuICAgIHRoaXMubWFzdGVyS2V5ID0gQnVmZmVyLmZyb20obWFzdGVyS2V5LCAnaGV4Jyk7XHJcbiAgICBcclxuICAgIC8vIFNwcmF3ZMW6IGTFgnVnb8WbxIcga2x1Y3phIChBRVMtMjU2IHd5bWFnYSAzMiBiYWp0w7N3KVxyXG4gICAgaWYgKHRoaXMubWFzdGVyS2V5Lmxlbmd0aCAhPT0gMzIpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNYXN0ZXIga2V5IG11c3QgYmUgMzIgYnl0ZXMgKDY0IGhleCBjaGFyYWN0ZXJzKSBmb3IgQUVTLTI1NicpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICB0aGlzLmFsZ29yaXRobSA9IG9wdGlvbnMuYWxnb3JpdGhtIHx8ICdhZXMtMjU2LWdjbSc7XHJcbiAgICB0aGlzLnZlcnNpb24gPSAnMi4wJzsgLy8gV2Vyc2phIGZvcm1hdHUgc3p5ZnJvd2FuaWFcclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogU3p5ZnJ1amUgZGFuZVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhIC0gRGFuZSBkbyB6YXN6eWZyb3dhbmlhXHJcbiAgICogQHBhcmFtIHtCdWZmZXJ9IGFhZCAtIERvZGF0a293ZSBkYW5lIHV3aWVyenl0ZWxuaWFqxIVjZSAob3Bjam9uYWxuZSlcclxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIE9iaWVrdCB6IHphc3p5ZnJvd2FueW1pIGRhbnltaSBpIG1ldGFkYW55bWlcclxuICAgKi9cclxuICBlbmNyeXB0KGRhdGEsIGFhZCA9IG51bGwpIHtcclxuICAgIGlmICghZGF0YSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGEgaXMgcmVxdWlyZWQgZm9yIGVuY3J5cHRpb24nKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gR2VuZXJ1aiBsb3Nvd3kgd2VrdG9yIGluaWNqYWxpemFjeWpueSAoSVYpXHJcbiAgICAgIGNvbnN0IGl2ID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDE2KTtcclxuICAgICAgXHJcbiAgICAgIC8vIFV0d8Ozcnogc3p5ZnIgQUVTLTI1Ni1HQ01cclxuICAgICAgY29uc3QgY2lwaGVyID0gY3J5cHRvLmNyZWF0ZUNpcGhlcml2KHRoaXMuYWxnb3JpdGhtLCB0aGlzLm1hc3RlcktleSwgaXYpO1xyXG4gICAgICBcclxuICAgICAgLy8gRG9kYWogQUFEIGplxZtsaSBkb3N0YXJjem9uZSAoZG9kYXRrb3dlIGRhbmUgdXdpZXJ6eXRlbG5pYWrEhWNlKVxyXG4gICAgICBpZiAoYWFkKSB7XHJcbiAgICAgICAgY2lwaGVyLnNldEFBRChhYWQpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBaYXN6eWZydWogZGFuZVxyXG4gICAgICBsZXQgZW5jcnlwdGVkID0gY2lwaGVyLnVwZGF0ZShkYXRhLCAndXRmOCcsICdiYXNlNjQnKTtcclxuICAgICAgZW5jcnlwdGVkICs9IGNpcGhlci5maW5hbCgnYmFzZTY0Jyk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBQb2JpZXJ6IHRhZyB1d2llcnp5dGVsbmlhbmlhXHJcbiAgICAgIGNvbnN0IGF1dGhUYWcgPSBjaXBoZXIuZ2V0QXV0aFRhZygpO1xyXG4gICAgICBcclxuICAgICAgLy8gWndyw7PEhyBrb21wbGV0bnkgcGFraWV0IHphc3p5ZnJvd2FueWNoIGRhbnljaFxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGVuY3J5cHRlZERhdGE6IGVuY3J5cHRlZCxcclxuICAgICAgICBpdjogaXYudG9TdHJpbmcoJ2Jhc2U2NCcpLFxyXG4gICAgICAgIGF1dGhUYWc6IGF1dGhUYWcudG9TdHJpbmcoJ2Jhc2U2NCcpLFxyXG4gICAgICAgIGFsZ29yaXRobTogdGhpcy5hbGdvcml0aG0sXHJcbiAgICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uLFxyXG4gICAgICAgIGhhc0FBRDogISFhYWRcclxuICAgICAgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0VuY3J5cHRpb24gZXJyb3I6JywgZXJyb3IpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBlbmNyeXB0IGRhdGEnKTtcclxuICAgIH1cclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogRGVzenlmcnVqZSBkYW5lXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IGVuY3J5cHRlZFBhY2thZ2UgLSBQYWtpZXQgemFzenlmcm93YW55Y2ggZGFueWNoXHJcbiAgICogQHBhcmFtIHtCdWZmZXJ9IGFhZCAtIERvZGF0a293ZSBkYW5lIHV3aWVyenl0ZWxuaWFqxIVjZSAob3Bjam9uYWxuZSlcclxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIE9kc3p5ZnJvd2FuZSBkYW5lXHJcbiAgICovXHJcbiAgZGVjcnlwdChlbmNyeXB0ZWRQYWNrYWdlLCBhYWQgPSBudWxsKSB7XHJcbiAgICBpZiAoIWVuY3J5cHRlZFBhY2thZ2UgfHwgIWVuY3J5cHRlZFBhY2thZ2UuZW5jcnlwdGVkRGF0YSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY3J5cHRlZCBkYXRhIHBhY2thZ2UgaXMgcmVxdWlyZWQgZm9yIGRlY3J5cHRpb24nKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gT2JzxYJ1Z2EgcsOzxbxueWNoIHdlcnNqaSBmb3JtYXR1IHN6eWZyb3dhbmlhXHJcbiAgICAgIGlmIChlbmNyeXB0ZWRQYWNrYWdlLnZlcnNpb24gJiYgZW5jcnlwdGVkUGFja2FnZS52ZXJzaW9uICE9PSB0aGlzLnZlcnNpb24pIHtcclxuICAgICAgICAvLyBJbXBsZW1lbnRhY2phIG9ic8WCdWdpIHN0YXJzenljaCBmb3JtYXTDs3cgc3p5ZnJvd2FuaWFcclxuICAgICAgICByZXR1cm4gdGhpcy5kZWNyeXB0TGVnYWN5KGVuY3J5cHRlZFBhY2thZ2UpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBVdHfDs3J6IGRlc3p5ZnJhdG9yXHJcbiAgICAgIGNvbnN0IGRlY2lwaGVyID0gY3J5cHRvLmNyZWF0ZURlY2lwaGVyaXYoXHJcbiAgICAgICAgZW5jcnlwdGVkUGFja2FnZS5hbGdvcml0aG0gfHwgdGhpcy5hbGdvcml0aG0sXHJcbiAgICAgICAgdGhpcy5tYXN0ZXJLZXksXHJcbiAgICAgICAgQnVmZmVyLmZyb20oZW5jcnlwdGVkUGFja2FnZS5pdiwgJ2Jhc2U2NCcpXHJcbiAgICAgICk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBVc3RhdyB0YWcgdXdpZXJ6eXRlbG5pYW5pYVxyXG4gICAgICBkZWNpcGhlci5zZXRBdXRoVGFnKEJ1ZmZlci5mcm9tKGVuY3J5cHRlZFBhY2thZ2UuYXV0aFRhZywgJ2Jhc2U2NCcpKTtcclxuICAgICAgXHJcbiAgICAgIC8vIERvZGFqIEFBRCBqZcWbbGkgYnnFgm8gdcW8eXdhbmVcclxuICAgICAgaWYgKGVuY3J5cHRlZFBhY2thZ2UuaGFzQUFEICYmIGFhZCkge1xyXG4gICAgICAgIGRlY2lwaGVyLnNldEFBRChhYWQpO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBEZXN6eWZydWogZGFuZVxyXG4gICAgICBsZXQgZGVjcnlwdGVkID0gZGVjaXBoZXIudXBkYXRlKGVuY3J5cHRlZFBhY2thZ2UuZW5jcnlwdGVkRGF0YSwgJ2Jhc2U2NCcsICd1dGY4Jyk7XHJcbiAgICAgIGRlY3J5cHRlZCArPSBkZWNpcGhlci5maW5hbCgndXRmOCcpO1xyXG4gICAgICBcclxuICAgICAgcmV0dXJuIGRlY3J5cHRlZDtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0RlY3J5cHRpb24gZXJyb3I6JywgZXJyb3IpO1xyXG4gICAgICBcclxuICAgICAgLy8gQmFyZHppZWogb3Bpc293ZSBrb211bmlrYXR5IGLFgsSZZMOzd1xyXG4gICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnVW5zdXBwb3J0ZWQgc3RhdGUgb3IgdW5hYmxlIHRvIGF1dGhlbnRpY2F0ZSBkYXRhJykpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZDogdGhlIGRhdGEgbWF5IGhhdmUgYmVlbiB0YW1wZXJlZCB3aXRoJyk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnYmFkIGRlY3J5cHQnKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRGVjcnlwdGlvbiBmYWlsZWQ6IGludmFsaWQga2V5IG9yIGNvcnJ1cHRlZCBkYXRhJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZGVjcnlwdCBkYXRhOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogRGVzenlmcnVqZSBkYW5lIHcgc3RhcnN6eW0gZm9ybWFjaWVcclxuICAgKiBAcGFyYW0ge09iamVjdH0gZW5jcnlwdGVkUGFja2FnZSAtIFBha2lldCB6YXN6eWZyb3dhbnljaCBkYW55Y2hcclxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIE9kc3p5ZnJvd2FuZSBkYW5lXHJcbiAgICovXHJcbiAgZGVjcnlwdExlZ2FjeShlbmNyeXB0ZWRQYWNrYWdlKSB7XHJcbiAgICAvLyBPYnPFgnVnYSBmb3JtYXR1IHYxLjAgKGJleiBBQUQsIHN0YXJzemEgaW1wbGVtZW50YWNqYSlcclxuICAgIGlmIChlbmNyeXB0ZWRQYWNrYWdlLnZlcnNpb24gPT09ICcxLjAnKSB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgLy8gU3RhcnN6YSBpbXBsZW1lbnRhY2phIG1vZ8WCYSB1xbx5d2HEhyBJViB3IGlubnltIGZvcm1hY2llXHJcbiAgICAgICAgY29uc3QgaXYgPSBCdWZmZXIuZnJvbShlbmNyeXB0ZWRQYWNrYWdlLml2LCAnYmFzZTY0Jyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gVXR3w7NyeiBkZXN6eWZyYXRvciBkbGEgc3RhcmVnbyBmb3JtYXR1XHJcbiAgICAgICAgY29uc3QgZGVjaXBoZXIgPSBjcnlwdG8uY3JlYXRlRGVjaXBoZXJpdihcclxuICAgICAgICAgIGVuY3J5cHRlZFBhY2thZ2UuYWxnb3JpdGhtIHx8ICdhZXMtMjU2LWdjbScsXHJcbiAgICAgICAgICB0aGlzLm1hc3RlcktleSxcclxuICAgICAgICAgIGl2XHJcbiAgICAgICAgKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBVc3RhdyB0YWcgdXdpZXJ6eXRlbG5pYW5pYSAobcOzZ8WCIGJ5xIcgemFwaXNhbnkgdyBpbm55bSBmb3JtYWNpZSlcclxuICAgICAgICBkZWNpcGhlci5zZXRBdXRoVGFnKEJ1ZmZlci5mcm9tKGVuY3J5cHRlZFBhY2thZ2UuYXV0aFRhZyB8fCBlbmNyeXB0ZWRQYWNrYWdlLnRhZywgJ2Jhc2U2NCcpKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBEZXN6eWZydWogZGFuZVxyXG4gICAgICAgIGxldCBkZWNyeXB0ZWQgPSBkZWNpcGhlci51cGRhdGUoZW5jcnlwdGVkUGFja2FnZS5lbmNyeXB0ZWREYXRhLCAnYmFzZTY0JywgJ3V0ZjgnKTtcclxuICAgICAgICBkZWNyeXB0ZWQgKz0gZGVjaXBoZXIuZmluYWwoJ3V0ZjgnKTtcclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4gZGVjcnlwdGVkO1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0xlZ2FjeSBkZWNyeXB0aW9uIGVycm9yOicsIGVycm9yKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBkZWNyeXB0IGxlZ2FjeSBkYXRhIGZvcm1hdCcpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIE5pZXpuYW55IGZvcm1hdFxyXG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBlbmNyeXB0aW9uIGZvcm1hdCB2ZXJzaW9uOiAke2VuY3J5cHRlZFBhY2thZ2UudmVyc2lvbn1gKTtcclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogU3p5ZnJ1amUgaW5zdHJ1a2NqZSBkb3N0xJlwb3dlIGRsYSBvZmVydHlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gaW5zdHJ1Y3Rpb25zIC0gSW5zdHJ1a2NqZSBkbyB6YXN6eWZyb3dhbmlhXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IGdyb3VwU3ViSWQgLSBJRCBvZmVydHkgKGRvIEFBRClcclxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIFphc3p5ZnJvd2FueSBwYWtpZXRcclxuICAgKi9cclxuICBlbmNyeXB0QWNjZXNzSW5zdHJ1Y3Rpb25zKGluc3RydWN0aW9ucywgZ3JvdXBTdWJJZCkge1xyXG4gICAgaWYgKCFpbnN0cnVjdGlvbnMpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnN0cnVjdGlvbnMgY29udGVudCBpcyByZXF1aXJlZCcpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBpZiAoIWdyb3VwU3ViSWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdHcm91cCBzdWJzY3JpcHRpb24gSUQgaXMgcmVxdWlyZWQgZm9yIGNvbnRleHQnKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gUHJ6eWdvdHVqIEFBRCAoZG9kYXRrb3dlIGRhbmUgdXdpZXJ6eXRlbG5pYWrEhWNlKSB6IElEIG9mZXJ0eVxyXG4gICAgLy8gQUFEIG5pZSBqZXN0IHN6eWZyb3dhbmUsIGFsZSB6YXBld25pYSBpbnRlZ3JhbG5vxZvEhyBrb250ZWtzdHVcclxuICAgIGNvbnN0IGFhZCA9IEJ1ZmZlci5mcm9tKGdyb3VwU3ViSWQpO1xyXG4gICAgXHJcbiAgICAvLyBaYXN6eWZydWogaW5zdHJ1a2NqZSB6IEFBRFxyXG4gICAgY29uc3QgZW5jcnlwdGVkUGFja2FnZSA9IHRoaXMuZW5jcnlwdChpbnN0cnVjdGlvbnMsIGFhZCk7XHJcbiAgICBcclxuICAgIC8vIERvZGFqIG1ldGFkYW5lXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAuLi5lbmNyeXB0ZWRQYWNrYWdlLFxyXG4gICAgICBncm91cFN1YklkLFxyXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgfTtcclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogRGVzenlmcnVqZSBpbnN0cnVrY2plIGRvc3TEmXBvd2VcclxuICAgKiBAcGFyYW0ge09iamVjdH0gZW5jcnlwdGVkUGFja2FnZSAtIFphc3p5ZnJvd2FueSBwYWtpZXRcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwZWN0ZWRHcm91cFN1YklkIC0gT2N6ZWtpd2FuZSBJRCBvZmVydHkgZG8gd2VyeWZpa2FjamlcclxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIE9kc3p5ZnJvd2FuZSBpbnN0cnVrY2plXHJcbiAgICovXHJcbiAgZGVjcnlwdEFjY2Vzc0luc3RydWN0aW9ucyhlbmNyeXB0ZWRQYWNrYWdlLCBleHBlY3RlZEdyb3VwU3ViSWQpIHtcclxuICAgIGlmICghZW5jcnlwdGVkUGFja2FnZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VuY3J5cHRlZCBwYWNrYWdlIGlzIHJlcXVpcmVkJyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGlmICghZXhwZWN0ZWRHcm91cFN1YklkKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgZ3JvdXAgc3Vic2NyaXB0aW9uIElEIGlzIHJlcXVpcmVkIGZvciB2ZXJpZmljYXRpb24nKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gU3ByYXdkxbosIGN6eSBwYWtpZXQgemF3aWVyYSBwcmF3aWTFgm93ZSBJRCBvZmVydHlcclxuICAgIGlmIChlbmNyeXB0ZWRQYWNrYWdlLmdyb3VwU3ViSWQgIT09IGV4cGVjdGVkR3JvdXBTdWJJZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlY3VyaXR5IGNvbnRleHQgbWlzbWF0Y2g6IGluY29ycmVjdCBncm91cCBzdWJzY3JpcHRpb24gSUQnKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gUHJ6eWdvdHVqIEFBRCBkbGEgd2VyeWZpa2FjamlcclxuICAgIGNvbnN0IGFhZCA9IEJ1ZmZlci5mcm9tKGV4cGVjdGVkR3JvdXBTdWJJZCk7XHJcbiAgICBcclxuICAgIC8vIERlc3p5ZnJ1aiBpbnN0cnVrY2plIHogd2VyeWZpa2FjasSFIEFBRFxyXG4gICAgcmV0dXJuIHRoaXMuZGVjcnlwdChlbmNyeXB0ZWRQYWNrYWdlLCBhYWQpO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBGb3JtYXQgd3Nww7PFgmN6ZXNueTogc3p5ZnJ1amUgZGFuZSB1xbx5d2FqxIVjIHNpbXBsZSBBUElcclxuICAgKiBEbGEgcHJvc3RzenljaCBwcnp5cGFka8OzdyB1xbx5Y2lhXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEgLSBEYW5lIGRvIHphc3p5ZnJvd2FuaWFcclxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIFphc3p5ZnJvd2FuZSBkYW5lIHcgZm9ybWFjaWUgc3RyaW5nIChKU09OKVxyXG4gICAqL1xyXG4gIGVuY3J5cHRUb1N0cmluZyhkYXRhKSB7XHJcbiAgICBjb25zdCBlbmNyeXB0ZWRQYWNrYWdlID0gdGhpcy5lbmNyeXB0KGRhdGEpO1xyXG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGVuY3J5cHRlZFBhY2thZ2UpO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBEZXN6eWZydWplIGRhbmUgeiBmb3JtYXR1IHN0cmluZ1xyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBlbmNyeXB0ZWRTdHJpbmcgLSBaYXN6eWZyb3dhbmUgZGFuZSB3IGZvcm1hY2llIHN0cmluZyAoSlNPTilcclxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIE9kc3p5ZnJvd2FuZSBkYW5lXHJcbiAgICovXHJcbiAgZGVjcnlwdEZyb21TdHJpbmcoZW5jcnlwdGVkU3RyaW5nKSB7XHJcbiAgICBjb25zdCBlbmNyeXB0ZWRQYWNrYWdlID0gSlNPTi5wYXJzZShlbmNyeXB0ZWRTdHJpbmcpO1xyXG4gICAgcmV0dXJuIHRoaXMuZGVjcnlwdChlbmNyeXB0ZWRQYWNrYWdlKTtcclxuICB9XHJcbn1cclxuXHJcbi8vIEZ1bmtjamEgcG9tb2NuaWN6YSBkbyBnZW5lcm93YW5pYSBiZXpwaWVjem5lZ28ga2x1Y3phIGfFgsOzd25lZ29cclxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlTWFzdGVyS2V5KCkge1xyXG4gIHJldHVybiBjcnlwdG8ucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcclxufVxyXG5cclxuLy8gRmFsbGJhY2sgLSB1cHJvc3pjem9uZSBzenlmcm93YW5pZSBkbGEga29tcGF0eWJpbG5vxZtjaSB3c3RlY3puZWpcclxuLy8gRGxhIHphY2hvd2FuaWEga29tcGF0eWJpbG5vxZtjaSB6ZSBzdGFyc3p5bSBrb2RlbVxyXG5leHBvcnQgZnVuY3Rpb24gc2ltcGxlRW5jcnlwdChkYXRhLCBrZXkpIHtcclxuICBpZiAoIWtleSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdFbmNyeXB0aW9uIGtleSBpcyByZXF1aXJlZCcpO1xyXG4gIH1cclxuICBcclxuICAvLyBEZXJpdmUgMzItYnl0ZSBrZXkgZnJvbSB0aGUgcHJvdmlkZWQga2V5IHVzaW5nIFBCS0RGMlxyXG4gIGNvbnN0IGRlcml2ZWRLZXkgPSBjcnlwdG8ucGJrZGYyU3luYyhcclxuICAgIGtleSxcclxuICAgICdzYWx0JywgLy8gQSBzdGF0aWMgc2FsdCwgaW4gcHJvZHVjdGlvbiB1c2UgYSBtb3JlIHNlY3VyZSBzYWx0XHJcbiAgICAxMDAwLCAgIC8vIEl0ZXJhdGlvbnMsIGhpZ2hlciBpcyBtb3JlIHNlY3VyZSBidXQgc2xvd2VyXHJcbiAgICAzMiwgICAgIC8vIEtleSBsZW5ndGggaW4gYnl0ZXNcclxuICAgICdzaGEyNTYnXHJcbiAgKTtcclxuICBcclxuICBjb25zdCBpdiA9IGNyeXB0by5yYW5kb21CeXRlcygxNik7XHJcbiAgY29uc3QgY2lwaGVyID0gY3J5cHRvLmNyZWF0ZUNpcGhlcml2KCdhZXMtMjU2LWdjbScsIGRlcml2ZWRLZXksIGl2KTtcclxuICBcclxuICBsZXQgZW5jcnlwdGVkID0gY2lwaGVyLnVwZGF0ZShkYXRhLCAndXRmOCcsICdiYXNlNjQnKTtcclxuICBlbmNyeXB0ZWQgKz0gY2lwaGVyLmZpbmFsKCdiYXNlNjQnKTtcclxuICBcclxuICBjb25zdCBhdXRoVGFnID0gY2lwaGVyLmdldEF1dGhUYWcoKTtcclxuICBcclxuICByZXR1cm4ge1xyXG4gICAgZW5jcnlwdGVkRGF0YTogZW5jcnlwdGVkLFxyXG4gICAgaXY6IGl2LnRvU3RyaW5nKCdiYXNlNjQnKSxcclxuICAgIGF1dGhUYWc6IGF1dGhUYWcudG9TdHJpbmcoJ2Jhc2U2NCcpXHJcbiAgfTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNpbXBsZURlY3J5cHQoZW5jcnlwdGVkUGFja2FnZSwga2V5KSB7XHJcbiAgaWYgKCFrZXkpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignRGVjcnlwdGlvbiBrZXkgaXMgcmVxdWlyZWQnKTtcclxuICB9XHJcbiAgXHJcbiAgLy8gRGVyaXZlIHRoZSBzYW1lIGtleSB1c2luZyB0aGUgc2FtZSBwYXJhbWV0ZXJzXHJcbiAgY29uc3QgZGVyaXZlZEtleSA9IGNyeXB0by5wYmtkZjJTeW5jKFxyXG4gICAga2V5LFxyXG4gICAgJ3NhbHQnLFxyXG4gICAgMTAwMCxcclxuICAgIDMyLFxyXG4gICAgJ3NoYTI1NidcclxuICApO1xyXG4gIFxyXG4gIGNvbnN0IGRlY2lwaGVyID0gY3J5cHRvLmNyZWF0ZURlY2lwaGVyaXYoXHJcbiAgICAnYWVzLTI1Ni1nY20nLFxyXG4gICAgZGVyaXZlZEtleSxcclxuICAgIEJ1ZmZlci5mcm9tKGVuY3J5cHRlZFBhY2thZ2UuaXYsICdiYXNlNjQnKVxyXG4gICk7XHJcbiAgXHJcbiAgZGVjaXBoZXIuc2V0QXV0aFRhZyhCdWZmZXIuZnJvbShlbmNyeXB0ZWRQYWNrYWdlLmF1dGhUYWcsICdiYXNlNjQnKSk7XHJcbiAgXHJcbiAgbGV0IGRlY3J5cHRlZCA9IGRlY2lwaGVyLnVwZGF0ZShlbmNyeXB0ZWRQYWNrYWdlLmVuY3J5cHRlZERhdGEsICdiYXNlNjQnLCAndXRmOCcpO1xyXG4gIGRlY3J5cHRlZCArPSBkZWNpcGhlci5maW5hbCgndXRmOCcpO1xyXG4gIFxyXG4gIHJldHVybiBkZWNyeXB0ZWQ7XHJcbn0iXSwibmFtZXMiOlsiY3J5cHRvIiwiRW5jcnlwdGlvblNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsIm1hc3RlcktleSIsIm9wdGlvbnMiLCJFcnJvciIsIkJ1ZmZlciIsImZyb20iLCJsZW5ndGgiLCJhbGdvcml0aG0iLCJ2ZXJzaW9uIiwiZW5jcnlwdCIsImRhdGEiLCJhYWQiLCJpdiIsInJhbmRvbUJ5dGVzIiwiY2lwaGVyIiwiY3JlYXRlQ2lwaGVyaXYiLCJzZXRBQUQiLCJlbmNyeXB0ZWQiLCJ1cGRhdGUiLCJmaW5hbCIsImF1dGhUYWciLCJnZXRBdXRoVGFnIiwiZW5jcnlwdGVkRGF0YSIsInRvU3RyaW5nIiwiaGFzQUFEIiwiZXJyb3IiLCJjb25zb2xlIiwiZGVjcnlwdCIsImVuY3J5cHRlZFBhY2thZ2UiLCJkZWNyeXB0TGVnYWN5IiwiZGVjaXBoZXIiLCJjcmVhdGVEZWNpcGhlcml2Iiwic2V0QXV0aFRhZyIsImRlY3J5cHRlZCIsIm1lc3NhZ2UiLCJpbmNsdWRlcyIsInRhZyIsImVuY3J5cHRBY2Nlc3NJbnN0cnVjdGlvbnMiLCJpbnN0cnVjdGlvbnMiLCJncm91cFN1YklkIiwidGltZXN0YW1wIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwiZGVjcnlwdEFjY2Vzc0luc3RydWN0aW9ucyIsImV4cGVjdGVkR3JvdXBTdWJJZCIsImVuY3J5cHRUb1N0cmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJkZWNyeXB0RnJvbVN0cmluZyIsImVuY3J5cHRlZFN0cmluZyIsInBhcnNlIiwiZ2VuZXJhdGVNYXN0ZXJLZXkiLCJzaW1wbGVFbmNyeXB0Iiwia2V5IiwiZGVyaXZlZEtleSIsInBia2RmMlN5bmMiLCJzaW1wbGVEZWNyeXB0Il0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/security/encryption/encryption-service.js\n");

/***/ }),

/***/ "(rsc)/./src/lib/security/token-service.js":
/*!*******************************************!*\
  !*** ./src/lib/security/token-service.js ***!
  \*******************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   TokenService: () => (/* binding */ TokenService),\n/* harmony export */   generateToken: () => (/* binding */ generateToken),\n/* harmony export */   hashToken: () => (/* binding */ hashToken),\n/* harmony export */   tokenService: () => (/* binding */ tokenService)\n/* harmony export */ });\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! crypto */ \"crypto\");\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../database/supabase-admin-client */ \"(rsc)/./src/lib/database/supabase-admin-client.js\");\n// src/lib/security/token-service.js\n\n\n/**\r\n * Zunifikowany serwis zarządzania tokenami dostępowymi\r\n * Konsoliduje funkcje z token-utils.js i token-service.js\r\n */ class TokenService {\n    /**\r\n   * Inicjalizuje serwis tokenów z opcjonalnymi ustawieniami\r\n   * @param {Object} options - Opcje konfiguracyjne \r\n   */ constructor(options = {}){\n        this.tokenLength = options.tokenLength || 32; // długość tokenu w bajtach\n        this.defaultExpiry = options.defaultExpiry || 30; // domyślny czas wygaśnięcia w minutach\n        this.salt = process.env.TOKEN_SALT || \"default-salt-for-tokens\"; // sól do hashowania tokenów\n        // Limity generowania tokenów (zabezpieczenie przed nadużyciami)\n        this.rateLimit = options.rateLimit || {\n            maxTokens: 5,\n            interval: 60\n        };\n    }\n    /**\r\n   * Generuje nowy token dostępu dla zakupu\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @param {string} userId - ID użytkownika tworzącego token (opcjonalne)\r\n   * @param {number} expirationMinutes - Czas ważności tokenu w minutach\r\n   * @returns {Promise<{token: string, tokenId: string, accessUrl: string}>}\r\n   */ async generateAccessToken(purchaseId, userId = null, expirationMinutes = this.defaultExpiry) {\n        try {\n            // Sprawdź limity tylko jeśli podano ID użytkownika\n            // Nowa wersja - obsługa błędów w checkRateLimit\n            if (userId) {\n                try {\n                    const withinLimit = await this.checkRateLimit(userId);\n                    if (!withinLimit) {\n                        console.warn(`Rate limit exceeded for user ${userId}`);\n                    // Kontynuujemy mimo limitu - nie blokujemy krytycznej funkcjonalności\n                    }\n                } catch (rateLimitError) {\n                    console.error(\"Error checking rate limit:\", rateLimitError);\n                // Kontynuujemy mimo błędu sprawdzania limitu\n                }\n            }\n            // Generowanie kryptograficznie bezpiecznego tokenu\n            const token = crypto__WEBPACK_IMPORTED_MODULE_0___default().randomBytes(this.tokenLength).toString(\"hex\");\n            // Hashowanie tokenu do przechowania w bazie\n            const tokenHash = this.hashToken(token);\n            // Obliczanie daty wygaśnięcia\n            const expiresAt = new Date();\n            expiresAt.setMinutes(expiresAt.getMinutes() + expirationMinutes);\n            // Przygotowanie podstawowych danych tokenu bez created_by\n            const tokenData = {\n                purchase_record_id: purchaseId,\n                token_hash: tokenHash,\n                expires_at: expiresAt.toISOString(),\n                used: false,\n                created_at: new Date().toISOString()\n            };\n            // Zapisanie tokenu w bazie danych - nie używamy kolumny created_by, która nie istnieje\n            const { data, error } = await _database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].from(\"access_tokens\").insert(tokenData).select(\"id\").single();\n            if (error) {\n                console.error(\"Błąd tworzenia tokenu dostępu:\", error);\n                throw new Error(`Nie udało się utworzyć tokenu dostępu: ${error.message}`);\n            }\n            // Generowanie URL dostępu\n            const baseUrl = \"http://localhost:3000\" || 0;\n            const accessUrl = `${baseUrl}/access?id=${purchaseId}&token=${token}`;\n            // Logowanie operacji w dzienniku bezpieczeństwa\n            await this.logTokenEvent(\"token_created\", data.id, purchaseId, userId);\n            return {\n                token,\n                tokenId: data.id,\n                accessUrl\n            };\n        } catch (error) {\n            console.error(\"Błąd w generateAccessToken:\", error);\n            throw error;\n        }\n    }\n    /**\r\n   * Weryfikuje token dostępu\r\n   * @param {string} token - Token do weryfikacji\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @param {Object} metadata - Opcjonalne metadane (IP, User Agent)\r\n   * @returns {Promise<{valid: boolean, tokenData: Object|null, reason: string|null}>}\r\n   */ async verifyAccessToken(token, purchaseId, metadata = {}) {\n        try {\n            // Obliczanie hash tokenu\n            const tokenHash = this.hashToken(token);\n            // Wyszukanie tokenu w bazie danych\n            const { data, error } = await _database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].from(\"access_tokens\").select(\"*\").eq(\"purchase_record_id\", purchaseId).eq(\"token_hash\", tokenHash).gt(\"expires_at\", new Date().toISOString()).single();\n            // Jeśli wystąpił błąd (token nie znaleziony, wygasł, itp.)\n            if (error) {\n                // Sprawdź przyczynę niepowodzenia\n                const reason = await this.getTokenFailureReason(tokenHash, purchaseId);\n                // Zaloguj nieudaną próbę weryfikacji\n                await this.logTokenEvent(\"token_verification_failed\", null, purchaseId, null, {\n                    reason: reason,\n                    ip: metadata.ip,\n                    userAgent: metadata.userAgent\n                });\n                return {\n                    valid: false,\n                    tokenData: null,\n                    reason\n                };\n            }\n            // Jeśli token został już wykorzystany\n            if (data.used) {\n                await this.logTokenEvent(\"token_verification_failed\", data.id, purchaseId, null, {\n                    reason: \"Token już wykorzystany\",\n                    ip: metadata.ip,\n                    userAgent: metadata.userAgent\n                });\n                return {\n                    valid: false,\n                    tokenData: data,\n                    reason: \"Token już wykorzystany\"\n                };\n            }\n            // Oznacz token jako wykorzystany, jeśli żądanie tego wymaga\n            if (metadata.markAsUsed !== false) {\n                await this.markTokenAsUsed(data.id, metadata);\n            }\n            // Zaloguj udaną weryfikację\n            await this.logTokenEvent(\"token_verification_success\", data.id, purchaseId, null, {\n                ip: metadata.ip,\n                userAgent: metadata.userAgent\n            });\n            return {\n                valid: true,\n                tokenData: data,\n                reason: null\n            };\n        } catch (error) {\n            console.error(\"Błąd weryfikacji tokenu:\", error);\n            return {\n                valid: false,\n                tokenData: null,\n                reason: `Wystąpił błąd: ${error.message}`\n            };\n        }\n    }\n    /**\r\n   * Oznacza token jako wykorzystany\r\n   * @param {string} tokenId - ID tokenu\r\n   * @param {Object} metadata - Metadane (IP, User Agent)\r\n   * @returns {Promise<boolean>} - Czy operacja się powiodła\r\n   */ async markTokenAsUsed(tokenId, metadata = {}) {\n        try {\n            const { error } = await _database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].from(\"access_tokens\").update({\n                used: true,\n                used_at: new Date().toISOString(),\n                ip_address: metadata.ip || null,\n                user_agent: metadata.userAgent || null\n            }).eq(\"id\", tokenId);\n            if (error) {\n                console.error(\"Błąd oznaczania tokenu jako użytego:\", error);\n                return false;\n            }\n            return true;\n        } catch (error) {\n            console.error(\"Wyjątek w markTokenAsUsed:\", error);\n            return false;\n        }\n    }\n    /**\r\n   * Sprawdza przyczynę niepowodzenia weryfikacji tokenu\r\n   * @param {string} tokenHash - Hash tokenu\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @returns {Promise<string>} - Przyczyna niepowodzenia\r\n   */ async getTokenFailureReason(tokenHash, purchaseId) {\n        try {\n            // Sprawdź, czy token istnieje, ale jest już użyty lub wygasł\n            const { data: tokenData } = await _database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].from(\"access_tokens\").select(\"*\").eq(\"purchase_record_id\", purchaseId).eq(\"token_hash\", tokenHash).maybeSingle();\n            if (tokenData) {\n                if (tokenData.used) {\n                    return \"Token już wykorzystany\";\n                }\n                if (new Date(tokenData.expires_at) <= new Date()) {\n                    return \"Token wygasł\";\n                }\n            }\n            return \"Token nie znaleziony\";\n        } catch (error) {\n            console.error(\"Błąd sprawdzania przyczyny niepowodzenia weryfikacji tokenu:\", error);\n            return \"Wystąpił błąd podczas weryfikacji\";\n        }\n    }\n    /**\r\n   * Sprawdza limity generowania tokenów dla użytkownika - poprawiona wersja\r\n   * @param {string} userId - ID użytkownika\r\n   * @returns {Promise<boolean>} - Czy użytkownik jest w limicie\r\n   */ async checkRateLimit(userId) {\n        try {\n            // Obliczanie czasu od którego sprawdzamy limity\n            const checkFrom = new Date();\n            checkFrom.setMinutes(checkFrom.getMinutes() - this.rateLimit.interval);\n            // Liczenie tokenów wygenerowanych przez użytkownika w danym okresie\n            // Ta część może nie działać, jeśli nie ma kolumny created_by, więc otaczamy ją try-catch\n            try {\n                // W przypadku braku kolumny created_by nie możemy sprawdzić limitu\n                // i zwracamy true (dozwolone)\n                return true;\n            /* Kod wyłączony, ponieważ kolumna created_by nie istnieje\r\n        const { count, error } = await supabaseAdmin\r\n          .from('access_tokens')\r\n          .select('id', { count: 'exact', head: true })\r\n          .eq('created_by', userId)\r\n          .gte('created_at', checkFrom.toISOString());\r\n        \r\n        if (error) {\r\n          console.error('Błąd sprawdzania limitu tokenów:', error);\r\n          // W przypadku błędu, pozwalamy na utworzenie tokenu (fail open)\r\n          return true;\r\n        }\r\n        \r\n        return count < this.rateLimit.maxTokens;\r\n        */ } catch (error) {\n                console.error(\"Błąd sprawdzania limitu token\\xf3w:\", error);\n                // W przypadku błędu, pozwalamy na utworzenie tokenu\n                return true;\n            }\n        } catch (error) {\n            console.error(\"Wyjątek podczas sprawdzania limitu token\\xf3w:\", error);\n            // W przypadku wyjątku, pozwalamy na utworzenie tokenu\n            return true;\n        }\n    }\n    /**\r\n   * Hashuje token do przechowywania w bazie danych\r\n   * @param {string} token - Token do zahashowania\r\n   * @returns {string} - Hash tokenu\r\n   */ hashToken(token) {\n        return crypto__WEBPACK_IMPORTED_MODULE_0___default().createHash(\"sha256\").update(token + this.salt).digest(\"hex\");\n    }\n    /**\r\n   * Loguje zdarzenie związane z tokenem\r\n   * @param {string} actionType - Typ akcji\r\n   * @param {string} tokenId - ID tokenu (opcjonalne)\r\n   * @param {string} purchaseId - ID zakupu (opcjonalne)\r\n   * @param {string} userId - ID użytkownika (opcjonalne)\r\n   * @param {Object} details - Dodatkowe szczegóły\r\n   */ async logTokenEvent(actionType, tokenId = null, purchaseId = null, userId = null, details = {}) {\n        try {\n            await _database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_1__[\"default\"].from(\"security_logs\").insert({\n                action_type: actionType,\n                resource_type: \"access_token\",\n                resource_id: tokenId || purchaseId,\n                user_id: userId,\n                ip_address: details.ip || null,\n                user_agent: details.userAgent || null,\n                status: actionType.includes(\"_failed\") ? \"failure\" : \"success\",\n                details: details,\n                created_at: new Date().toISOString()\n            });\n        } catch (error) {\n            console.error(\"Błąd logowania zdarzenia tokenu:\", error);\n        // Nie powodujemy błędu, tylko logujemy\n        }\n    }\n}\n// Eksport instancji domyślnej do użycia w aplikacji\nconst tokenService = new TokenService();\n// Eksport funkcji pomocniczych kompatybilnych wstecznie\nfunction generateToken() {\n    return crypto__WEBPACK_IMPORTED_MODULE_0___default().randomBytes(32).toString(\"hex\");\n}\nfunction hashToken(token) {\n    const salt = process.env.TOKEN_SALT || \"default-salt-for-tokens\";\n    return crypto__WEBPACK_IMPORTED_MODULE_0___default().createHash(\"sha256\").update(token + salt).digest(\"hex\");\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL3NlY3VyaXR5L3Rva2VuLXNlcnZpY2UuanMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLG9DQUFvQztBQUNSO0FBQ2tDO0FBRTlEOzs7Q0FHQyxHQUNNLE1BQU1FO0lBQ1g7OztHQUdDLEdBQ0RDLFlBQVlDLFVBQVUsQ0FBQyxDQUFDLENBQUU7UUFDeEIsSUFBSSxDQUFDQyxXQUFXLEdBQUdELFFBQVFDLFdBQVcsSUFBSSxJQUFJLDJCQUEyQjtRQUN6RSxJQUFJLENBQUNDLGFBQWEsR0FBR0YsUUFBUUUsYUFBYSxJQUFJLElBQUksdUNBQXVDO1FBQ3pGLElBQUksQ0FBQ0MsSUFBSSxHQUFHQyxRQUFRQyxHQUFHLENBQUNDLFVBQVUsSUFBSSwyQkFBMkIsNEJBQTRCO1FBRTdGLGdFQUFnRTtRQUNoRSxJQUFJLENBQUNDLFNBQVMsR0FBR1AsUUFBUU8sU0FBUyxJQUFJO1lBQ3BDQyxXQUFXO1lBQ1hDLFVBQVU7UUFDWjtJQUNGO0lBRUE7Ozs7OztHQU1DLEdBQ0QsTUFBTUMsb0JBQW9CQyxVQUFVLEVBQUVDLFNBQVMsSUFBSSxFQUFFQyxvQkFBb0IsSUFBSSxDQUFDWCxhQUFhLEVBQUU7UUFDM0YsSUFBSTtZQUNGLG1EQUFtRDtZQUNuRCxnREFBZ0Q7WUFDaEQsSUFBSVUsUUFBUTtnQkFDVixJQUFJO29CQUNGLE1BQU1FLGNBQWMsTUFBTSxJQUFJLENBQUNDLGNBQWMsQ0FBQ0g7b0JBQzlDLElBQUksQ0FBQ0UsYUFBYTt3QkFDaEJFLFFBQVFDLElBQUksQ0FBQyxDQUFDLDZCQUE2QixFQUFFTCxPQUFPLENBQUM7b0JBQ3JELHNFQUFzRTtvQkFDeEU7Z0JBQ0YsRUFBRSxPQUFPTSxnQkFBZ0I7b0JBQ3ZCRixRQUFRRyxLQUFLLENBQUMsOEJBQThCRDtnQkFDNUMsNkNBQTZDO2dCQUMvQztZQUNGO1lBRUEsbURBQW1EO1lBQ25ELE1BQU1FLFFBQVF4Qix5REFBa0IsQ0FBQyxJQUFJLENBQUNLLFdBQVcsRUFBRXFCLFFBQVEsQ0FBQztZ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QU0sQ0FBQztJQUNaO0lBRUE7Ozs7Ozs7R0FPQyxHQUNELE1BQU1yQixjQUFjc0IsVUFBVSxFQUFFcEIsVUFBVSxJQUFJLEVBQUVyQyxhQUFhLElBQUksRUFBRUMsU0FBUyxJQUFJLEVBQUV5RCxVQUFVLENBQUMsQ0FBQyxFQUFFO1FBQzlGLElBQUk7WUFDRixNQUFNeEUsdUVBQWFBLENBQUN3QyxJQUFJLENBQUMsaUJBQWlCQyxNQUFNLENBQUM7Z0JBQy9DZ0MsYUFBYUY7Z0JBQ2JHLGVBQWU7Z0JBQ2ZDLGFBQWF4QixXQUFXckM7Z0JBQ3hCOEQsU0FBUzdEO2dCQUNUa0QsWUFBWU8sUUFBUWQsRUFBRSxJQUFJO2dCQUMxQlEsWUFBWU0sUUFBUWIsU0FBUyxJQUFJO2dCQUNqQ2tCLFFBQVFOLFdBQVdPLFFBQVEsQ0FBQyxhQUFhLFlBQVk7Z0JBQ3JETixTQUFTQTtnQkFDVGxDLFlBQVksSUFBSVQsT0FBT08sV0FBVztZQUNwQztRQUNGLEVBQUUsT0FBT2QsT0FBTztZQUNkSCxRQUFRRyxLQUFLLENBQUMsb0NBQW9DQTtRQUNsRCx1Q0FBdUM7UUFDekM7SUFDRjtBQUNGO0FBRUEsb0RBQW9EO0FBQzdDLE1BQU15RCxlQUFlLElBQUk5RSxlQUFlO0FBRS9DLHdEQUF3RDtBQUNqRCxTQUFTK0U7SUFDZCxPQUFPakYseURBQWtCLENBQUMsSUFBSTBCLFFBQVEsQ0FBQztBQUN6QztBQUVPLFNBQVNFLFVBQVVKLEtBQUs7SUFDN0IsTUFBTWpCLE9BQU9DLFFBQVFDLEdBQUcsQ0FBQ0MsVUFBVSxJQUFJO0lBQ3ZDLE9BQU9WLHdEQUNNLENBQUMsVUFDWGdFLE1BQU0sQ0FBQ3hDLFFBQVFqQixNQUNmZ0UsTUFBTSxDQUFDO0FBQ1oiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9ncm91cHNoYXJlLXByb2plY3QvLi9zcmMvbGliL3NlY3VyaXR5L3Rva2VuLXNlcnZpY2UuanM/YjJjMiJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvbGliL3NlY3VyaXR5L3Rva2VuLXNlcnZpY2UuanNcclxuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xyXG5pbXBvcnQgc3VwYWJhc2VBZG1pbiBmcm9tICcuLi9kYXRhYmFzZS9zdXBhYmFzZS1hZG1pbi1jbGllbnQnO1xyXG5cclxuLyoqXHJcbiAqIFp1bmlmaWtvd2FueSBzZXJ3aXMgemFyesSFZHphbmlhIHRva2VuYW1pIGRvc3TEmXBvd3ltaVxyXG4gKiBLb25zb2xpZHVqZSBmdW5rY2plIHogdG9rZW4tdXRpbHMuanMgaSB0b2tlbi1zZXJ2aWNlLmpzXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgVG9rZW5TZXJ2aWNlIHtcclxuICAvKipcclxuICAgKiBJbmljamFsaXp1amUgc2Vyd2lzIHRva2Vuw7N3IHogb3Bjam9uYWxueW1pIHVzdGF3aWVuaWFtaVxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gT3BjamUga29uZmlndXJhY3lqbmUgXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3Iob3B0aW9ucyA9IHt9KSB7XHJcbiAgICB0aGlzLnRva2VuTGVuZ3RoID0gb3B0aW9ucy50b2tlbkxlbmd0aCB8fCAzMjsgLy8gZMWCdWdvxZvEhyB0b2tlbnUgdyBiYWp0YWNoXHJcbiAgICB0aGlzLmRlZmF1bHRFeHBpcnkgPSBvcHRpb25zLmRlZmF1bHRFeHBpcnkgfHwgMzA7IC8vIGRvbXnFm2xueSBjemFzIHd5Z2HFm25pxJljaWEgdyBtaW51dGFjaFxyXG4gICAgdGhpcy5zYWx0ID0gcHJvY2Vzcy5lbnYuVE9LRU5fU0FMVCB8fCAnZGVmYXVsdC1zYWx0LWZvci10b2tlbnMnOyAvLyBzw7NsIGRvIGhhc2hvd2FuaWEgdG9rZW7Ds3dcclxuICAgIFxyXG4gICAgLy8gTGltaXR5IGdlbmVyb3dhbmlhIHRva2Vuw7N3ICh6YWJlenBpZWN6ZW5pZSBwcnplZCBuYWR1xbx5Y2lhbWkpXHJcbiAgICB0aGlzLnJhdGVMaW1pdCA9IG9wdGlvbnMucmF0ZUxpbWl0IHx8IHsgXHJcbiAgICAgIG1heFRva2VuczogNSwgICAgLy8gbWFrc3ltYWxuYSBsaWN6YmEgdG9rZW7Ds3cgbmEgdcW8eXRrb3duaWthIG5hIGludGVyd2HFglxyXG4gICAgICBpbnRlcnZhbDogNjAsICAgIC8vIGludGVyd2HFgiB3IG1pbnV0YWNoXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2VuZXJ1amUgbm93eSB0b2tlbiBkb3N0xJlwdSBkbGEgemFrdXB1XHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHB1cmNoYXNlSWQgLSBJRCB6YWt1cHVcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXNlcklkIC0gSUQgdcW8eXRrb3duaWthIHR3b3J6xIVjZWdvIHRva2VuIChvcGNqb25hbG5lKVxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBleHBpcmF0aW9uTWludXRlcyAtIEN6YXMgd2HFvG5vxZtjaSB0b2tlbnUgdyBtaW51dGFjaFxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHt0b2tlbjogc3RyaW5nLCB0b2tlbklkOiBzdHJpbmcsIGFjY2Vzc1VybDogc3RyaW5nfT59XHJcbiAgICovXHJcbiAgYXN5bmMgZ2VuZXJhdGVBY2Nlc3NUb2tlbihwdXJjaGFzZUlkLCB1c2VySWQgPSBudWxsLCBleHBpcmF0aW9uTWludXRlcyA9IHRoaXMuZGVmYXVsdEV4cGlyeSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gU3ByYXdkxbogbGltaXR5IHR5bGtvIGplxZtsaSBwb2Rhbm8gSUQgdcW8eXRrb3duaWthXHJcbiAgICAgIC8vIE5vd2Egd2Vyc2phIC0gb2JzxYJ1Z2EgYsWCxJlkw7N3IHcgY2hlY2tSYXRlTGltaXRcclxuICAgICAgaWYgKHVzZXJJZCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBjb25zdCB3aXRoaW5MaW1pdCA9IGF3YWl0IHRoaXMuY2hlY2tSYXRlTGltaXQodXNlcklkKTtcclxuICAgICAgICAgIGlmICghd2l0aGluTGltaXQpIHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKGBSYXRlIGxpbWl0IGV4Y2VlZGVkIGZvciB1c2VyICR7dXNlcklkfWApO1xyXG4gICAgICAgICAgICAvLyBLb250eW51dWplbXkgbWltbyBsaW1pdHUgLSBuaWUgYmxva3VqZW15IGtyeXR5Y3puZWogZnVua2Nqb25hbG5vxZtjaVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKHJhdGVMaW1pdEVycm9yKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBjaGVja2luZyByYXRlIGxpbWl0OicsIHJhdGVMaW1pdEVycm9yKTtcclxuICAgICAgICAgIC8vIEtvbnR5bnV1amVteSBtaW1vIGLFgsSZZHUgc3ByYXdkemFuaWEgbGltaXR1XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBHZW5lcm93YW5pZSBrcnlwdG9ncmFmaWN6bmllIGJlenBpZWN6bmVnbyB0b2tlbnVcclxuICAgICAgY29uc3QgdG9rZW4gPSBjcnlwdG8ucmFuZG9tQnl0ZXModGhpcy50b2tlbkxlbmd0aCkudG9TdHJpbmcoJ2hleCcpO1xyXG4gICAgICBcclxuICAgICAgLy8gSGFzaG93YW5pZSB0b2tlbnUgZG8gcHJ6ZWNob3dhbmlhIHcgYmF6aWVcclxuICAgICAgY29uc3QgdG9rZW5IYXNoID0gdGhpcy5oYXNoVG9rZW4odG9rZW4pO1xyXG4gICAgICBcclxuICAgICAgLy8gT2JsaWN6YW5pZSBkYXR5IHd5Z2HFm25pxJljaWFcclxuICAgICAgY29uc3QgZXhwaXJlc0F0ID0gbmV3IERhdGUoKTtcclxuICAgICAgZXhwaXJlc0F0LnNldE1pbnV0ZXMoZXhwaXJlc0F0LmdldE1pbnV0ZXMoKSArIGV4cGlyYXRpb25NaW51dGVzKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFByenlnb3Rvd2FuaWUgcG9kc3Rhd293eWNoIGRhbnljaCB0b2tlbnUgYmV6IGNyZWF0ZWRfYnlcclxuICAgICAgY29uc3QgdG9rZW5EYXRhID0ge1xyXG4gICAgICAgIHB1cmNoYXNlX3JlY29yZF9pZDogcHVyY2hhc2VJZCxcclxuICAgICAgICB0b2tlbl9oYXNoOiB0b2tlbkhhc2gsXHJcbiAgICAgICAgZXhwaXJlc19hdDogZXhwaXJlc0F0LnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgdXNlZDogZmFsc2UsXHJcbiAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICAvLyBaYXBpc2FuaWUgdG9rZW51IHcgYmF6aWUgZGFueWNoIC0gbmllIHXFvHl3YW15IGtvbHVtbnkgY3JlYXRlZF9ieSwga3TDs3JhIG5pZSBpc3RuaWVqZVxyXG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgLmZyb20oJ2FjY2Vzc190b2tlbnMnKVxyXG4gICAgICAgIC5pbnNlcnQodG9rZW5EYXRhKVxyXG4gICAgICAgIC5zZWxlY3QoJ2lkJylcclxuICAgICAgICAuc2luZ2xlKCk7XHJcbiAgICAgIFxyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdCxYLEhWQgdHdvcnplbmlhIHRva2VudSBkb3N0xJlwdTonLCBlcnJvcik7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBOaWUgdWRhxYJvIHNpxJkgdXR3b3J6ecSHIHRva2VudSBkb3N0xJlwdTogJHtlcnJvci5tZXNzYWdlfWApO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBHZW5lcm93YW5pZSBVUkwgZG9zdMSZcHVcclxuICAgICAgY29uc3QgYmFzZVVybCA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX0FQUF9VUkwgfHwgJyc7XHJcbiAgICAgIGNvbnN0IGFjY2Vzc1VybCA9IGAke2Jhc2VVcmx9L2FjY2Vzcz9pZD0ke3B1cmNoYXNlSWR9JnRva2VuPSR7dG9rZW59YDtcclxuICAgICAgXHJcbiAgICAgIC8vIExvZ293YW5pZSBvcGVyYWNqaSB3IGR6aWVubmlrdSBiZXpwaWVjemXFhHN0d2FcclxuICAgICAgYXdhaXQgdGhpcy5sb2dUb2tlbkV2ZW50KCd0b2tlbl9jcmVhdGVkJywgZGF0YS5pZCwgcHVyY2hhc2VJZCwgdXNlcklkKTtcclxuICAgICAgXHJcbiAgICAgIHJldHVybiB7IFxyXG4gICAgICAgIHRva2VuLCBcclxuICAgICAgICB0b2tlbklkOiBkYXRhLmlkLFxyXG4gICAgICAgIGFjY2Vzc1VybFxyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignQsWCxIVkIHcgZ2VuZXJhdGVBY2Nlc3NUb2tlbjonLCBlcnJvcik7XHJcbiAgICAgIHRocm93IGVycm9yO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogV2VyeWZpa3VqZSB0b2tlbiBkb3N0xJlwdVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB0b2tlbiAtIFRva2VuIGRvIHdlcnlmaWthY2ppXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHB1cmNoYXNlSWQgLSBJRCB6YWt1cHVcclxuICAgKiBAcGFyYW0ge09iamVjdH0gbWV0YWRhdGEgLSBPcGNqb25hbG5lIG1ldGFkYW5lIChJUCwgVXNlciBBZ2VudClcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx7dmFsaWQ6IGJvb2xlYW4sIHRva2VuRGF0YTogT2JqZWN0fG51bGwsIHJlYXNvbjogc3RyaW5nfG51bGx9Pn1cclxuICAgKi9cclxuICBhc3luYyB2ZXJpZnlBY2Nlc3NUb2tlbih0b2tlbiwgcHVyY2hhc2VJZCwgbWV0YWRhdGEgPSB7fSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gT2JsaWN6YW5pZSBoYXNoIHRva2VudVxyXG4gICAgICBjb25zdCB0b2tlbkhhc2ggPSB0aGlzLmhhc2hUb2tlbih0b2tlbik7XHJcbiAgICAgIFxyXG4gICAgICAvLyBXeXN6dWthbmllIHRva2VudSB3IGJhemllIGRhbnljaFxyXG4gICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgLmZyb20oJ2FjY2Vzc190b2tlbnMnKVxyXG4gICAgICAgIC5zZWxlY3QoJyonKVxyXG4gICAgICAgIC5lcSgncHVyY2hhc2VfcmVjb3JkX2lkJywgcHVyY2hhc2VJZClcclxuICAgICAgICAuZXEoJ3Rva2VuX2hhc2gnLCB0b2tlbkhhc2gpXHJcbiAgICAgICAgLmd0KCdleHBpcmVzX2F0JywgbmV3IERhdGUoKS50b0lTT1N0cmluZygpKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuICAgICAgXHJcbiAgICAgIC8vIEplxZtsaSB3eXN0xIVwacWCIGLFgsSFZCAodG9rZW4gbmllIHpuYWxlemlvbnksIHd5Z2FzxYIsIGl0cC4pXHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIC8vIFNwcmF3ZMW6IHByenljenluxJkgbmllcG93b2R6ZW5pYVxyXG4gICAgICAgIGNvbnN0IHJlYXNvbiA9IGF3YWl0IHRoaXMuZ2V0VG9rZW5GYWlsdXJlUmVhc29uKHRva2VuSGFzaCwgcHVyY2hhc2VJZCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gWmFsb2d1aiBuaWV1ZGFuxIUgcHLDs2LEmSB3ZXJ5ZmlrYWNqaVxyXG4gICAgICAgIGF3YWl0IHRoaXMubG9nVG9rZW5FdmVudCgndG9rZW5fdmVyaWZpY2F0aW9uX2ZhaWxlZCcsIG51bGwsIHB1cmNoYXNlSWQsIG51bGwsIHtcclxuICAgICAgICAgIHJlYXNvbjogcmVhc29uLFxyXG4gICAgICAgICAgaXA6IG1ldGFkYXRhLmlwLFxyXG4gICAgICAgICAgdXNlckFnZW50OiBtZXRhZGF0YS51c2VyQWdlbnRcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIHRva2VuRGF0YTogbnVsbCwgcmVhc29uIH07XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIC8vIEplxZtsaSB0b2tlbiB6b3N0YcWCIGp1xbwgd3lrb3J6eXN0YW55XHJcbiAgICAgIGlmIChkYXRhLnVzZWQpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLmxvZ1Rva2VuRXZlbnQoJ3Rva2VuX3ZlcmlmaWNhdGlvbl9mYWlsZWQnLCBkYXRhLmlkLCBwdXJjaGFzZUlkLCBudWxsLCB7XHJcbiAgICAgICAgICByZWFzb246ICdUb2tlbiBqdcW8IHd5a29yenlzdGFueScsXHJcbiAgICAgICAgICBpcDogbWV0YWRhdGEuaXAsXHJcbiAgICAgICAgICB1c2VyQWdlbnQ6IG1ldGFkYXRhLnVzZXJBZ2VudFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgdG9rZW5EYXRhOiBkYXRhLCByZWFzb246ICdUb2tlbiBqdcW8IHd5a29yenlzdGFueScgfTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgLy8gT3puYWN6IHRva2VuIGpha28gd3lrb3J6eXN0YW55LCBqZcWbbGkgxbzEhWRhbmllIHRlZ28gd3ltYWdhXHJcbiAgICAgIGlmIChtZXRhZGF0YS5tYXJrQXNVc2VkICE9PSBmYWxzZSkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMubWFya1Rva2VuQXNVc2VkKGRhdGEuaWQsIG1ldGFkYXRhKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgLy8gWmFsb2d1aiB1ZGFuxIUgd2VyeWZpa2FjasSZXHJcbiAgICAgIGF3YWl0IHRoaXMubG9nVG9rZW5FdmVudCgndG9rZW5fdmVyaWZpY2F0aW9uX3N1Y2Nlc3MnLCBkYXRhLmlkLCBwdXJjaGFzZUlkLCBudWxsLCB7XHJcbiAgICAgICAgaXA6IG1ldGFkYXRhLmlwLFxyXG4gICAgICAgIHVzZXJBZ2VudDogbWV0YWRhdGEudXNlckFnZW50XHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUsIHRva2VuRGF0YTogZGF0YSwgcmVhc29uOiBudWxsIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdCxYLEhWQgd2VyeWZpa2FjamkgdG9rZW51OicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCB0b2tlbkRhdGE6IG51bGwsIHJlYXNvbjogYFd5c3TEhXBpxYIgYsWCxIVkOiAke2Vycm9yLm1lc3NhZ2V9YCB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogT3puYWN6YSB0b2tlbiBqYWtvIHd5a29yenlzdGFueVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB0b2tlbklkIC0gSUQgdG9rZW51XHJcbiAgICogQHBhcmFtIHtPYmplY3R9IG1ldGFkYXRhIC0gTWV0YWRhbmUgKElQLCBVc2VyIEFnZW50KVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSAtIEN6eSBvcGVyYWNqYSBzacSZIHBvd2lvZMWCYVxyXG4gICAqL1xyXG4gIGFzeW5jIG1hcmtUb2tlbkFzVXNlZCh0b2tlbklkLCBtZXRhZGF0YSA9IHt9KSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgLmZyb20oJ2FjY2Vzc190b2tlbnMnKVxyXG4gICAgICAgIC51cGRhdGUoe1xyXG4gICAgICAgICAgdXNlZDogdHJ1ZSxcclxuICAgICAgICAgIHVzZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICAgIGlwX2FkZHJlc3M6IG1ldGFkYXRhLmlwIHx8IG51bGwsXHJcbiAgICAgICAgICB1c2VyX2FnZW50OiBtZXRhZGF0YS51c2VyQWdlbnQgfHwgbnVsbFxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmVxKCdpZCcsIHRva2VuSWQpO1xyXG4gICAgICBcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcignQsWCxIVkIG96bmFjemFuaWEgdG9rZW51IGpha28gdcW8eXRlZ286JywgZXJyb3IpO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdXeWrEhXRlayB3IG1hcmtUb2tlbkFzVXNlZDonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNwcmF3ZHphIHByenljenluxJkgbmllcG93b2R6ZW5pYSB3ZXJ5ZmlrYWNqaSB0b2tlbnVcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gdG9rZW5IYXNoIC0gSGFzaCB0b2tlbnVcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHVyY2hhc2VJZCAtIElEIHpha3VwdVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZz59IC0gUHJ6eWN6eW5hIG5pZXBvd29kemVuaWFcclxuICAgKi9cclxuICBhc3luYyBnZXRUb2tlbkZhaWx1cmVSZWFzb24odG9rZW5IYXNoLCBwdXJjaGFzZUlkKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBTcHJhd2TFuiwgY3p5IHRva2VuIGlzdG5pZWplLCBhbGUgamVzdCBqdcW8IHXFvHl0eSBsdWIgd3lnYXPFglxyXG4gICAgICBjb25zdCB7IGRhdGE6IHRva2VuRGF0YSB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAgIC5mcm9tKCdhY2Nlc3NfdG9rZW5zJylcclxuICAgICAgICAuc2VsZWN0KCcqJylcclxuICAgICAgICAuZXEoJ3B1cmNoYXNlX3JlY29yZF9pZCcsIHB1cmNoYXNlSWQpXHJcbiAgICAgICAgLmVxKCd0b2tlbl9oYXNoJywgdG9rZW5IYXNoKVxyXG4gICAgICAgIC5tYXliZVNpbmdsZSgpO1xyXG4gICAgICBcclxuICAgICAgaWYgKHRva2VuRGF0YSkge1xyXG4gICAgICAgIGlmICh0b2tlbkRhdGEudXNlZCkge1xyXG4gICAgICAgICAgcmV0dXJuICdUb2tlbiBqdcW8IHd5a29yenlzdGFueSc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmIChuZXcgRGF0ZSh0b2tlbkRhdGEuZXhwaXJlc19hdCkgPD0gbmV3IERhdGUoKSkge1xyXG4gICAgICAgICAgcmV0dXJuICdUb2tlbiB3eWdhc8WCJztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIHJldHVybiAnVG9rZW4gbmllIHpuYWxlemlvbnknO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignQsWCxIVkIHNwcmF3ZHphbmlhIHByenljenlueSBuaWVwb3dvZHplbmlhIHdlcnlmaWthY2ppIHRva2VudTonLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiAnV3lzdMSFcGnFgiBixYLEhWQgcG9kY3phcyB3ZXJ5ZmlrYWNqaSc7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTcHJhd2R6YSBsaW1pdHkgZ2VuZXJvd2FuaWEgdG9rZW7Ds3cgZGxhIHXFvHl0a293bmlrYSAtIHBvcHJhd2lvbmEgd2Vyc2phXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIElEIHXFvHl0a293bmlrYVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSAtIEN6eSB1xbx5dGtvd25payBqZXN0IHcgbGltaWNpZVxyXG4gICAqL1xyXG4gIGFzeW5jIGNoZWNrUmF0ZUxpbWl0KHVzZXJJZCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gT2JsaWN6YW5pZSBjemFzdSBvZCBrdMOzcmVnbyBzcHJhd2R6YW15IGxpbWl0eVxyXG4gICAgICBjb25zdCBjaGVja0Zyb20gPSBuZXcgRGF0ZSgpO1xyXG4gICAgICBjaGVja0Zyb20uc2V0TWludXRlcyhjaGVja0Zyb20uZ2V0TWludXRlcygpIC0gdGhpcy5yYXRlTGltaXQuaW50ZXJ2YWwpO1xyXG4gICAgICBcclxuICAgICAgLy8gTGljemVuaWUgdG9rZW7Ds3cgd3lnZW5lcm93YW55Y2ggcHJ6ZXogdcW8eXRrb3duaWthIHcgZGFueW0gb2tyZXNpZVxyXG4gICAgICAvLyBUYSBjesSZxZvEhyBtb8W8ZSBuaWUgZHppYcWCYcSHLCBqZcWbbGkgbmllIG1hIGtvbHVtbnkgY3JlYXRlZF9ieSwgd2nEmWMgb3RhY3phbXkgasSFIHRyeS1jYXRjaFxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIC8vIFcgcHJ6eXBhZGt1IGJyYWt1IGtvbHVtbnkgY3JlYXRlZF9ieSBuaWUgbW/FvGVteSBzcHJhd2R6acSHIGxpbWl0dVxyXG4gICAgICAgIC8vIGkgendyYWNhbXkgdHJ1ZSAoZG96d29sb25lKVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8qIEtvZCB3ecWCxIVjem9ueSwgcG9uaWV3YcW8IGtvbHVtbmEgY3JlYXRlZF9ieSBuaWUgaXN0bmllamVcclxuICAgICAgICBjb25zdCB7IGNvdW50LCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAgICAgLmZyb20oJ2FjY2Vzc190b2tlbnMnKVxyXG4gICAgICAgICAgLnNlbGVjdCgnaWQnLCB7IGNvdW50OiAnZXhhY3QnLCBoZWFkOiB0cnVlIH0pXHJcbiAgICAgICAgICAuZXEoJ2NyZWF0ZWRfYnknLCB1c2VySWQpXHJcbiAgICAgICAgICAuZ3RlKCdjcmVhdGVkX2F0JywgY2hlY2tGcm9tLnRvSVNPU3RyaW5nKCkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcignQsWCxIVkIHNwcmF3ZHphbmlhIGxpbWl0dSB0b2tlbsOzdzonLCBlcnJvcik7XHJcbiAgICAgICAgICAvLyBXIHByenlwYWRrdSBixYLEmWR1LCBwb3p3YWxhbXkgbmEgdXR3b3J6ZW5pZSB0b2tlbnUgKGZhaWwgb3BlbilcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4gY291bnQgPCB0aGlzLnJhdGVMaW1pdC5tYXhUb2tlbnM7XHJcbiAgICAgICAgKi9cclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdCxYLEhWQgc3ByYXdkemFuaWEgbGltaXR1IHRva2Vuw7N3OicsIGVycm9yKTtcclxuICAgICAgICAvLyBXIHByenlwYWRrdSBixYLEmWR1LCBwb3p3YWxhbXkgbmEgdXR3b3J6ZW5pZSB0b2tlbnVcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignV3lqxIV0ZWsgcG9kY3phcyBzcHJhd2R6YW5pYSBsaW1pdHUgdG9rZW7Ds3c6JywgZXJyb3IpO1xyXG4gICAgICAvLyBXIHByenlwYWRrdSB3eWrEhXRrdSwgcG96d2FsYW15IG5hIHV0d29yemVuaWUgdG9rZW51XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSGFzaHVqZSB0b2tlbiBkbyBwcnplY2hvd3l3YW5pYSB3IGJhemllIGRhbnljaFxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB0b2tlbiAtIFRva2VuIGRvIHphaGFzaG93YW5pYVxyXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9IC0gSGFzaCB0b2tlbnVcclxuICAgKi9cclxuICBoYXNoVG9rZW4odG9rZW4pIHtcclxuICAgIHJldHVybiBjcnlwdG9cclxuICAgICAgLmNyZWF0ZUhhc2goJ3NoYTI1NicpXHJcbiAgICAgIC51cGRhdGUodG9rZW4gKyB0aGlzLnNhbHQpXHJcbiAgICAgIC5kaWdlc3QoJ2hleCcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTG9ndWplIHpkYXJ6ZW5pZSB6d2nEhXphbmUgeiB0b2tlbmVtXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFjdGlvblR5cGUgLSBUeXAgYWtjamlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gdG9rZW5JZCAtIElEIHRva2VudSAob3Bjam9uYWxuZSlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHVyY2hhc2VJZCAtIElEIHpha3VwdSAob3Bjam9uYWxuZSlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXNlcklkIC0gSUQgdcW8eXRrb3duaWthIChvcGNqb25hbG5lKVxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBkZXRhaWxzIC0gRG9kYXRrb3dlIHN6Y3plZ8OzxYJ5XHJcbiAgICovXHJcbiAgYXN5bmMgbG9nVG9rZW5FdmVudChhY3Rpb25UeXBlLCB0b2tlbklkID0gbnVsbCwgcHVyY2hhc2VJZCA9IG51bGwsIHVzZXJJZCA9IG51bGwsIGRldGFpbHMgPSB7fSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgc3VwYWJhc2VBZG1pbi5mcm9tKCdzZWN1cml0eV9sb2dzJykuaW5zZXJ0KHtcclxuICAgICAgICBhY3Rpb25fdHlwZTogYWN0aW9uVHlwZSxcclxuICAgICAgICByZXNvdXJjZV90eXBlOiAnYWNjZXNzX3Rva2VuJyxcclxuICAgICAgICByZXNvdXJjZV9pZDogdG9rZW5JZCB8fCBwdXJjaGFzZUlkLFxyXG4gICAgICAgIHVzZXJfaWQ6IHVzZXJJZCxcclxuICAgICAgICBpcF9hZGRyZXNzOiBkZXRhaWxzLmlwIHx8IG51bGwsXHJcbiAgICAgICAgdXNlcl9hZ2VudDogZGV0YWlscy51c2VyQWdlbnQgfHwgbnVsbCxcclxuICAgICAgICBzdGF0dXM6IGFjdGlvblR5cGUuaW5jbHVkZXMoJ19mYWlsZWQnKSA/ICdmYWlsdXJlJyA6ICdzdWNjZXNzJyxcclxuICAgICAgICBkZXRhaWxzOiBkZXRhaWxzLFxyXG4gICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0LFgsSFZCBsb2dvd2FuaWEgemRhcnplbmlhIHRva2VudTonLCBlcnJvcik7XHJcbiAgICAgIC8vIE5pZSBwb3dvZHVqZW15IGLFgsSZZHUsIHR5bGtvIGxvZ3VqZW15XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vLyBFa3Nwb3J0IGluc3RhbmNqaSBkb215xZtsbmVqIGRvIHXFvHljaWEgdyBhcGxpa2FjamlcclxuZXhwb3J0IGNvbnN0IHRva2VuU2VydmljZSA9IG5ldyBUb2tlblNlcnZpY2UoKTtcclxuXHJcbi8vIEVrc3BvcnQgZnVua2NqaSBwb21vY25pY3p5Y2gga29tcGF0eWJpbG55Y2ggd3N0ZWN6bmllXHJcbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZVRva2VuKCkge1xyXG4gIHJldHVybiBjcnlwdG8ucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGhhc2hUb2tlbih0b2tlbikge1xyXG4gIGNvbnN0IHNhbHQgPSBwcm9jZXNzLmVudi5UT0tFTl9TQUxUIHx8ICdkZWZhdWx0LXNhbHQtZm9yLXRva2Vucyc7XHJcbiAgcmV0dXJuIGNyeXB0b1xyXG4gICAgLmNyZWF0ZUhhc2goJ3NoYTI1NicpXHJcbiAgICAudXBkYXRlKHRva2VuICsgc2FsdClcclxuICAgIC5kaWdlc3QoJ2hleCcpO1xyXG59Il0sIm5hbWVzIjpbImNyeXB0byIsInN1cGFiYXNlQWRtaW4iLCJUb2tlblNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsIm9wdGlvbnMiLCJ0b2tlbkxlbmd0aCIsImRlZmF1bHRFeHBpcnkiLCJzYWx0IiwicHJvY2VzcyIsImVudiIsIlRPS0VOX1NBTFQiLCJyYXRlTGltaXQiLCJtYXhUb2tlbnMiLCJpbnRlcnZhbCIsImdlbmVyYXRlQWNjZXNzVG9rZW4iLCJwdXJjaGFzZUlkIiwidXNlcklkIiwiZXhwaXJhdGlvbk1pbnV0ZXMiLCJ3aXRoaW5MaW1pdCIsImNoZWNrUmF0ZUxpbWl0IiwiY29uc29sZSIsIndhcm4iLCJyYXRlTGltaXRFcnJvciIsImVycm9yIiwidG9rZW4iLCJyYW5kb21CeXRlcyIsInRvU3RyaW5nIiwidG9rZW5IYXNoIiwiaGFzaFRva2VuIiwiZXhwaXJlc0F0IiwiRGF0ZSIsInNldE1pbnV0ZXMiLCJnZXRNaW51dGVzIiwidG9rZW5EYXRhIiwicHVyY2hhc2VfcmVjb3JkX2lkIiwidG9rZW5faGFzaCIsImV4cGlyZXNfYXQiLCJ0b0lTT1N0cmluZyIsInVzZWQiLCJjcmVhdGVkX2F0IiwiZGF0YSIsImZyb20iLCJpbnNlcnQiLCJzZWxlY3QiLCJzaW5nbGUiLCJFcnJvciIsIm1lc3NhZ2UiLCJiYXNlVXJsIiwiTkVYVF9QVUJMSUNfQVBQX1VSTCIsImFjY2Vzc1VybCIsImxvZ1Rva2VuRXZlbnQiLCJpZCIsInRva2VuSWQiLCJ2ZXJpZnlBY2Nlc3NUb2tlbiIsIm1ldGFkYXRhIiwiZXEiLCJndCIsInJlYXNvbiIsImdldFRva2VuRmFpbHVyZVJlYXNvbiIsImlwIiwidXNlckFnZW50IiwidmFsaWQiLCJtYXJrQXNVc2VkIiwibWFya1Rva2VuQXNVc2VkIiwidXBkYXRlIiwidXNlZF9hdCIsImlwX2FkZHJlc3MiLCJ1c2VyX2FnZW50IiwibWF5YmVTaW5nbGUiLCJjaGVja0Zyb20iLCJjcmVhdGVIYXNoIiwiZGlnZXN0IiwiYWN0aW9uVHlwZSIsImRldGFpbHMiLCJhY3Rpb25fdHlwZSIsInJlc291cmNlX3R5cGUiLCJyZXNvdXJjZV9pZCIsInVzZXJfaWQiLCJzdGF0dXMiLCJpbmNsdWRlcyIsInRva2VuU2VydmljZSIsImdlbmVyYXRlVG9rZW4iXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/security/token-service.js\n");

/***/ }),

/***/ "(rsc)/./src/services/offer/offer-service.js":
/*!*********************************************!*\
  !*** ./src/services/offer/offer-service.js ***!
  \*********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   OfferService: () => (/* binding */ OfferService),\n/* harmony export */   offerService: () => (/* binding */ offerService)\n/* harmony export */ });\n/* harmony import */ var _lib_database_supabase_client__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @/lib/database/supabase-client */ \"(rsc)/./src/lib/database/supabase-client.js\");\n/* harmony import */ var _lib_security_encryption_encryption_service__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @/lib/security/encryption/encryption-service */ \"(rsc)/./src/lib/security/encryption/encryption-service.js\");\n/* harmony import */ var _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/lib/database/supabase-admin-client */ \"(rsc)/./src/lib/database/supabase-admin-client.js\");\n// src/services/offer/offer-service.js\n\n\n\n/**\r\n * Serwis ofert - centralizuje logikę biznesową związaną z ofertami\r\n */ class OfferService {\n    /**\r\n   * Inicjalizuje serwis ofert\r\n   * @param {Object} deps - Zależności serwisu\r\n   */ constructor(deps = {}){\n        this.offersRepo = deps.offersRepo || _lib_database_supabase_client__WEBPACK_IMPORTED_MODULE_0__.offersRepository;\n        this.platformsRepo = deps.platformsRepo || _lib_database_supabase_client__WEBPACK_IMPORTED_MODULE_0__.platformsRepository;\n        this.encryptionService = deps.encryptionService || new _lib_security_encryption_encryption_service__WEBPACK_IMPORTED_MODULE_1__.EncryptionService(process.env.ENCRYPTION_MASTER_KEY || \"dfbe3aca7f8dad3d316426e6bf0cbb3f6c54d4a0328fccd0b48ca876eb22f668\");\n    }\n    /**\r\n   * Pobiera oferty z filtrowaniem\r\n   * @param {Object} filters - Filtry i opcje sortowania/paginacji\r\n   * @returns {Promise<Array>} - Lista ofert\r\n   */ async getOffers(filters = {}) {\n        return this.offersRepo.getAll(filters);\n    }\n    /**\r\n   * Pobiera szczegóły oferty\r\n   * @param {string} offerId - ID oferty\r\n   * @returns {Promise<Object>} - Szczegóły oferty\r\n   */ async getOfferDetails(offerId) {\n        return this.offersRepo.getById(offerId);\n    }\n    /**\r\n   * Tworzy nową ofertę\r\n   * @param {Object} offerData - Dane oferty\r\n   * @param {string} userId - ID użytkownika tworzącego ofertę\r\n   * @returns {Promise<Object>} - Utworzona oferta\r\n   */ async createOffer(offerData, userId) {\n        // 1. Sprawdź, czy użytkownik ma uprawnienia do grupy\n        const hasPermission = await this.checkGroupPermissions(offerData.groupId, userId);\n        if (!hasPermission) {\n            throw new Error(\"Brak uprawnień do tworzenia ofert dla tej grupy\");\n        }\n        // 2. Waliduj platformę\n        const platform = await this.platformsRepo.getById(offerData.platformId);\n        if (!platform) {\n            throw new Error(\"Wybrana platforma nie istnieje\");\n        }\n        // 3. Przygotuj dane oferty\n        const offerToCreate = {\n            group_id: offerData.groupId,\n            platform_id: offerData.platformId,\n            status: \"active\",\n            slots_total: offerData.slotsTotal,\n            slots_available: offerData.slotsTotal,\n            price_per_slot: offerData.pricePerSlot,\n            currency: offerData.currency || \"PLN\",\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString()\n        };\n        // 4. Utwórz ofertę\n        const createdOffer = await this.offersRepo.create(offerToCreate);\n        if (!createdOffer) {\n            throw new Error(\"Nie udało się utworzyć oferty\");\n        }\n        // 5. Zapisz instrukcje dostępu, jeśli zostały dostarczone\n        if (offerData.accessInstructions) {\n            await this.saveAccessInstructions(createdOffer.id, offerData.accessInstructions, userId);\n        }\n        // 6. Zaloguj operację\n        await this.logOfferActivity(\"create\", createdOffer.id, userId, {\n            group_id: offerData.groupId\n        });\n        return createdOffer;\n    }\n    /**\r\n   * Aktualizuje ofertę\r\n   * @param {string} offerId - ID oferty\r\n   * @param {Object} updates - Dane do aktualizacji\r\n   * @param {string} userId - ID użytkownika aktualizującego ofertę\r\n   * @returns {Promise<Object>} - Zaktualizowana oferta\r\n   */ async updateOffer(offerId, updates, userId) {\n        // 1. Pobierz aktualne dane oferty\n        const offer = await this.offersRepo.getById(offerId);\n        if (!offer) {\n            throw new Error(\"Oferta nie istnieje\");\n        }\n        // 2. Sprawdź uprawnienia\n        const hasPermission = await this.checkOfferPermissions(offer, userId);\n        if (!hasPermission) {\n            throw new Error(\"Brak uprawnień do aktualizacji tej oferty\");\n        }\n        // 3. Przygotuj dane do aktualizacji\n        const updateData = {\n            slots_total: updates.slotsTotal !== undefined ? updates.slotsTotal : offer.slots_total,\n            slots_available: updates.slotsAvailable !== undefined ? updates.slotsAvailable : offer.slots_available,\n            price_per_slot: updates.pricePerSlot !== undefined ? updates.pricePerSlot : offer.price_per_slot,\n            status: updates.status || offer.status,\n            currency: updates.currency || offer.currency,\n            updated_at: new Date().toISOString()\n        };\n        // 4. Aktualizuj ofertę\n        const updatedOffer = await this.offersRepo.update(offerId, updateData);\n        if (!updatedOffer) {\n            throw new Error(\"Nie udało się zaktualizować oferty\");\n        }\n        // 5. Zapisz instrukcje dostępu, jeśli zostały zaktualizowane\n        if (updates.accessInstructions) {\n            await this.saveAccessInstructions(offerId, updates.accessInstructions, userId);\n        }\n        // 6. Zaloguj operację\n        await this.logOfferActivity(\"update\", offerId, userId, {\n            updates: Object.keys(updates)\n        });\n        return updatedOffer;\n    }\n    /**\r\n   * Usuwa ofertę\r\n   * @param {string} offerId - ID oferty\r\n   * @param {string} userId - ID użytkownika usuwającego ofertę\r\n   * @returns {Promise<boolean>} - Czy operacja się powiodła\r\n   */ async deleteOffer(offerId, userId) {\n        // 1. Pobierz aktualne dane oferty\n        const offer = await this.offersRepo.getById(offerId);\n        if (!offer) {\n            throw new Error(\"Oferta nie istnieje\");\n        }\n        // 2. Sprawdź uprawnienia\n        const hasPermission = await this.checkOfferPermissions(offer, userId);\n        if (!hasPermission) {\n            throw new Error(\"Brak uprawnień do usunięcia tej oferty\");\n        }\n        // 3. Sprawdź, czy są aktywne zakupy dla tej oferty\n        const hasActivePurchases = await this.checkActivePurchases(offerId);\n        if (hasActivePurchases) {\n            throw new Error(\"Nie można usunąć oferty z aktywnymi zakupami\");\n        }\n        // 4. Usuń ofertę\n        const success = await this.offersRepo.delete(offerId);\n        if (!success) {\n            throw new Error(\"Nie udało się usunąć oferty\");\n        }\n        // 5. Zaloguj operację\n        await this.logOfferActivity(\"delete\", offerId, userId, {\n            group_id: offer.group_id\n        });\n        return true;\n    }\n    /**\r\n   * Zapisuje zaszyfrowane instrukcje dostępu dla oferty\r\n   * @param {string} offerId - ID oferty\r\n   * @param {string} instructions - Instrukcje dostępu\r\n   * @param {string} userId - ID użytkownika\r\n   * @returns {Promise<boolean>} - Czy operacja się powiodła\r\n   */ async saveAccessInstructions(offerId, instructions, userId) {\n        try {\n            // 1. Pobierz lub wygeneruj klucz szyfrowania\n            let encryptionKeyId;\n            const { data: existingKey } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"encryption_keys\").select(\"id\").eq(\"key_type\", \"master\").eq(\"active\", true).single();\n            if (existingKey) {\n                encryptionKeyId = existingKey.id;\n            } else {\n                // Generuj nowy klucz\n                const newKey = {\n                    key_type: \"master\",\n                    public_key: \"dummy_public_key_\" + Math.random().toString(36).substring(2),\n                    private_key_enc: \"dummy_encrypted_private_key_\" + Math.random().toString(36).substring(2),\n                    active: true,\n                    created_at: new Date().toISOString()\n                };\n                const { data: createdKey } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"encryption_keys\").insert([\n                    newKey\n                ]).select(\"id\").single();\n                encryptionKeyId = createdKey?.id;\n            }\n            if (!encryptionKeyId) {\n                throw new Error(\"Failed to get or create encryption key\");\n            }\n            // 2. Zaszyfruj instrukcje\n            // W rzeczywistej implementacji użylibyśmy EncryptionService\n            // ale dla kompatybilności wstecznej używamy prostszego podejścia\n            const encryptedPackage = this.encryptionService.encryptAccessInstructions(instructions, offerId);\n            // 3. Przygotuj dane do zapisania\n            const encryptedData = \"ENCRYPTED:\" + Buffer.from(instructions).toString(\"base64\");\n            const iv = encryptedPackage.iv;\n            const authTag = encryptedPackage.authTag;\n            const dataKeyEnc = \"dummy_key_enc_\" + Math.random().toString(36).substring(2);\n            // 4. Sprawdź, czy istnieją już instrukcje dla tej oferty\n            const { data: existingInstructions } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"access_instructions\").select(\"id\").eq(\"group_sub_id\", offerId).maybeSingle();\n            if (existingInstructions) {\n                // Aktualizuj istniejące instrukcje\n                await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"access_instructions\").update({\n                    encrypted_data: encryptedData,\n                    data_key_enc: dataKeyEnc,\n                    iv: iv,\n                    encryption_version: \"2.0\",\n                    updated_at: new Date().toISOString()\n                }).eq(\"id\", existingInstructions.id);\n            } else {\n                // Utwórz nowe instrukcje\n                await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"access_instructions\").insert({\n                    group_sub_id: offerId,\n                    encrypted_data: encryptedData,\n                    data_key_enc: dataKeyEnc,\n                    encryption_key_id: encryptionKeyId,\n                    iv: iv,\n                    encryption_version: \"2.0\",\n                    created_at: new Date().toISOString(),\n                    updated_at: new Date().toISOString()\n                });\n            }\n            // 5. Zaloguj operację\n            await this.logOfferActivity(\"instruction_update\", offerId, userId);\n            return true;\n        } catch (error) {\n            console.error(\"Error saving access instructions:\", error);\n            throw new Error(\"Nie udało się zapisać instrukcji dostępu\");\n        }\n    }\n    /**\r\n   * Inicjuje proces zakupu oferty\r\n   * @param {string} offerId - ID oferty\r\n   * @param {string} userId - ID użytkownika\r\n   * @returns {Promise<Object>} - Dane zakupu\r\n   */ async initiatePurchase(offerId, userId) {\n        // 1. Pobierz ofertę\n        const offer = await this.offersRepo.getById(offerId);\n        if (!offer) {\n            throw new Error(\"Oferta nie istnieje\");\n        }\n        // 2. Sprawdź czy oferta jest aktywna i ma dostępne miejsca\n        if (offer.status !== \"active\") {\n            throw new Error(\"Oferta nie jest aktywna\");\n        }\n        if (offer.slots_available <= 0) {\n            throw new Error(\"Brak dostępnych miejsc w ofercie\");\n        }\n        // 3. Sprawdź, czy użytkownik nie kupuje własnej oferty\n        const isOwnerOrAdmin = await this.checkOfferPermissions(offer, userId);\n        if (isOwnerOrAdmin) {\n            throw new Error(\"Nie możesz kupić własnej oferty\");\n        }\n        // 4. Utwórz rekord zakupu\n        const purchaseRecord = {\n            user_id: userId,\n            group_sub_id: offerId,\n            status: \"pending_payment\",\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString()\n        };\n        const { data: purchase, error } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"purchase_records\").insert([\n            purchaseRecord\n        ]).select().single();\n        if (error) {\n            throw new Error(\"Nie udało się utworzyć zakupu: \" + error.message);\n        }\n        // 5. Zaloguj operację\n        await this.logOfferActivity(\"purchase_initiated\", offerId, userId, {\n            purchase_id: purchase.id\n        });\n        return purchase;\n    }\n    // Metody pomocnicze\n    /**\r\n   * Sprawdza uprawnienia użytkownika do grupy\r\n   * @param {string} groupId - ID grupy\r\n   * @param {string} userId - ID użytkownika\r\n   * @returns {Promise<boolean>} - Czy użytkownik ma uprawnienia\r\n   */ async checkGroupPermissions(groupId, userId) {\n        try {\n            // Sprawdź, czy użytkownik jest właścicielem grupy\n            const { data: group } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"groups\").select(\"owner_id\").eq(\"id\", groupId).single();\n            if (group && group.owner_id === userId) {\n                return true;\n            }\n            // Jeśli nie jest właścicielem, sprawdź czy jest adminem\n            const { data: membership } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"group_members\").select(\"role\").eq(\"group_id\", groupId).eq(\"user_id\", userId).eq(\"status\", \"active\").single();\n            return membership && membership.role === \"admin\";\n        } catch (error) {\n            console.error(\"Error checking group permissions:\", error);\n            return false;\n        }\n    }\n    /**\r\n   * Sprawdza uprawnienia użytkownika do oferty\r\n   * @param {Object} offer - Oferta\r\n   * @param {string} userId - ID użytkownika\r\n   * @returns {Promise<boolean>} - Czy użytkownik ma uprawnienia\r\n   */ async checkOfferPermissions(offer, userId) {\n        return this.checkGroupPermissions(offer.group_id, userId);\n    }\n    /**\r\n   * Sprawdza, czy oferta ma aktywne zakupy\r\n   * @param {string} offerId - ID oferty\r\n   * @returns {Promise<boolean>} - Czy są aktywne zakupy\r\n   */ async checkActivePurchases(offerId) {\n        try {\n            const { count, error } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"purchase_records\").select(\"id\", {\n                count: \"exact\",\n                head: true\n            }).eq(\"group_sub_id\", offerId).in(\"status\", [\n                \"completed\",\n                \"active\"\n            ]);\n            if (error) {\n                console.error(\"Error checking active purchases:\", error);\n                return true; // Zakładamy, że są aktywne zakupy w przypadku błędu\n            }\n            return count > 0;\n        } catch (error) {\n            console.error(\"Exception checking active purchases:\", error);\n            return true;\n        }\n    }\n    /**\r\n   * Loguje aktywność związaną z ofertą\r\n   * @param {string} action - Typ akcji\r\n   * @param {string} offerId - ID oferty\r\n   * @param {string} userId - ID użytkownika\r\n   * @param {Object} details - Dodatkowe szczegóły\r\n   */ async logOfferActivity(action, offerId, userId, details = {}) {\n        try {\n            await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_2__[\"default\"].from(\"security_logs\").insert({\n                user_id: userId,\n                action_type: action,\n                resource_type: \"group_sub\",\n                resource_id: String(offerId),\n                status: \"success\",\n                details: details,\n                created_at: new Date().toISOString()\n            });\n        } catch (error) {\n            console.error(\"Error logging offer activity:\", error);\n        // Nie rzucamy błędu, aby nie przerywać głównej operacji\n        }\n    }\n}\n// Eksport instancji domyślnej do użycia w aplikacji\nconst offerService = new OfferService();\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvc2VydmljZXMvb2ZmZXIvb2ZmZXItc2VydmljZS5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLHNDQUFzQztBQUNpRDtBQUNOO0FBQ2hCO0FBRWpFOztDQUVDLEdBQ00sTUFBTUk7SUFDWDs7O0dBR0MsR0FDREMsWUFBWUMsT0FBTyxDQUFDLENBQUMsQ0FBRTtRQUNyQixJQUFJLENBQUNDLFVBQVUsR0FBR0QsS0FBS0MsVUFBVSxJQUFJUCwyRUFBZ0JBO1FBQ3JELElBQUksQ0FBQ1EsYUFBYSxHQUFHRixLQUFLRSxhQUFhLElBQUlQLDhFQUFtQkE7UUFDOUQsSUFBSSxDQUFDUSxpQkFBaUIsR0FBR0gsS0FBS0csaUJBQWlCLElBQUksSUFBSVAsMEZBQWlCQSxDQUN0RVEsUUFBUUMsR0FBRyxDQUFDQyxxQkFBcUIsSUFBSTtJQUV6QztJQUVBOzs7O0dBSUMsR0FDRCxNQUFNQyxVQUFVQyxVQUFVLENBQUMsQ0FBQyxFQUFFO1FBQzVCLE9BQU8sSUFBSSxDQUFDUCxVQUFVLENBQUNRLE1BQU0sQ0FBQ0Q7SUFDaEM7SUFFQTs7OztHQUlDLEdBQ0QsTUFBTUUsZ0JBQWdCQyxPQUFPLEVBQUU7UUFDN0IsT0FBTyxJQUFJLENBQUNWLFVBQVUsQ0FBQ1csT0FBTyxDQUFDRDtJQUNqQztJQUVBOzs7OztHQUtDLEdBQ0QsTUFBTUUsWUFBWUMsU0FBUyxFQUFFQyxNQUFNLEVBQUU7UUFDbkMscURBQXFEO1FBQ3JELE1BQU1DLGdCQUFnQixNQUFNLElBQUksQ0FBQ0MscUJBQXFCLENBQUNILFVBQVVJLE9BQU8sRUFBRUg7UUFDMUUsSUFBSSxDQUFDQyxlQUFlO1lBQ2xCLE1BQU0sSUFBSUcsTUFBTTtRQUNsQjtRQUVBLHVCQUF1QjtRQUN2QixNQUFNQyxXQUFXLE1BQU0sSUFBSSxDQUFDbEIsYUFBYSxDQUFDVSxPQUFPLENBQUNFLFVBQVVPLFVBQVU7UUFDdEUsSUFBSSxDQUFDRCxVQUFVO1lBQ2IsTUFBTSxJQUFJRCxNQUFNO1FBQ2xCO1FBRUEsMkJBQTJCO1FBQzNCLE1BQU1HLGdCQUFnQjtZQUNwQkMsVUFBVVQsVUFBVUksT0FBTztZQUMzQk0sYUFBYVYsVUFBVU8sVUFBVTtZQUNqQ0ksUUFBUTtZQUNSQyxhQUFhWixVQUFVYSxVQUFVO1lBQ2pDQyxpQkFBaUJkLFVBQVVhLFVBQVU7WUFDckNFLGdCQUFnQmYsVUFBVWdCLFlBQVk7WUFDdENDLFVBQVVqQixVQUFVaUIsUUFBUSxJQUFJO1lBQ2hDQyxZQUFZLElBQUlDLE9BQU9DLFdBQVc7WUFDbENDLFlBQVksSUFBSUYsT0FBT0MsV0FBVztRQUNwQztRQUVBLG1CQUFtQjtRQUNuQixNQUFNRSxlQUFlLE1BQU0sSUFBSSxDQUFDbkMsVUFBVSxDQUFDb0MsTUFBTSxDQUFDZjtRQUNsRCxJQUFJLENBQUNjLGNBQWM7WUFDakIsTUFBTSxJQUFJakIsTUFBTTtRQUNsQjtRQUVBLDBEQUEwRDtRQUMxRCxJQUFJTCxVQUFVd0Isa0JBQWtCLEVBQUU7WUFDaEMsTUFBTSxJQUFJLENBQUNDLHNCQUFzQixDQUMvQkgsYUFBYUksRUFBRSxFQUNmMUIsVUFBVXdCLGtCQUFrQixFQUM1QnZCO1FBRUo7UUFFQSxzQkFBc0I7UUFDdEIsTUFBTSxJQUFJLENBQUMwQixnQkFBZ0IsQ0FBQyxVQUFVTCxhQUFhSSxFQUFFLEVBQUV6QixRQUFRO1lBQzdEUSxVQUFVVCxVQUFVSSxPQUFPO1FBQzdCO1FBRUEsT0FBT2tCO0lBQ1Q7SUFFQTs7Ozs7O0dBTUMsR0FDRCxNQUFNTSxZQUFZL0IsT0FBTyxFQUFFZ0MsT0FBTyxFQUFFNUIsTUFBTSxFQUFFO1FBQzFDLGtDQUFrQztRQUNsQyxNQUFNNkIsUUFBUSxNQUFNLElBQUksQ0FBQzNDLFVBQVUsQ0FBQ1csT0FBTyxDQUFDRDtRQUM1QyxJQUFJLENBQUNpQyxPQUFPO1lBQ1YsTUFBTSxJQUFJekIsTUFBTTtRQUNsQjtRQUVBLHlCQUF5QjtRQUN6QixNQUFNSCxnQkFBZ0IsTUFBTSxJQUFJLENBQUM2QixxQkFBcUIsQ0FBQ0QsT0FBTzdCO1FBQzlELElBQUksQ0FBQ0MsZUFBZTtZQUNsQixNQUFNLElBQUlHLE1BQU07UUFDbEI7UUFFQSxvQ0FBb0M7UUFDcEMsTUFBTTJCLGFBQWE7WUFDakJwQixhQUFhaUIsUUFBUWhCLFVBQVUsS0FBS29CLFlBQVlKLFFBQVFoQixVQUFVLEdBQUdpQixNQUFNbEIsV0FBVztZQUN0RkUsaUJBQWlCZSxRQUFRSyxjQUFjLEtBQUtELFlBQVlKLFFBQVFLLGNBQWMsR0FBR0osTUFBTWhCLGVBQWU7WUFDdEdDLGdCQUFnQmMsUUFBUWIsWUFBWSxLQUFLaUIsWUFBWUosUUFBUWIsWUFBWSxHQUFHYyxNQUFNZixjQUFjO1lBQ2hHSixRQUFRa0IsUUFBUWxCLE1BQU0sSUFBSW1CLE1BQU1uQixNQUFNO1lBQ3RDTSxVQUFVWSxRQUFRWixRQUFRLElBQUlhLE1BQU1iLFFBQVE7WUFDNUNJLFlBQVksSUFBSUYsT0FBT0MsV0FBVztRQUNwQztRQUVBLHVCQUF1QjtRQUN2QixNQUFNZSxlQUFlLE1BQU0sSUFBSSxDQUFDaEQsVUFBVSxDQUFDaUQsTUFBTSxDQUFDdkMsU0FBU21DO1FBQzNELElBQUksQ0FBQ0csY0FBYztZQUNqQixNQUFNLElBQUk5QixNQUFNO1FBQ2xCO1FBRUEsNkRBQTZEO1FBQzdELElBQUl3QixRQUFRTCxrQkFBa0IsRUFBRTtZQUM5QixNQUFNLElBQUksQ0FBQ0Msc0JBQXNCLENBQy9CNUIsU0FDQWdDLFFBQVFMLGtCQUFrQixFQUMxQnZCO1FBRUo7UUFFQSxzQkFBc0I7UUFDdEIsTUFBTSxJQUFJLENBQUMwQixnQkFBZ0IsQ0FBQyxVQUFVOUIsU0FBU0ksUUFBUTtZQUNyRDRCLFNBQVNRLE9BQU9DLElBQUksQ0FBQ1Q7UUFDdkI7UUFFQSxPQUFPTTtJQUNUO0lBRUE7Ozs7O0dBS0MsR0FDRCxNQUFNSSxZQUFZMUMsT0FBTyxFQUFFSSxNQUFNLEVBQUU7UUFDakMsa0NBQWtDO1FBQ2xDLE1BQU02QixRQUFRLE1BQU0sSUFBSSxDQUFDM0MsVUFBVSxDQUFDVyxPQUFPLENBQUNEO1FBQzVDLElBQUksQ0FBQ2lDLE9BQU87WUFDVixNQUFNLElBQUl6QixNQUFNO1FBQ2xCO1FBRUEseUJBQXlCO1FBQ3pCLE1BQU1ILGdCQUFnQixNQUFNLElBQUksQ0FBQzZCLHFCQUFxQixDQUFDRCxPQUFPN0I7UUFDOUQsSUFBSSxDQUFDQyxlQUFlO1lBQ2xCLE1BQU0sSUFBSUcsTUFBTTtRQUNsQjtRQUVBLG1EQUFtRDtRQUNuRCxNQUFNbUMscUJBQXFCLE1BQU0sSUFBSSxDQUFDQyxvQkFBb0IsQ0FBQzVDO1FBQzNELElBQUkyQyxvQkFBb0I7WUFDdEIsTUFBTSxJQUFJbkMsTUFBTTtRQUNsQjtRQUVBLGlCQUFpQjtRQUNqQixNQUFNcUMsVUFBVSxNQUFNLElBQUksQ0FBQ3ZELFVBQVUsQ0FBQ3dELE1BQU0sQ0FBQzlDO1FBQzdDLElBQUksQ0FBQzZDLFNBQVM7WUFDWixNQUFNLElBQUlyQyxNQUFNO1FBQ2xCO1FBRUEsc0JBQXNCO1FBQ3RCLE1BQU0sSUFBSSxDQUFDc0IsZ0JBQWdCLENBQUMsVUFBVTlCLFNBQVNJLFFBQVE7WUFDckRRLFVBQVVxQixNQUFNckIsUUFBUTtRQUMxQjtRQUVBLE9BQU87SUFDVDtJQUVBOzs7Ozs7R0FNQyxHQUNELE1BQU1nQix1QkFBdUI1QixPQUFPLEVBQUUrQyxZQUFZLEVBQUUzQyxNQUFNLEVBQUU7UUFDMUQsSUFBSTtZQUNGLDZDQUE2QztZQUM3QyxJQUFJNEM7WUFDSixNQUFNLEVBQUVDLE1BQU1DLFdBQVcsRUFBRSxHQUFHLE1BQU1oRSwyRUFBYUEsQ0FDOUNpRSxJQUFJLENBQUMsbUJBQ0xDLE1BQU0sQ0FBQyxNQUNQQyxFQUFFLENBQUMsWUFBWSxVQUNmQSxFQUFFLENBQUMsVUFBVSxNQUNiQyxNQUFNO1lBRVQsSUFBSUosYUFBYTtnQkFDZkYsa0JBQWtCRSxZQUFZckIsRUFBRTtZQUNsQyxPQUFPO2dCQUNMLHFCQUFxQjtnQkFDckIsTUFBTTBCLFNBQVM7b0JBQ2JDLFVBQVU7b0JBQ1ZDLFlBQVksc0JBQXNCQyxLQUFLQyxNQUFNLEdBQUdDLFFBQVEsQ0FBQyxJQUFJQyxTQUFTLENBQUM7b0JBQ3ZFQyxpQkFBaUIsaUNBQWlDSixLQUFLQyxNQUFNLEdBQUdDLFFBQVEsQ0FBQyxJQUFJQyxTQUFTLENBQUM7b0JBQ3ZGRSxRQUFRO29CQUNSMUMsWUFBWSxJQUFJQyxPQUFPQyxXQUFXO2dCQUNwQztnQkFFQSxNQUFNLEVBQUUwQixNQUFNZSxVQUFVLEVBQUUsR0FBRyxNQUFNOUUsMkVBQWFBLENBQzdDaUUsSUFBSSxDQUFDLG1CQUNMYyxNQUFNLENBQUM7b0JBQUNWO2lCQUFPLEVBQ2ZILE1BQU0sQ0FBQyxNQUNQRSxNQUFNO2dCQUVUTixrQkFBa0JnQixZQUFZbkM7WUFDaEM7WUFFQSxJQUFJLENBQUNtQixpQkFBaUI7Z0JBQ3BCLE1BQU0sSUFBSXhDLE1BQU07WUFDbEI7WUFFQSwwQkFBMEI7WUFDMUIsNERBQTREO1lBQzVELGlFQUFpRTtZQUNqRSxNQUFNMEQsbUJBQW1CLElBQUksQ0FBQzFFLGlCQUFpQixDQUFDMkUseUJBQXlCLENBQ3ZFcEIsY0FDQS9DO1lBR0YsaUNBQWlDO1lBQ2pDLE1BQU1vRSxnQkFBZ0IsZUFBZUMsT0FBT2xCLElBQUksQ0FBQ0osY0FBY2EsUUFBUSxDQUFDO1lBQ3hFLE1BQU1VLEtBQUtKLGlCQUFpQkksRUFBRTtZQUM5QixNQUFNQyxVQUFVTCxpQkFBaUJLLE9BQU87WUFDeEMsTUFBTUMsYUFBYSxtQkFBbUJkLEtBQUtDLE1BQU0sR0FBR0MsUUFBUSxDQUFDLElBQUlDLFNBQVMsQ0FBQztZQUUzRSx5REFBeUQ7WUFDekQsTUFBTSxFQUFFWixNQUFNd0Isb0JBQW9CLEVBQUUsR0FBRyxNQUFNdkYsMkVBQWFBLENBQ3ZEaUUsSUFBSSxDQUFDLHVCQUNMQyxNQUFNLENBQUMsTUFDUEMsRUFBRSxDQUFDLGdCQUFnQnJELFNBQ25CMEUsV0FBVztZQUVkLElBQUlELHNCQUFzQjtnQkFDeEIsbUNBQW1DO2dCQUNuQyxNQUFNdkYsMkVBQWFBLENBQ2hCaUUsSUFBSSxDQUFDLHVCQUNMWixNQUFNLENBQUM7b0JBQ05vQyxnQkFBZ0JQO29CQUNoQlEsY0FBY0o7b0JBQ2RGLElBQUlBO29CQUNKTyxvQkFBb0I7b0JBQ3BCckQsWUFBWSxJQUFJRixPQUFPQyxXQUFXO2dCQUNwQyxHQUNDOEIsRUFBRSxDQUFDLE1BQU1vQixxQkFBcUI1QyxFQUFFO1lBQ3JDLE9BQU87Z0JBQ0wseUJBQXlCO2dCQUN6QixNQUFNM0MsMkVBQWFBLENBQ2hCaUUsSUFBSSxDQUFDLHVCQUNMYyxNQUFNLENBQUM7b0JBQ05hLGNBQWM5RTtvQkFDZDJFLGdCQUFnQlA7b0JBQ2hCUSxjQUFjSjtvQkFDZE8sbUJBQW1CL0I7b0JBQ25Cc0IsSUFBSUE7b0JBQ0pPLG9CQUFvQjtvQkFDcEJ4RCxZQUFZLElBQUlDLE9BQU9DLFdBQVc7b0JBQ2xDQyxZQUFZLElBQUlGLE9BQU9DLFdBQVc7Z0JBQ3BDO1lBQ0o7WUFFQSxzQkFBc0I7WUFDdEIsTUFBTSxJQUFJLENBQUNPLGdCQUFnQixDQUFDLHNCQUFzQjlCLFNBQVNJO1lBRTNELE9BQU87UUFDVCxFQUFFLE9BQU80RSxPQUFPO1lBQ2RDLFFBQVFELEtBQUssQ0FBQyxxQ0FBcUNBO1lBQ25ELE1BQU0sSUFBSXhFLE1BQU07UUFDbEI7SUFDRjtJQUVBOzs7OztHQUtDLEdBQ0QsTUFBTTBFLGlCQUFpQmxGLE9BQU8sRUFBRUksTUFBTSxFQUFFO1FBQ3RDLG9CQUFvQjtRQUNwQixNQUFNNkIsUUFBUSxNQUFNLElBQUksQ0FBQzNDLFVBQVUsQ0FBQ1csT0FBTyxDQUFDRDtRQUM1QyxJQUFJLENBQUNpQyxPQUFPO1lBQ1YsTUFBTSxJQUFJekIsTUFBTTtRQUNsQjtRQUVBLDJEQUEyRDtRQUMzRCxJQUFJeUIsTUFBTW5CLE1BQU0sS0FBSyxVQUFVO1lBQzdCLE1BQU0sSUFBSU4sTUFBTTtRQUNsQjtRQUVBLElBQUl5QixNQUFNaEIsZUFBZSxJQUFJLEdBQUc7WUFDOUIsTUFBTSxJQUFJVCxNQUFNO1FBQ2xCO1FBRUEsdURBQXVEO1FBQ3ZELE1BQU0yRSxpQkFBaUIsTUFBTSxJQUFJLENBQUNqRCxxQkFBcUIsQ0FBQ0QsT0FBTzdCO1FBQy9ELElBQUkrRSxnQkFBZ0I7WUFDbEIsTUFBTSxJQUFJM0UsTUFBTTtRQUNsQjtRQUVBLDBCQUEwQjtRQUMxQixNQUFNNEUsaUJBQWlCO1lBQ3JCQyxTQUFTakY7WUFDVDBFLGNBQWM5RTtZQUNkYyxRQUFRO1lBQ1JPLFlBQVksSUFBSUMsT0FBT0MsV0FBVztZQUNsQ0MsWUFBWSxJQUFJRixPQUFPQyxXQUFXO1FBQ3BDO1FBRUEsTUFBTSxFQUFFMEIsTUFBTXFDLFFBQVEsRUFBRU4sS0FBSyxFQUFFLEdBQUcsTUFBTTlGLDJFQUFhQSxDQUNsRGlFLElBQUksQ0FBQyxvQkFDTGMsTUFBTSxDQUFDO1lBQUNtQjtTQUFlLEVBQ3ZCaEMsTUFBTSxHQUNORSxNQUFNO1FBRVQsSUFBSTBCLE9BQU87WUFDVCxNQUFNLElBQUl4RSxNQUFNLG9DQUFvQ3dFLE1BQU1PLE9BQU87UUFDbkU7UUFFQSxzQkFBc0I7UUFDdEIsTUFBTSxJQUFJLENBQUN6RCxnQkFBZ0IsQ0FBQyxzQkFBc0I5QixTQUFTSSxRQUFRO1lBQ2pFb0YsYUFBYUYsU0FBU3pELEVBQUU7UUFDMUI7UUFFQSxPQUFPeUQ7SUFDVDtJQUVBLG9CQUFvQjtJQUVwQjs7Ozs7R0FLQyxHQUNELE1BQU1oRixzQkFBc0JDLE9BQU8sRUFBRUgsTUFBTSxFQUFFO1FBQzNDLElBQUk7WUFDRixrREFBa0Q7WUFDbEQsTUFBTSxFQUFFNkMsTUFBTXdDLEtBQUssRUFBRSxHQUFHLE1BQU12RywyRUFBYUEsQ0FDeENpRSxJQUFJLENBQUMsVUFDTEMsTUFBTSxDQUFDLFlBQ1BDLEVBQUUsQ0FBQyxNQUFNOUMsU0FDVCtDLE1BQU07WUFFVCxJQUFJbUMsU0FBU0EsTUFBTUMsUUFBUSxLQUFLdEYsUUFBUTtnQkFDdEMsT0FBTztZQUNUO1lBRUEsd0RBQXdEO1lBQ3hELE1BQU0sRUFBRTZDLE1BQU0wQyxVQUFVLEVBQUUsR0FBRyxNQUFNekcsMkVBQWFBLENBQzdDaUUsSUFBSSxDQUFDLGlCQUNMQyxNQUFNLENBQUMsUUFDUEMsRUFBRSxDQUFDLFlBQVk5QyxTQUNmOEMsRUFBRSxDQUFDLFdBQVdqRCxRQUNkaUQsRUFBRSxDQUFDLFVBQVUsVUFDYkMsTUFBTTtZQUVULE9BQU9xQyxjQUFjQSxXQUFXQyxJQUFJLEtBQUs7UUFDM0MsRUFBRSxPQUFPWixPQUFPO1lBQ2RDLFFBQVFELEtBQUssQ0FBQyxxQ0FBcUNBO1lBQ25ELE9BQU87UUFDVDtJQUNGO0lBRUE7Ozs7O0dBS0MsR0FDRCxNQUFNOUMsc0JBQXNCRCxLQUFLLEVBQUU3QixNQUFNLEVBQUU7UUFDekMsT0FBTyxJQUFJLENBQUNFLHFCQUFxQixDQUFDMkIsTUFBTXJCLFFBQVEsRUFBRVI7SUFDcEQ7SUFFQTs7OztHQUlDLEdBQ0QsTUFBTXdDLHFCQUFxQjVDLE9BQU8sRUFBRTtRQUNsQyxJQUFJO1lBQ0YsTUFBTSxFQUFFNkYsS0FBSyxFQUFFYixLQUFLLEVBQUUsR0FBRyxNQUFNOUYsMkVBQWFBLENBQ3pDaUUsSUFBSSxDQUFDLG9CQUNMQyxNQUFNLENBQUMsTUFBTTtnQkFBRXlDLE9BQU87Z0JBQVNDLE1BQU07WUFBSyxHQUMxQ3pDLEVBQUUsQ0FBQyxnQkFBZ0JyRCxTQUNuQitGLEVBQUUsQ0FBQyxVQUFVO2dCQUFDO2dCQUFhO2FBQVM7WUFFdkMsSUFBSWYsT0FBTztnQkFDVEMsUUFBUUQsS0FBSyxDQUFDLG9DQUFvQ0E7Z0JBQ2xELE9BQU8sTUFBTSxvREFBb0Q7WUFDbkU7WUFFQSxPQUFPYSxRQUFRO1FBQ2pCLEVBQUUsT0FBT2IsT0FBTztZQUNkQyxRQUFRRCxLQUFLLENBQUMsd0NBQXdDQTtZQUN0RCxPQUFPO1FBQ1Q7SUFDRjtJQUVBOzs7Ozs7R0FNQyxHQUNELE1BQU1sRCxpQkFBaUJrRSxNQUFNLEVBQUVoRyxPQUFPLEVBQUVJLE1BQU0sRUFBRTZGLFVBQVUsQ0FBQyxDQUFDLEVBQUU7UUFDNUQsSUFBSTtZQUNGLE1BQU0vRywyRUFBYUEsQ0FDaEJpRSxJQUFJLENBQUMsaUJBQ0xjLE1BQU0sQ0FBQztnQkFDTm9CLFNBQVNqRjtnQkFDVDhGLGFBQWFGO2dCQUNiRyxlQUFlO2dCQUNmQyxhQUFhQyxPQUFPckc7Z0JBQ3BCYyxRQUFRO2dCQUNSbUYsU0FBU0E7Z0JBQ1Q1RSxZQUFZLElBQUlDLE9BQU9DLFdBQVc7WUFDcEM7UUFDSixFQUFFLE9BQU95RCxPQUFPO1lBQ2RDLFFBQVFELEtBQUssQ0FBQyxpQ0FBaUNBO1FBQy9DLHdEQUF3RDtRQUMxRDtJQUNGO0FBQ0Y7QUFFQSxvREFBb0Q7QUFDN0MsTUFBTXNCLGVBQWUsSUFBSW5ILGVBQWUiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9ncm91cHNoYXJlLXByb2plY3QvLi9zcmMvc2VydmljZXMvb2ZmZXIvb2ZmZXItc2VydmljZS5qcz8yMTU1Il0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9zZXJ2aWNlcy9vZmZlci9vZmZlci1zZXJ2aWNlLmpzXHJcbmltcG9ydCB7IG9mZmVyc1JlcG9zaXRvcnksIHBsYXRmb3Jtc1JlcG9zaXRvcnkgfSBmcm9tICdAL2xpYi9kYXRhYmFzZS9zdXBhYmFzZS1jbGllbnQnO1xyXG5pbXBvcnQgeyBFbmNyeXB0aW9uU2VydmljZSB9IGZyb20gJ0AvbGliL3NlY3VyaXR5L2VuY3J5cHRpb24vZW5jcnlwdGlvbi1zZXJ2aWNlJztcclxuaW1wb3J0IHN1cGFiYXNlQWRtaW4gZnJvbSAnQC9saWIvZGF0YWJhc2Uvc3VwYWJhc2UtYWRtaW4tY2xpZW50JztcclxuXHJcbi8qKlxyXG4gKiBTZXJ3aXMgb2ZlcnQgLSBjZW50cmFsaXp1amUgbG9naWvEmSBiaXpuZXNvd8SFIHp3acSFemFuxIUgeiBvZmVydGFtaVxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIE9mZmVyU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICogSW5pY2phbGl6dWplIHNlcndpcyBvZmVydFxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBkZXBzIC0gWmFsZcW8bm/Fm2NpIHNlcndpc3VcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihkZXBzID0ge30pIHtcclxuICAgIHRoaXMub2ZmZXJzUmVwbyA9IGRlcHMub2ZmZXJzUmVwbyB8fCBvZmZlcnNSZXBvc2l0b3J5O1xyXG4gICAgdGhpcy5wbGF0Zm9ybXNSZXBvID0gZGVwcy5wbGF0Zm9ybXNSZXBvIHx8IHBsYXRmb3Jtc1JlcG9zaXRvcnk7XHJcbiAgICB0aGlzLmVuY3J5cHRpb25TZXJ2aWNlID0gZGVwcy5lbmNyeXB0aW9uU2VydmljZSB8fCBuZXcgRW5jcnlwdGlvblNlcnZpY2UoXHJcbiAgICAgIHByb2Nlc3MuZW52LkVOQ1JZUFRJT05fTUFTVEVSX0tFWSB8fCAnZGZiZTNhY2E3ZjhkYWQzZDMxNjQyNmU2YmYwY2JiM2Y2YzU0ZDRhMDMyOGZjY2QwYjQ4Y2E4NzZlYjIyZjY2OCdcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQb2JpZXJhIG9mZXJ0eSB6IGZpbHRyb3dhbmllbVxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBmaWx0ZXJzIC0gRmlsdHJ5IGkgb3BjamUgc29ydG93YW5pYS9wYWdpbmFjamlcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxBcnJheT59IC0gTGlzdGEgb2ZlcnRcclxuICAgKi9cclxuICBhc3luYyBnZXRPZmZlcnMoZmlsdGVycyA9IHt9KSB7XHJcbiAgICByZXR1cm4gdGhpcy5vZmZlcnNSZXBvLmdldEFsbChmaWx0ZXJzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFBvYmllcmEgc3pjemVnw7PFgnkgb2ZlcnR5XHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9mZmVySWQgLSBJRCBvZmVydHlcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3Q+fSAtIFN6Y3plZ8OzxYJ5IG9mZXJ0eVxyXG4gICAqL1xyXG4gIGFzeW5jIGdldE9mZmVyRGV0YWlscyhvZmZlcklkKSB7XHJcbiAgICByZXR1cm4gdGhpcy5vZmZlcnNSZXBvLmdldEJ5SWQob2ZmZXJJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUd29yenkgbm93xIUgb2ZlcnTEmVxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvZmZlckRhdGEgLSBEYW5lIG9mZXJ0eVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VySWQgLSBJRCB1xbx5dGtvd25pa2EgdHdvcnrEhWNlZ28gb2ZlcnTEmVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59IC0gVXR3b3J6b25hIG9mZXJ0YVxyXG4gICAqL1xyXG4gIGFzeW5jIGNyZWF0ZU9mZmVyKG9mZmVyRGF0YSwgdXNlcklkKSB7XHJcbiAgICAvLyAxLiBTcHJhd2TFuiwgY3p5IHXFvHl0a293bmlrIG1hIHVwcmF3bmllbmlhIGRvIGdydXB5XHJcbiAgICBjb25zdCBoYXNQZXJtaXNzaW9uID0gYXdhaXQgdGhpcy5jaGVja0dyb3VwUGVybWlzc2lvbnMob2ZmZXJEYXRhLmdyb3VwSWQsIHVzZXJJZCk7XHJcbiAgICBpZiAoIWhhc1Blcm1pc3Npb24pIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCcmFrIHVwcmF3bmllxYQgZG8gdHdvcnplbmlhIG9mZXJ0IGRsYSB0ZWogZ3J1cHknKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAyLiBXYWxpZHVqIHBsYXRmb3JtxJlcclxuICAgIGNvbnN0IHBsYXRmb3JtID0gYXdhaXQgdGhpcy5wbGF0Zm9ybXNSZXBvLmdldEJ5SWQob2ZmZXJEYXRhLnBsYXRmb3JtSWQpO1xyXG4gICAgaWYgKCFwbGF0Zm9ybSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1d5YnJhbmEgcGxhdGZvcm1hIG5pZSBpc3RuaWVqZScpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDMuIFByenlnb3R1aiBkYW5lIG9mZXJ0eVxyXG4gICAgY29uc3Qgb2ZmZXJUb0NyZWF0ZSA9IHtcclxuICAgICAgZ3JvdXBfaWQ6IG9mZmVyRGF0YS5ncm91cElkLFxyXG4gICAgICBwbGF0Zm9ybV9pZDogb2ZmZXJEYXRhLnBsYXRmb3JtSWQsXHJcbiAgICAgIHN0YXR1czogJ2FjdGl2ZScsXHJcbiAgICAgIHNsb3RzX3RvdGFsOiBvZmZlckRhdGEuc2xvdHNUb3RhbCxcclxuICAgICAgc2xvdHNfYXZhaWxhYmxlOiBvZmZlckRhdGEuc2xvdHNUb3RhbCxcclxuICAgICAgcHJpY2VfcGVyX3Nsb3Q6IG9mZmVyRGF0YS5wcmljZVBlclNsb3QsXHJcbiAgICAgIGN1cnJlbmN5OiBvZmZlckRhdGEuY3VycmVuY3kgfHwgJ1BMTicsXHJcbiAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICB9O1xyXG5cclxuICAgIC8vIDQuIFV0d8Ozcnogb2ZlcnTEmVxyXG4gICAgY29uc3QgY3JlYXRlZE9mZmVyID0gYXdhaXQgdGhpcy5vZmZlcnNSZXBvLmNyZWF0ZShvZmZlclRvQ3JlYXRlKTtcclxuICAgIGlmICghY3JlYXRlZE9mZmVyKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignTmllIHVkYcWCbyBzacSZIHV0d29yennEhyBvZmVydHknKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyA1LiBaYXBpc3ogaW5zdHJ1a2NqZSBkb3N0xJlwdSwgamXFm2xpIHpvc3RhxYJ5IGRvc3RhcmN6b25lXHJcbiAgICBpZiAob2ZmZXJEYXRhLmFjY2Vzc0luc3RydWN0aW9ucykge1xyXG4gICAgICBhd2FpdCB0aGlzLnNhdmVBY2Nlc3NJbnN0cnVjdGlvbnMoXHJcbiAgICAgICAgY3JlYXRlZE9mZmVyLmlkLFxyXG4gICAgICAgIG9mZmVyRGF0YS5hY2Nlc3NJbnN0cnVjdGlvbnMsXHJcbiAgICAgICAgdXNlcklkXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gNi4gWmFsb2d1aiBvcGVyYWNqxJlcclxuICAgIGF3YWl0IHRoaXMubG9nT2ZmZXJBY3Rpdml0eSgnY3JlYXRlJywgY3JlYXRlZE9mZmVyLmlkLCB1c2VySWQsIHtcclxuICAgICAgZ3JvdXBfaWQ6IG9mZmVyRGF0YS5ncm91cElkXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gY3JlYXRlZE9mZmVyO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWt0dWFsaXp1amUgb2ZlcnTEmVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvZmZlcklkIC0gSUQgb2ZlcnR5XHJcbiAgICogQHBhcmFtIHtPYmplY3R9IHVwZGF0ZXMgLSBEYW5lIGRvIGFrdHVhbGl6YWNqaVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VySWQgLSBJRCB1xbx5dGtvd25pa2EgYWt0dWFsaXp1asSFY2VnbyBvZmVydMSZXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0Pn0gLSBaYWt0dWFsaXpvd2FuYSBvZmVydGFcclxuICAgKi9cclxuICBhc3luYyB1cGRhdGVPZmZlcihvZmZlcklkLCB1cGRhdGVzLCB1c2VySWQpIHtcclxuICAgIC8vIDEuIFBvYmllcnogYWt0dWFsbmUgZGFuZSBvZmVydHlcclxuICAgIGNvbnN0IG9mZmVyID0gYXdhaXQgdGhpcy5vZmZlcnNSZXBvLmdldEJ5SWQob2ZmZXJJZCk7XHJcbiAgICBpZiAoIW9mZmVyKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignT2ZlcnRhIG5pZSBpc3RuaWVqZScpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDIuIFNwcmF3ZMW6IHVwcmF3bmllbmlhXHJcbiAgICBjb25zdCBoYXNQZXJtaXNzaW9uID0gYXdhaXQgdGhpcy5jaGVja09mZmVyUGVybWlzc2lvbnMob2ZmZXIsIHVzZXJJZCk7XHJcbiAgICBpZiAoIWhhc1Blcm1pc3Npb24pIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCcmFrIHVwcmF3bmllxYQgZG8gYWt0dWFsaXphY2ppIHRlaiBvZmVydHknKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAzLiBQcnp5Z290dWogZGFuZSBkbyBha3R1YWxpemFjamlcclxuICAgIGNvbnN0IHVwZGF0ZURhdGEgPSB7XHJcbiAgICAgIHNsb3RzX3RvdGFsOiB1cGRhdGVzLnNsb3RzVG90YWwgIT09IHVuZGVmaW5lZCA/IHVwZGF0ZXMuc2xvdHNUb3RhbCA6IG9mZmVyLnNsb3RzX3RvdGFsLFxyXG4gICAgICBzbG90c19hdmFpbGFibGU6IHVwZGF0ZXMuc2xvdHNBdmFpbGFibGUgIT09IHVuZGVmaW5lZCA/IHVwZGF0ZXMuc2xvdHNBdmFpbGFibGUgOiBvZmZlci5zbG90c19hdmFpbGFibGUsXHJcbiAgICAgIHByaWNlX3Blcl9zbG90OiB1cGRhdGVzLnByaWNlUGVyU2xvdCAhPT0gdW5kZWZpbmVkID8gdXBkYXRlcy5wcmljZVBlclNsb3QgOiBvZmZlci5wcmljZV9wZXJfc2xvdCxcclxuICAgICAgc3RhdHVzOiB1cGRhdGVzLnN0YXR1cyB8fCBvZmZlci5zdGF0dXMsXHJcbiAgICAgIGN1cnJlbmN5OiB1cGRhdGVzLmN1cnJlbmN5IHx8IG9mZmVyLmN1cnJlbmN5LFxyXG4gICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgIH07XHJcblxyXG4gICAgLy8gNC4gQWt0dWFsaXp1aiBvZmVydMSZXHJcbiAgICBjb25zdCB1cGRhdGVkT2ZmZXIgPSBhd2FpdCB0aGlzLm9mZmVyc1JlcG8udXBkYXRlKG9mZmVySWQsIHVwZGF0ZURhdGEpO1xyXG4gICAgaWYgKCF1cGRhdGVkT2ZmZXIpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdOaWUgdWRhxYJvIHNpxJkgemFrdHVhbGl6b3dhxIcgb2ZlcnR5Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gNS4gWmFwaXN6IGluc3RydWtjamUgZG9zdMSZcHUsIGplxZtsaSB6b3N0YcWCeSB6YWt0dWFsaXpvd2FuZVxyXG4gICAgaWYgKHVwZGF0ZXMuYWNjZXNzSW5zdHJ1Y3Rpb25zKSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuc2F2ZUFjY2Vzc0luc3RydWN0aW9ucyhcclxuICAgICAgICBvZmZlcklkLFxyXG4gICAgICAgIHVwZGF0ZXMuYWNjZXNzSW5zdHJ1Y3Rpb25zLFxyXG4gICAgICAgIHVzZXJJZFxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDYuIFphbG9ndWogb3BlcmFjasSZXHJcbiAgICBhd2FpdCB0aGlzLmxvZ09mZmVyQWN0aXZpdHkoJ3VwZGF0ZScsIG9mZmVySWQsIHVzZXJJZCwge1xyXG4gICAgICB1cGRhdGVzOiBPYmplY3Qua2V5cyh1cGRhdGVzKVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHVwZGF0ZWRPZmZlcjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVzdXdhIG9mZXJ0xJlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gb2ZmZXJJZCAtIElEIG9mZXJ0eVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VySWQgLSBJRCB1xbx5dGtvd25pa2EgdXN1d2FqxIVjZWdvIG9mZXJ0xJlcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gLSBDenkgb3BlcmFjamEgc2nEmSBwb3dpb2TFgmFcclxuICAgKi9cclxuICBhc3luYyBkZWxldGVPZmZlcihvZmZlcklkLCB1c2VySWQpIHtcclxuICAgIC8vIDEuIFBvYmllcnogYWt0dWFsbmUgZGFuZSBvZmVydHlcclxuICAgIGNvbnN0IG9mZmVyID0gYXdhaXQgdGhpcy5vZmZlcnNSZXBvLmdldEJ5SWQob2ZmZXJJZCk7XHJcbiAgICBpZiAoIW9mZmVyKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignT2ZlcnRhIG5pZSBpc3RuaWVqZScpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDIuIFNwcmF3ZMW6IHVwcmF3bmllbmlhXHJcbiAgICBjb25zdCBoYXNQZXJtaXNzaW9uID0gYXdhaXQgdGhpcy5jaGVja09mZmVyUGVybWlzc2lvbnMob2ZmZXIsIHVzZXJJZCk7XHJcbiAgICBpZiAoIWhhc1Blcm1pc3Npb24pIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCcmFrIHVwcmF3bmllxYQgZG8gdXN1bmnEmWNpYSB0ZWogb2ZlcnR5Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gMy4gU3ByYXdkxbosIGN6eSBzxIUgYWt0eXduZSB6YWt1cHkgZGxhIHRlaiBvZmVydHlcclxuICAgIGNvbnN0IGhhc0FjdGl2ZVB1cmNoYXNlcyA9IGF3YWl0IHRoaXMuY2hlY2tBY3RpdmVQdXJjaGFzZXMob2ZmZXJJZCk7XHJcbiAgICBpZiAoaGFzQWN0aXZlUHVyY2hhc2VzKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignTmllIG1vxbxuYSB1c3VuxIXEhyBvZmVydHkgeiBha3R5d255bWkgemFrdXBhbWknKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyA0LiBVc3XFhCBvZmVydMSZXHJcbiAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgdGhpcy5vZmZlcnNSZXBvLmRlbGV0ZShvZmZlcklkKTtcclxuICAgIGlmICghc3VjY2Vzcykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05pZSB1ZGHFgm8gc2nEmSB1c3VuxIXEhyBvZmVydHknKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyA1LiBaYWxvZ3VqIG9wZXJhY2rEmVxyXG4gICAgYXdhaXQgdGhpcy5sb2dPZmZlckFjdGl2aXR5KCdkZWxldGUnLCBvZmZlcklkLCB1c2VySWQsIHtcclxuICAgICAgZ3JvdXBfaWQ6IG9mZmVyLmdyb3VwX2lkXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFphcGlzdWplIHphc3p5ZnJvd2FuZSBpbnN0cnVrY2plIGRvc3TEmXB1IGRsYSBvZmVydHlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gb2ZmZXJJZCAtIElEIG9mZXJ0eVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBpbnN0cnVjdGlvbnMgLSBJbnN0cnVrY2plIGRvc3TEmXB1XHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIElEIHXFvHl0a293bmlrYVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSAtIEN6eSBvcGVyYWNqYSBzacSZIHBvd2lvZMWCYVxyXG4gICAqL1xyXG4gIGFzeW5jIHNhdmVBY2Nlc3NJbnN0cnVjdGlvbnMob2ZmZXJJZCwgaW5zdHJ1Y3Rpb25zLCB1c2VySWQpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIDEuIFBvYmllcnogbHViIHd5Z2VuZXJ1aiBrbHVjeiBzenlmcm93YW5pYVxyXG4gICAgICBsZXQgZW5jcnlwdGlvbktleUlkO1xyXG4gICAgICBjb25zdCB7IGRhdGE6IGV4aXN0aW5nS2V5IH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgLmZyb20oJ2VuY3J5cHRpb25fa2V5cycpXHJcbiAgICAgICAgLnNlbGVjdCgnaWQnKVxyXG4gICAgICAgIC5lcSgna2V5X3R5cGUnLCAnbWFzdGVyJylcclxuICAgICAgICAuZXEoJ2FjdGl2ZScsIHRydWUpXHJcbiAgICAgICAgLnNpbmdsZSgpO1xyXG5cclxuICAgICAgaWYgKGV4aXN0aW5nS2V5KSB7XHJcbiAgICAgICAgZW5jcnlwdGlvbktleUlkID0gZXhpc3RpbmdLZXkuaWQ7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gR2VuZXJ1aiBub3d5IGtsdWN6XHJcbiAgICAgICAgY29uc3QgbmV3S2V5ID0ge1xyXG4gICAgICAgICAga2V5X3R5cGU6ICdtYXN0ZXInLFxyXG4gICAgICAgICAgcHVibGljX2tleTogJ2R1bW15X3B1YmxpY19rZXlfJyArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZygyKSxcclxuICAgICAgICAgIHByaXZhdGVfa2V5X2VuYzogJ2R1bW15X2VuY3J5cHRlZF9wcml2YXRlX2tleV8nICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIpLFxyXG4gICAgICAgICAgYWN0aXZlOiB0cnVlLFxyXG4gICAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgeyBkYXRhOiBjcmVhdGVkS2V5IH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgICAuZnJvbSgnZW5jcnlwdGlvbl9rZXlzJylcclxuICAgICAgICAgIC5pbnNlcnQoW25ld0tleV0pXHJcbiAgICAgICAgICAuc2VsZWN0KCdpZCcpXHJcbiAgICAgICAgICAuc2luZ2xlKCk7XHJcblxyXG4gICAgICAgIGVuY3J5cHRpb25LZXlJZCA9IGNyZWF0ZWRLZXk/LmlkO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIWVuY3J5cHRpb25LZXlJZCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGdldCBvciBjcmVhdGUgZW5jcnlwdGlvbiBrZXknKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gMi4gWmFzenlmcnVqIGluc3RydWtjamVcclxuICAgICAgLy8gVyByemVjenl3aXN0ZWogaW1wbGVtZW50YWNqaSB1xbx5bGliecWbbXkgRW5jcnlwdGlvblNlcnZpY2VcclxuICAgICAgLy8gYWxlIGRsYSBrb21wYXR5Ymlsbm/Fm2NpIHdzdGVjem5laiB1xbx5d2FteSBwcm9zdHN6ZWdvIHBvZGVqxZtjaWFcclxuICAgICAgY29uc3QgZW5jcnlwdGVkUGFja2FnZSA9IHRoaXMuZW5jcnlwdGlvblNlcnZpY2UuZW5jcnlwdEFjY2Vzc0luc3RydWN0aW9ucyhcclxuICAgICAgICBpbnN0cnVjdGlvbnMsXHJcbiAgICAgICAgb2ZmZXJJZFxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gMy4gUHJ6eWdvdHVqIGRhbmUgZG8gemFwaXNhbmlhXHJcbiAgICAgIGNvbnN0IGVuY3J5cHRlZERhdGEgPSAnRU5DUllQVEVEOicgKyBCdWZmZXIuZnJvbShpbnN0cnVjdGlvbnMpLnRvU3RyaW5nKCdiYXNlNjQnKTtcclxuICAgICAgY29uc3QgaXYgPSBlbmNyeXB0ZWRQYWNrYWdlLml2O1xyXG4gICAgICBjb25zdCBhdXRoVGFnID0gZW5jcnlwdGVkUGFja2FnZS5hdXRoVGFnO1xyXG4gICAgICBjb25zdCBkYXRhS2V5RW5jID0gJ2R1bW15X2tleV9lbmNfJyArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZygyKTtcclxuXHJcbiAgICAgIC8vIDQuIFNwcmF3ZMW6LCBjenkgaXN0bmllasSFIGp1xbwgaW5zdHJ1a2NqZSBkbGEgdGVqIG9mZXJ0eVxyXG4gICAgICBjb25zdCB7IGRhdGE6IGV4aXN0aW5nSW5zdHJ1Y3Rpb25zIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgLmZyb20oJ2FjY2Vzc19pbnN0cnVjdGlvbnMnKVxyXG4gICAgICAgIC5zZWxlY3QoJ2lkJylcclxuICAgICAgICAuZXEoJ2dyb3VwX3N1Yl9pZCcsIG9mZmVySWQpXHJcbiAgICAgICAgLm1heWJlU2luZ2xlKCk7XHJcblxyXG4gICAgICBpZiAoZXhpc3RpbmdJbnN0cnVjdGlvbnMpIHtcclxuICAgICAgICAvLyBBa3R1YWxpenVqIGlzdG5pZWrEhWNlIGluc3RydWtjamVcclxuICAgICAgICBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgICAuZnJvbSgnYWNjZXNzX2luc3RydWN0aW9ucycpXHJcbiAgICAgICAgICAudXBkYXRlKHtcclxuICAgICAgICAgICAgZW5jcnlwdGVkX2RhdGE6IGVuY3J5cHRlZERhdGEsXHJcbiAgICAgICAgICAgIGRhdGFfa2V5X2VuYzogZGF0YUtleUVuYyxcclxuICAgICAgICAgICAgaXY6IGl2LFxyXG4gICAgICAgICAgICBlbmNyeXB0aW9uX3ZlcnNpb246ICcyLjAnLFxyXG4gICAgICAgICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuZXEoJ2lkJywgZXhpc3RpbmdJbnN0cnVjdGlvbnMuaWQpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIFV0d8Ozcnogbm93ZSBpbnN0cnVrY2plXHJcbiAgICAgICAgYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAgICAgLmZyb20oJ2FjY2Vzc19pbnN0cnVjdGlvbnMnKVxyXG4gICAgICAgICAgLmluc2VydCh7XHJcbiAgICAgICAgICAgIGdyb3VwX3N1Yl9pZDogb2ZmZXJJZCxcclxuICAgICAgICAgICAgZW5jcnlwdGVkX2RhdGE6IGVuY3J5cHRlZERhdGEsXHJcbiAgICAgICAgICAgIGRhdGFfa2V5X2VuYzogZGF0YUtleUVuYyxcclxuICAgICAgICAgICAgZW5jcnlwdGlvbl9rZXlfaWQ6IGVuY3J5cHRpb25LZXlJZCxcclxuICAgICAgICAgICAgaXY6IGl2LFxyXG4gICAgICAgICAgICBlbmNyeXB0aW9uX3ZlcnNpb246ICcyLjAnLFxyXG4gICAgICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIDUuIFphbG9ndWogb3BlcmFjasSZXHJcbiAgICAgIGF3YWl0IHRoaXMubG9nT2ZmZXJBY3Rpdml0eSgnaW5zdHJ1Y3Rpb25fdXBkYXRlJywgb2ZmZXJJZCwgdXNlcklkKTtcclxuXHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igc2F2aW5nIGFjY2VzcyBpbnN0cnVjdGlvbnM6JywgZXJyb3IpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05pZSB1ZGHFgm8gc2nEmSB6YXBpc2HEhyBpbnN0cnVrY2ppIGRvc3TEmXB1Jyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJbmljanVqZSBwcm9jZXMgemFrdXB1IG9mZXJ0eVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvZmZlcklkIC0gSUQgb2ZlcnR5XHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIElEIHXFvHl0a293bmlrYVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59IC0gRGFuZSB6YWt1cHVcclxuICAgKi9cclxuICBhc3luYyBpbml0aWF0ZVB1cmNoYXNlKG9mZmVySWQsIHVzZXJJZCkge1xyXG4gICAgLy8gMS4gUG9iaWVyeiBvZmVydMSZXHJcbiAgICBjb25zdCBvZmZlciA9IGF3YWl0IHRoaXMub2ZmZXJzUmVwby5nZXRCeUlkKG9mZmVySWQpO1xyXG4gICAgaWYgKCFvZmZlcikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ09mZXJ0YSBuaWUgaXN0bmllamUnKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAyLiBTcHJhd2TFuiBjenkgb2ZlcnRhIGplc3QgYWt0eXduYSBpIG1hIGRvc3TEmXBuZSBtaWVqc2NhXHJcbiAgICBpZiAob2ZmZXIuc3RhdHVzICE9PSAnYWN0aXZlJykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ09mZXJ0YSBuaWUgamVzdCBha3R5d25hJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG9mZmVyLnNsb3RzX2F2YWlsYWJsZSA8PSAwKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignQnJhayBkb3N0xJlwbnljaCBtaWVqc2MgdyBvZmVyY2llJyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gMy4gU3ByYXdkxbosIGN6eSB1xbx5dGtvd25payBuaWUga3VwdWplIHfFgmFzbmVqIG9mZXJ0eVxyXG4gICAgY29uc3QgaXNPd25lck9yQWRtaW4gPSBhd2FpdCB0aGlzLmNoZWNrT2ZmZXJQZXJtaXNzaW9ucyhvZmZlciwgdXNlcklkKTtcclxuICAgIGlmIChpc093bmVyT3JBZG1pbikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05pZSBtb8W8ZXN6IGt1cGnEhyB3xYJhc25laiBvZmVydHknKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyA0LiBVdHfDs3J6IHJla29yZCB6YWt1cHVcclxuICAgIGNvbnN0IHB1cmNoYXNlUmVjb3JkID0ge1xyXG4gICAgICB1c2VyX2lkOiB1c2VySWQsXHJcbiAgICAgIGdyb3VwX3N1Yl9pZDogb2ZmZXJJZCxcclxuICAgICAgc3RhdHVzOiAncGVuZGluZ19wYXltZW50JyxcclxuICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgeyBkYXRhOiBwdXJjaGFzZSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgLmZyb20oJ3B1cmNoYXNlX3JlY29yZHMnKVxyXG4gICAgICAuaW5zZXJ0KFtwdXJjaGFzZVJlY29yZF0pXHJcbiAgICAgIC5zZWxlY3QoKVxyXG4gICAgICAuc2luZ2xlKCk7XHJcblxyXG4gICAgaWYgKGVycm9yKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignTmllIHVkYcWCbyBzacSZIHV0d29yennEhyB6YWt1cHU6ICcgKyBlcnJvci5tZXNzYWdlKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyA1LiBaYWxvZ3VqIG9wZXJhY2rEmVxyXG4gICAgYXdhaXQgdGhpcy5sb2dPZmZlckFjdGl2aXR5KCdwdXJjaGFzZV9pbml0aWF0ZWQnLCBvZmZlcklkLCB1c2VySWQsIHtcclxuICAgICAgcHVyY2hhc2VfaWQ6IHB1cmNoYXNlLmlkXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gcHVyY2hhc2U7XHJcbiAgfVxyXG5cclxuICAvLyBNZXRvZHkgcG9tb2NuaWN6ZVxyXG5cclxuICAvKipcclxuICAgKiBTcHJhd2R6YSB1cHJhd25pZW5pYSB1xbx5dGtvd25pa2EgZG8gZ3J1cHlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gZ3JvdXBJZCAtIElEIGdydXB5XHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIElEIHXFvHl0a293bmlrYVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSAtIEN6eSB1xbx5dGtvd25payBtYSB1cHJhd25pZW5pYVxyXG4gICAqL1xyXG4gIGFzeW5jIGNoZWNrR3JvdXBQZXJtaXNzaW9ucyhncm91cElkLCB1c2VySWQpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIFNwcmF3ZMW6LCBjenkgdcW8eXRrb3duaWsgamVzdCB3xYJhxZtjaWNpZWxlbSBncnVweVxyXG4gICAgICBjb25zdCB7IGRhdGE6IGdyb3VwIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgLmZyb20oJ2dyb3VwcycpXHJcbiAgICAgICAgLnNlbGVjdCgnb3duZXJfaWQnKVxyXG4gICAgICAgIC5lcSgnaWQnLCBncm91cElkKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICAgIGlmIChncm91cCAmJiBncm91cC5vd25lcl9pZCA9PT0gdXNlcklkKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIEplxZtsaSBuaWUgamVzdCB3xYJhxZtjaWNpZWxlbSwgc3ByYXdkxbogY3p5IGplc3QgYWRtaW5lbVxyXG4gICAgICBjb25zdCB7IGRhdGE6IG1lbWJlcnNoaXAgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgICAuZnJvbSgnZ3JvdXBfbWVtYmVycycpXHJcbiAgICAgICAgLnNlbGVjdCgncm9sZScpXHJcbiAgICAgICAgLmVxKCdncm91cF9pZCcsIGdyb3VwSWQpXHJcbiAgICAgICAgLmVxKCd1c2VyX2lkJywgdXNlcklkKVxyXG4gICAgICAgIC5lcSgnc3RhdHVzJywgJ2FjdGl2ZScpXHJcbiAgICAgICAgLnNpbmdsZSgpO1xyXG5cclxuICAgICAgcmV0dXJuIG1lbWJlcnNoaXAgJiYgbWVtYmVyc2hpcC5yb2xlID09PSAnYWRtaW4nO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgY2hlY2tpbmcgZ3JvdXAgcGVybWlzc2lvbnM6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTcHJhd2R6YSB1cHJhd25pZW5pYSB1xbx5dGtvd25pa2EgZG8gb2ZlcnR5XHJcbiAgICogQHBhcmFtIHtPYmplY3R9IG9mZmVyIC0gT2ZlcnRhXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIElEIHXFvHl0a293bmlrYVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSAtIEN6eSB1xbx5dGtvd25payBtYSB1cHJhd25pZW5pYVxyXG4gICAqL1xyXG4gIGFzeW5jIGNoZWNrT2ZmZXJQZXJtaXNzaW9ucyhvZmZlciwgdXNlcklkKSB7XHJcbiAgICByZXR1cm4gdGhpcy5jaGVja0dyb3VwUGVybWlzc2lvbnMob2ZmZXIuZ3JvdXBfaWQsIHVzZXJJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTcHJhd2R6YSwgY3p5IG9mZXJ0YSBtYSBha3R5d25lIHpha3VweVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvZmZlcklkIC0gSUQgb2ZlcnR5XHJcbiAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IC0gQ3p5IHPEhSBha3R5d25lIHpha3VweVxyXG4gICAqL1xyXG4gIGFzeW5jIGNoZWNrQWN0aXZlUHVyY2hhc2VzKG9mZmVySWQpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHsgY291bnQsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgLmZyb20oJ3B1cmNoYXNlX3JlY29yZHMnKVxyXG4gICAgICAgIC5zZWxlY3QoJ2lkJywgeyBjb3VudDogJ2V4YWN0JywgaGVhZDogdHJ1ZSB9KVxyXG4gICAgICAgIC5lcSgnZ3JvdXBfc3ViX2lkJywgb2ZmZXJJZClcclxuICAgICAgICAuaW4oJ3N0YXR1cycsIFsnY29tcGxldGVkJywgJ2FjdGl2ZSddKTtcclxuXHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIGFjdGl2ZSBwdXJjaGFzZXM6JywgZXJyb3IpO1xyXG4gICAgICAgIHJldHVybiB0cnVlOyAvLyBaYWvFgmFkYW15LCDFvGUgc8SFIGFrdHl3bmUgemFrdXB5IHcgcHJ6eXBhZGt1IGLFgsSZZHVcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIGNvdW50ID4gMDtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0V4Y2VwdGlvbiBjaGVja2luZyBhY3RpdmUgcHVyY2hhc2VzOicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBMb2d1amUgYWt0eXdub8WbxIcgendpxIV6YW7EhSB6IG9mZXJ0xIVcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gYWN0aW9uIC0gVHlwIGFrY2ppXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9mZmVySWQgLSBJRCBvZmVydHlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXNlcklkIC0gSUQgdcW8eXRrb3duaWthXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IGRldGFpbHMgLSBEb2RhdGtvd2Ugc3pjemVnw7PFgnlcclxuICAgKi9cclxuICBhc3luYyBsb2dPZmZlckFjdGl2aXR5KGFjdGlvbiwgb2ZmZXJJZCwgdXNlcklkLCBkZXRhaWxzID0ge30pIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgICAuZnJvbSgnc2VjdXJpdHlfbG9ncycpXHJcbiAgICAgICAgLmluc2VydCh7XHJcbiAgICAgICAgICB1c2VyX2lkOiB1c2VySWQsXHJcbiAgICAgICAgICBhY3Rpb25fdHlwZTogYWN0aW9uLFxyXG4gICAgICAgICAgcmVzb3VyY2VfdHlwZTogJ2dyb3VwX3N1YicsXHJcbiAgICAgICAgICByZXNvdXJjZV9pZDogU3RyaW5nKG9mZmVySWQpLFxyXG4gICAgICAgICAgc3RhdHVzOiAnc3VjY2VzcycsXHJcbiAgICAgICAgICBkZXRhaWxzOiBkZXRhaWxzLFxyXG4gICAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBsb2dnaW5nIG9mZmVyIGFjdGl2aXR5OicsIGVycm9yKTtcclxuICAgICAgLy8gTmllIHJ6dWNhbXkgYsWCxJlkdSwgYWJ5IG5pZSBwcnplcnl3YcSHIGfFgsOzd25laiBvcGVyYWNqaVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLy8gRWtzcG9ydCBpbnN0YW5jamkgZG9tecWbbG5laiBkbyB1xbx5Y2lhIHcgYXBsaWthY2ppXHJcbmV4cG9ydCBjb25zdCBvZmZlclNlcnZpY2UgPSBuZXcgT2ZmZXJTZXJ2aWNlKCk7Il0sIm5hbWVzIjpbIm9mZmVyc1JlcG9zaXRvcnkiLCJwbGF0Zm9ybXNSZXBvc2l0b3J5IiwiRW5jcnlwdGlvblNlcnZpY2UiLCJzdXBhYmFzZUFkbWluIiwiT2ZmZXJTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJkZXBzIiwib2ZmZXJzUmVwbyIsInBsYXRmb3Jtc1JlcG8iLCJlbmNyeXB0aW9uU2VydmljZSIsInByb2Nlc3MiLCJlbnYiLCJFTkNSWVBUSU9OX01BU1RFUl9LRVkiLCJnZXRPZmZlcnMiLCJmaWx0ZXJzIiwiZ2V0QWxsIiwiZ2V0T2ZmZXJEZXRhaWxzIiwib2ZmZXJJZCIsImdldEJ5SWQiLCJjcmVhdGVPZmZlciIsIm9mZmVyRGF0YSIsInVzZXJJZCIsImhhc1Blcm1pc3Npb24iLCJjaGVja0dyb3VwUGVybWlzc2lvbnMiLCJncm91cElkIiwiRXJyb3IiLCJwbGF0Zm9ybSIsInBsYXRmb3JtSWQiLCJvZmZlclRvQ3JlYXRlIiwiZ3JvdXBfaWQiLCJwbGF0Zm9ybV9pZCIsInN0YXR1cyIsInNsb3RzX3RvdGFsIiwic2xvdHNUb3RhbCIsInNsb3RzX2F2YWlsYWJsZSIsInByaWNlX3Blcl9zbG90IiwicHJpY2VQZXJTbG90IiwiY3VycmVuY3kiLCJjcmVhdGVkX2F0IiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwidXBkYXRlZF9hdCIsImNyZWF0ZWRPZmZlciIsImNyZWF0ZSIsImFjY2Vzc0luc3RydWN0aW9ucyIsInNhdmVBY2Nlc3NJbnN0cnVjdGlvbnMiLCJpZCIsImxvZ09mZmVyQWN0aXZpdHkiLCJ1cGRhdGVPZmZlciIsInVwZGF0ZXMiLCJvZmZlciIsImNoZWNrT2ZmZXJQZXJtaXNzaW9ucyIsInVwZGF0ZURhdGEiLCJ1bmRlZmluZWQiLCJzbG90c0F2YWlsYWJsZSIsInVwZGF0ZWRPZmZlciIsInVwZGF0ZSIsIk9iamVjdCIsImtleXMiLCJkZWxldGVPZmZlciIsImhhc0FjdGl2ZVB1cmNoYXNlcyIsImNoZWNrQWN0aXZlUHVyY2hhc2VzIiwic3VjY2VzcyIsImRlbGV0ZSIsImluc3RydWN0aW9ucyIsImVuY3J5cHRpb25LZXlJZCIsImRhdGEiLCJleGlzdGluZ0tleSIsImZyb20iLCJzZWxlY3QiLCJlcSIsInNpbmdsZSIsIm5ld0tleSIsImtleV90eXBlIiwicHVibGljX2tleSIsIk1hdGgiLCJyYW5kb20iLCJ0b1N0cmluZyIsInN1YnN0cmluZyIsInByaXZhdGVfa2V5X2VuYyIsImFjdGl2ZSIsImNyZWF0ZWRLZXkiLCJpbnNlcnQiLCJlbmNyeXB0ZWRQYWNrYWdlIiwiZW5jcnlwdEFjY2Vzc0luc3RydWN0aW9ucyIsImVuY3J5cHRlZERhdGEiLCJCdWZmZXIiLCJpdiIsImF1dGhUYWciLCJkYXRhS2V5RW5jIiwiZXhpc3RpbmdJbnN0cnVjdGlvbnMiLCJtYXliZVNpbmdsZSIsImVuY3J5cHRlZF9kYXRhIiwiZGF0YV9rZXlfZW5jIiwiZW5jcnlwdGlvbl92ZXJzaW9uIiwiZ3JvdXBfc3ViX2lkIiwiZW5jcnlwdGlvbl9rZXlfaWQiLCJlcnJvciIsImNvbnNvbGUiLCJpbml0aWF0ZVB1cmNoYXNlIiwiaXNPd25lck9yQWRtaW4iLCJwdXJjaGFzZVJlY29yZCIsInVzZXJfaWQiLCJwdXJjaGFzZSIsIm1lc3NhZ2UiLCJwdXJjaGFzZV9pZCIsImdyb3VwIiwib3duZXJfaWQiLCJtZW1iZXJzaGlwIiwicm9sZSIsImNvdW50IiwiaGVhZCIsImluIiwiYWN0aW9uIiwiZGV0YWlscyIsImFjdGlvbl90eXBlIiwicmVzb3VyY2VfdHlwZSIsInJlc291cmNlX2lkIiwiU3RyaW5nIiwib2ZmZXJTZXJ2aWNlIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./src/services/offer/offer-service.js\n");

/***/ }),

/***/ "(rsc)/./src/services/payment/payment-service.js":
/*!*************************************************!*\
  !*** ./src/services/payment/payment-service.js ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   PaymentService: () => (/* binding */ PaymentService),\n/* harmony export */   paymentService: () => (/* binding */ paymentService)\n/* harmony export */ });\n/* harmony import */ var _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @/lib/database/supabase-admin-client */ \"(rsc)/./src/lib/database/supabase-admin-client.js\");\n/* harmony import */ var _lib_security_token_service__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @/lib/security/token-service */ \"(rsc)/./src/lib/security/token-service.js\");\n/* harmony import */ var _offer_offer_service__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../offer/offer-service */ \"(rsc)/./src/services/offer/offer-service.js\");\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! crypto */ \"crypto\");\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_3__);\n// src/services/payment/payment-service.js\n\n\n\n\n/**\r\n * Serwis płatności - zarządza procesem płatności i dostępu do subskrypcji\r\n */ class PaymentService {\n    /**\r\n   * Inicjalizuje serwis płatności\r\n   * @param {Object} deps - Zależności serwisu\r\n   */ constructor(deps = {}){\n        this.offerService = deps.offerService || _offer_offer_service__WEBPACK_IMPORTED_MODULE_2__.offerService;\n        this.tokenService = deps.tokenService || _lib_security_token_service__WEBPACK_IMPORTED_MODULE_1__.tokenService;\n        // Konfiguracja prowizji platformy\n        this.platformFeePercent = 0.05; // 5%\n    }\n    /**\r\n   * Bezpieczne zmniejszenie liczby dostępnych miejsc w ofercie\r\n   * Nie rzuca błędu, jeśli nie ma miejsc do zmniejszenia\r\n   * @param {string} offerId - ID oferty\r\n   * @returns {Promise<boolean>} - Czy operacja się powiodła\r\n   */ async safeDecrementAvailableSlots(offerId) {\n        try {\n            // Pobierz aktualną liczbę dostępnych miejsc\n            const { data: offer, error: fetchError } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"group_subs\").select(\"slots_available, slots_total\").eq(\"id\", offerId).single();\n            // Sprawdź błędy pobierania\n            if (fetchError) {\n                console.error(`Error fetching offer ${offerId}:`, fetchError);\n                return false; // Nie rzucaj błędu, zwróć false\n            }\n            // Sprawdź czy dane oferty istnieją\n            if (!offer) {\n                console.error(`Offer ${offerId} not found`);\n                return false; // Nie rzucaj błędu, zwróć false\n            }\n            console.log(`Offer ${offerId} current slots: ${offer.slots_available}/${offer.slots_total}`);\n            // Tolerancja na niezgodność danych - jeśli slots_available jest null lub undefined, \n            // przyjmujemy że jest tyle samo co slots_total\n            if (offer.slots_available === null || offer.slots_available === undefined) {\n                console.warn(`Offer ${offerId} has null/undefined slots_available, using slots_total`);\n                offer.slots_available = offer.slots_total || 0;\n            }\n            // Konwersja na liczby dla bezpieczeństwa\n            const availableSlots = parseInt(offer.slots_available);\n            // Sprawdź, czy są dostępne miejsca - jeśli nie, zwróć false bez rzucania błędu\n            if (isNaN(availableSlots) || availableSlots <= 0) {\n                console.warn(`No available slots for offer ${offerId}: ${availableSlots}. Cannot decrement.`);\n                return false; // Nie rzucaj błędu, zwróć false\n            }\n            console.log(`Decrementing slots for offer ${offerId} from ${availableSlots} to ${availableSlots - 1}`);\n            // Zmniejsz liczbę dostępnych miejsc - używamy równania slots_available = slots_available - 1\n            // zamiast wpisywania konkretnej wartości, aby uniknąć race condition\n            const { data: updatedOffer, error: updateError } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"group_subs\").update({\n                slots_available: availableSlots - 1,\n                updated_at: new Date().toISOString()\n            }).eq(\"id\", offerId).select(\"slots_available\").single();\n            if (updateError) {\n                console.error(`Error updating slots for offer ${offerId}:`, updateError);\n                return false; // Nie rzucaj błędu, zwróć false\n            }\n            console.log(`Successfully updated slots for offer ${offerId}, new value: ${updatedOffer.slots_available}`);\n            return true;\n        } catch (error) {\n            console.error(\"Error in safeDecrementAvailableSlots:\", error);\n            return false; // Nie rzucaj błędu, zwróć false\n        }\n    }\n    /**\r\n * Przetwarza płatność dla zakupu subskrypcji\r\n * @param {string} purchaseId - ID zakupu\r\n * @param {string} paymentMethod - Metoda płatności\r\n * @param {string} userId - ID użytkownika\r\n * @returns {Promise<Object>} - Dane dostępu\r\n */ async processPayment(purchaseId, paymentMethod, userId) {\n        // Flag dla ukończonych już etapów, żeby można było bezpiecznie zakończyć płatność \n        // nawet jeśli zmniejszenie liczby miejsc się nie powiedzie\n        const completedSteps = {\n            transactionCreated: false,\n            paymentProcessed: false,\n            purchaseUpdated: false,\n            slotsUpdated: false,\n            tokenGenerated: false,\n            groupMemberAdded: false\n        };\n        // Flag sprawdzający czy dekrementacja miejsc została już wykonana\n        let slotsAlreadyDecremented = false;\n        try {\n            console.log(`Processing payment for purchase ${purchaseId}, user ${userId}, method ${paymentMethod}`);\n            // 1. Pobierz dane zakupu\n            const purchase = await this.getPurchaseRecord(purchaseId);\n            console.log(`Found purchase record: ${purchaseId}, status: ${purchase.status}`);\n            // 1.1 Sprawdź, czy miejsca nie zostały już zdekrememtowane dla tego zakupu\n            if (purchase.slots_decremented) {\n                console.log(`Slots already decremented for purchase ${purchaseId}, will skip decrement`);\n                slotsAlreadyDecremented = true;\n            }\n            // 2. Sprawdź, czy zakup należy do użytkownika\n            if (purchase.user_id !== userId) {\n                console.warn(`User ${userId} attempted to process payment for purchase ${purchaseId} belonging to user ${purchase.user_id}`);\n                throw new Error(\"Brak uprawnień do przetworzenia tej płatności\");\n            }\n            // 3. Sprawdź, czy zakup jest w stanie oczekiwania na płatność\n            if (purchase.status !== \"pending_payment\") {\n                console.warn(`Invalid purchase status for ${purchaseId}: ${purchase.status}`);\n                throw new Error(\"Zakup nie jest w stanie oczekiwania na płatność\");\n            }\n            // 4. Sprawdź, czy oferta jest nadal aktywna i ma dostępne miejsca\n            const offer = purchase.group_sub;\n            if (!offer) {\n                console.error(`No group_sub found for purchase ${purchaseId}`);\n                throw new Error(\"Nie znaleziono szczeg\\xf3ł\\xf3w oferty dla tego zakupu\");\n            }\n            console.log(`Checking offer ${offer.id}: status=${offer.status}, slots=${offer.slots_available}/${offer.slots_total}`);\n            if (offer.status !== \"active\") {\n                console.warn(`Offer ${offer.id} is not active, status: ${offer.status}`);\n                throw new Error(\"Oferta nie jest już aktywna\");\n            }\n            // 5. Utwórz transakcję\n            console.log(`Creating transaction for purchase ${purchaseId}`);\n            const transactionId = await this.createTransaction(userId, offer.groups?.owner_id, offer.id, purchaseId, offer.price_per_slot, paymentMethod);\n            console.log(`Transaction created: ${transactionId}`);\n            completedSteps.transactionCreated = true;\n            // 6. Przetwórz płatność (symulacja)\n            await this.simulatePaymentProcessing(transactionId);\n            console.log(`Payment processed for transaction ${transactionId}`);\n            completedSteps.paymentProcessed = true;\n            // 7. Zaktualizuj status zakupu\n            await this.updatePurchaseStatus(purchaseId, \"completed\");\n            console.log(`Purchase status updated to completed: ${purchaseId}`);\n            completedSteps.purchaseUpdated = true;\n            // 8. Zmniejsz liczbę dostępnych miejsc w ofercie TYLKO jeśli nie zostało to wcześniej wykonane\n            if (!slotsAlreadyDecremented) {\n                try {\n                    const slotsUpdated = await this.safeDecrementAvailableSlots(offer.id);\n                    console.log(`Slots update result for offer ${offer.id}: ${slotsUpdated ? \"success\" : \"failed\"}`);\n                    completedSteps.slotsUpdated = slotsUpdated;\n                    // Oznacz w rekordzie zakupu, że dekrementacja została wykonana\n                    if (slotsUpdated) {\n                        await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"purchase_records\").update({\n                            slots_decremented: true\n                        }).eq(\"id\", purchaseId);\n                        console.log(`Purchase ${purchaseId} marked as slots_decremented`);\n                    }\n                } catch (slotError) {\n                    // Logujemy błąd, ale kontynuujemy proces\n                    console.warn(`Failed to update available slots for offer ${offer.id}: ${slotError.message}`);\n                    console.warn(\"Continuing payment process regardless of slot update failure\");\n                }\n            } else {\n                console.log(`Skipping slot decrement for offer ${offer.id} as it was already decremented`);\n                completedSteps.slotsUpdated = true; // Oznaczamy jako wykonane, ponieważ nie musimy tego robić\n            }\n            // 9. Dodaj użytkownika do grupy (NOWY KROK)\n            try {\n                if (offer.groups && offer.groups.id) {\n                    const addedToGroup = await this.addUserToGroup(userId, offer.groups.id);\n                    console.log(`User ${userId} added to group ${offer.groups.id}: ${addedToGroup ? \"success\" : \"failed\"}`);\n                    completedSteps.groupMemberAdded = addedToGroup;\n                } else {\n                    console.warn(`No group ID found for offer ${offer.id}, cannot add user to group`);\n                }\n            } catch (groupError) {\n                console.warn(`Failed to add user ${userId} to group: ${groupError.message}`);\n                console.warn(\"Continuing payment process regardless of group membership failure\");\n            }\n            // 10. Wygeneruj token dostępu\n            const { token, tokenId, accessUrl } = await this.generateAccessToken(purchaseId, userId);\n            console.log(`Access token generated: ${tokenId}`);\n            completedSteps.tokenGenerated = true;\n            // 11. Zaloguj operację\n            await this.logPaymentActivity(\"payment_processed\", purchaseId, userId, {\n                transaction_id: transactionId,\n                payment_method: paymentMethod,\n                completed_steps: completedSteps\n            });\n            return {\n                success: true,\n                purchaseId,\n                transactionId,\n                accessUrl\n            };\n        } catch (error) {\n            console.error(\"Error processing payment:\", error);\n            // Jeśli wykonaliśmy już główne kroki płatności, ale wystąpił błąd przy zmniejszaniu miejsc\n            // lub generowaniu tokenu, możemy próbować zakończyć proces mimo to\n            if (completedSteps.transactionCreated && completedSteps.paymentProcessed && completedSteps.purchaseUpdated) {\n                console.warn(\"Error occurred but main payment steps completed. Attempting to recover...\");\n                try {\n                    // Jeśli token nie został wygenerowany, zróbmy to teraz\n                    if (!completedSteps.tokenGenerated) {\n                        console.log(\"Generating access token as part of recovery\");\n                        const { token, tokenId, accessUrl } = await this.generateAccessToken(purchaseId, userId);\n                        // Zaloguj częściowy sukces\n                        await this.logPaymentActivity(\"payment_recovered\", purchaseId, userId, {\n                            error: error.message,\n                            completed_steps: completedSteps,\n                            recovery: true\n                        });\n                        return {\n                            success: true,\n                            purchaseId,\n                            transactionId: null,\n                            accessUrl,\n                            recovered: true\n                        };\n                    }\n                } catch (recoveryError) {\n                    console.error(\"Recovery attempt failed:\", recoveryError);\n                // Kontynuuj do rzucenia głównego błędu\n                }\n            }\n            // Zaloguj błąd płatności\n            if (userId && purchaseId) {\n                await this.logPaymentActivity(\"payment_failed\", purchaseId, userId, {\n                    error: error.message,\n                    completed_steps: completedSteps\n                });\n            }\n            throw error;\n        }\n    }\n    /**\r\n * Dodaje użytkownika do grupy po zakończeniu płatności\r\n * @param {string} userId - ID użytkownika\r\n * @param {string} groupId - ID grupy\r\n * @returns {Promise<boolean>} - Czy operacja się powiodła\r\n */ async addUserToGroup(userId, groupId) {\n        if (!userId || !groupId) {\n            console.warn(\"Missing userId or groupId, cannot add user to group\");\n            return false;\n        }\n        try {\n            // Sprawdź, czy użytkownik już jest członkiem grupy\n            const { data: existingMember } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"group_members\").select(\"id, status\").eq(\"user_id\", userId).eq(\"group_id\", groupId).maybeSingle();\n            if (existingMember) {\n                // Jeśli członek już istnieje, zaktualizuj status na aktywny\n                if (existingMember.status !== \"active\") {\n                    await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"group_members\").update({\n                        status: \"active\",\n                        updated_at: new Date().toISOString()\n                    }).eq(\"id\", existingMember.id);\n                    console.log(`Updated existing member ${existingMember.id} status to active`);\n                } else {\n                    console.log(`User ${userId} is already an active member of group ${groupId}`);\n                }\n                return true;\n            }\n            // Dodaj nowy rekord członkostwa\n            const { error } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"group_members\").insert({\n                group_id: groupId,\n                user_id: userId,\n                role: \"member\",\n                status: \"active\",\n                joined_at: new Date().toISOString(),\n                created_at: new Date().toISOString(),\n                updated_at: new Date().toISOString()\n            });\n            if (error) {\n                console.error(\"Error adding user to group:\", error);\n                return false;\n            }\n            console.log(`User ${userId} successfully added to group ${groupId}`);\n            return true;\n        } catch (error) {\n            console.error(\"Exception adding user to group:\", error);\n            return false;\n        }\n    }\n    /**\r\n   * Pobiera rekord zakupu ze szczegółami\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @returns {Promise<Object>} - Dane zakupu\r\n   */ async getPurchaseRecord(purchaseId) {\n        const { data: purchase, error } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"purchase_records\").select(`\r\n        *,\r\n        group_sub:group_subs(\r\n          *,\r\n          subscription_platforms(*),\r\n          groups(id, name, owner_id)\r\n        )\r\n      `).eq(\"id\", purchaseId).single();\n        if (error) {\n            throw new Error(\"Nie udało się pobrać danych zakupu: \" + error.message);\n        }\n        if (!purchase) {\n            throw new Error(\"Zakup nie istnieje\");\n        }\n        return purchase;\n    }\n    /**\r\n   * Tworzy rekord transakcji\r\n   * @param {string} buyerId - ID kupującego\r\n   * @param {string} sellerId - ID sprzedającego\r\n   * @param {string} groupSubId - ID oferty\r\n   * @param {string} purchaseRecordId - ID zakupu\r\n   * @param {number} amount - Kwota transakcji\r\n   * @param {string} paymentMethod - Metoda płatności\r\n   * @returns {Promise<string>} - ID transakcji\r\n   */ async createTransaction(buyerId, sellerId, groupSubId, purchaseRecordId, amount, paymentMethod) {\n        // Oblicz prowizję platformy\n        const platformFee = amount * this.platformFeePercent;\n        const sellerAmount = amount - platformFee;\n        // Generuj ID płatności (w rzeczywistości otrzymane od dostawcy płatności)\n        const paymentId = \"pmt_\" + Math.random().toString(36).substr(2, 9);\n        // Utwórz transakcję\n        const { data, error } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"transactions\").insert({\n            buyer_id: buyerId,\n            seller_id: sellerId,\n            group_sub_id: groupSubId,\n            purchase_record_id: purchaseRecordId,\n            amount: amount,\n            platform_fee: platformFee,\n            seller_amount: sellerAmount,\n            currency: \"PLN\",\n            payment_method: paymentMethod,\n            payment_provider: \"stripe\",\n            payment_id: paymentId,\n            status: \"pending\",\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString()\n        }).select(\"id\").single();\n        if (error) {\n            throw new Error(\"Nie udało się utworzyć transakcji: \" + error.message);\n        }\n        return data.id;\n    }\n    /**\r\n   * Symuluje przetwarzanie płatności (w rzeczywistości integracja z dostawcą płatności)\r\n   * @param {string} transactionId - ID transakcji\r\n   * @returns {Promise<boolean>} - Czy płatność się powiodła\r\n   */ async simulatePaymentProcessing(transactionId) {\n        // W rzeczywistej implementacji: wywołanie dostawcy płatności\n        // Symulacja udanej płatności\n        // Aktualizuj status transakcji\n        const { error } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"transactions\").update({\n            status: \"completed\",\n            completed_at: new Date().toISOString(),\n            updated_at: new Date().toISOString()\n        }).eq(\"id\", transactionId);\n        if (error) {\n            throw new Error(\"Nie udało się zaktualizować statusu transakcji: \" + error.message);\n        }\n        return true;\n    }\n    /**\r\n   * Aktualizuje status zakupu\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @param {string} status - Nowy status\r\n   * @returns {Promise<Object>} - Zaktualizowany zakup\r\n   */ async updatePurchaseStatus(purchaseId, status) {\n        const updates = {\n            status,\n            updated_at: new Date().toISOString()\n        };\n        // Dodatkowe pola dla statusu \"completed\"\n        if (status === \"completed\") {\n            updates.access_provided = true;\n            updates.access_provided_at = new Date().toISOString();\n        }\n        const { data, error } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"purchase_records\").update(updates).eq(\"id\", purchaseId).select().single();\n        if (error) {\n            throw new Error(\"Nie udało się zaktualizować statusu zakupu: \" + error.message);\n        }\n        return data;\n    }\n    /**\r\n   * Generuje token dostępu dla zakupu\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @param {string} userId - ID użytkownika\r\n   * @returns {Promise<Object>} - Token i URL dostępu\r\n   */ async generateAccessToken(purchaseId, userId) {\n        try {\n            // Używamy ulepszonej wersji generateAccessToken, która jest odporna na brak kolumny created_by\n            const { token, tokenId, accessUrl } = await this.tokenService.generateAccessToken(purchaseId, userId, 30 // 30 minut ważności\n            );\n            return {\n                token,\n                tokenId,\n                accessUrl\n            };\n        } catch (error) {\n            console.error(\"Error generating access token:\", error);\n            // Fallback w przypadku błędu - generowanie tokenu bez tokenService\n            console.log(\"Using fallback token generation method\");\n            // Generuj token samodzielnie\n            const token = crypto__WEBPACK_IMPORTED_MODULE_3___default().randomBytes(32).toString(\"hex\");\n            // Oblicz hash tokenu\n            const tokenHash = crypto__WEBPACK_IMPORTED_MODULE_3___default().createHash(\"sha256\").update(token + (process.env.TOKEN_SALT || \"\")).digest(\"hex\");\n            // Zapisz token w bazie danych (uproszczona wersja)\n            const expiresAt = new Date();\n            expiresAt.setMinutes(expiresAt.getMinutes() + 30); // 30 minut\n            const { data, error: insertError } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"access_tokens\").insert({\n                purchase_record_id: purchaseId,\n                token_hash: tokenHash,\n                expires_at: expiresAt.toISOString(),\n                used: false,\n                created_at: new Date().toISOString()\n            }).select(\"id\").single();\n            if (insertError) {\n                console.error(\"Error creating fallback token:\", insertError);\n                throw new Error(\"Failed to generate access token: \" + insertError.message);\n            }\n            // Generuj URL dostępu\n            const baseUrl = \"http://localhost:3000\" || 0;\n            const accessUrl = `${baseUrl}/access?id=${purchaseId}&token=${token}`;\n            // Loguj operację\n            await this.logPaymentActivity(\"token_generated_fallback\", purchaseId, userId);\n            return {\n                token,\n                tokenId: data.id,\n                accessUrl\n            };\n        }\n    }\n    /**\r\n   * Potwierdza poprawność dostępu do subskrypcji\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @param {boolean} isWorking - Czy dostęp działa poprawnie\r\n   * @param {string} userId - ID użytkownika\r\n   * @returns {Promise<Object>} - Wynik potwierdzenia\r\n   */ async confirmAccess(purchaseId, isWorking, userId) {\n        try {\n            // 1. Pobierz dane zakupu\n            const purchase = await this.getPurchaseRecord(purchaseId);\n            // 2. Sprawdź, czy zakup należy do użytkownika\n            if (purchase.user_id !== userId) {\n                throw new Error(\"Brak uprawnień do potwierdzenia tego dostępu\");\n            }\n            // 3. Sprawdź, czy dostęp został udostępniony\n            if (!purchase.access_provided) {\n                throw new Error(\"Dostęp nie został jeszcze udostępniony\");\n            }\n            // 4. Zaktualizuj status potwierdzenia\n            await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"purchase_records\").update({\n                access_confirmed: true,\n                access_confirmed_at: new Date().toISOString()\n            }).eq(\"id\", purchaseId);\n            // 5. Jeśli dostęp nie działa, utwórz spór\n            if (!isWorking) {\n                const disputeId = await this.createAccessDispute(purchaseId, userId);\n                return {\n                    confirmed: true,\n                    disputeCreated: true,\n                    disputeId\n                };\n            }\n            // 6. Zaloguj operację\n            await this.logPaymentActivity(\"access_confirmation\", purchaseId, userId, {\n                isWorking\n            });\n            return {\n                confirmed: true,\n                disputeCreated: false\n            };\n        } catch (error) {\n            console.error(\"Error confirming access:\", error);\n            throw error;\n        }\n    }\n    /**\r\n   * Tworzy spór dotyczący problemów z dostępem\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @param {string} userId - ID użytkownika\r\n   * @returns {Promise<string>} - ID utworzonego sporu\r\n   */ async createAccessDispute(purchaseId, userId) {\n        // Znajdź transakcję powiązaną z zakupem\n        const { data: transaction } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"transactions\").select(\"id, group_sub_id, seller_id\").eq(\"purchase_record_id\", purchaseId).single();\n        if (!transaction) {\n            throw new Error(\"Nie znaleziono transakcji dla tego zakupu\");\n        }\n        // Utwórz spór\n        const { data: dispute, error } = await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"disputes\").insert({\n            reporter_id: userId,\n            reported_entity_type: \"subscription\",\n            reported_entity_id: transaction.group_sub_id,\n            transaction_id: transaction.id,\n            dispute_type: \"access\",\n            description: \"Automatyczne zgłoszenie: problem z dostępem do subskrypcji\",\n            status: \"open\",\n            evidence_required: true,\n            resolution_deadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString()\n        }).select(\"id\").single();\n        if (error) {\n            throw new Error(\"Nie udało się utworzyć sporu: \" + error.message);\n        }\n        // Powiadomienia\n        await this.createNotifications(dispute.id, userId, transaction.seller_id);\n        return dispute.id;\n    }\n    /**\r\n   * Tworzy powiadomienia o sporze\r\n   * @param {string} disputeId - ID sporu\r\n   * @param {string} buyerId - ID kupującego\r\n   * @param {string} sellerId - ID sprzedającego\r\n   */ async createNotifications(disputeId, buyerId, sellerId) {\n        // Powiadomienie dla kupującego\n        await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"notifications\").insert({\n            user_id: buyerId,\n            type: \"dispute_created\",\n            title: \"Zgłoszenie problemu z dostępem\",\n            content: \"Twoje zgłoszenie zostało zarejestrowane. Skontaktujemy się z Tobą wkr\\xf3tce.\",\n            related_entity_type: \"dispute\",\n            related_entity_id: disputeId,\n            created_at: new Date().toISOString(),\n            is_read: false\n        });\n        // Powiadomienie dla sprzedającego\n        await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"notifications\").insert({\n            user_id: sellerId,\n            type: \"dispute_filed\",\n            title: \"Zgłoszono problem z dostępem\",\n            content: \"Kupujący zgłosił problem z dostępem do Twojej subskrypcji. Prosimy o pilną weryfikację.\",\n            related_entity_type: \"dispute\",\n            related_entity_id: disputeId,\n            created_at: new Date().toISOString(),\n            is_read: false\n        });\n    }\n    /**\r\n   * Loguje aktywność związaną z płatnością\r\n   * @param {string} action - Typ akcji\r\n   * @param {string} purchaseId - ID zakupu\r\n   * @param {string} userId - ID użytkownika\r\n   * @param {Object} details - Dodatkowe szczegóły\r\n   */ async logPaymentActivity(action, purchaseId, userId, details = {}) {\n        try {\n            await _lib_database_supabase_admin_client__WEBPACK_IMPORTED_MODULE_0__[\"default\"].from(\"security_logs\").insert({\n                user_id: userId,\n                action_type: action,\n                resource_type: \"purchase_record\",\n                resource_id: String(purchaseId),\n                status: action.includes(\"_failed\") ? \"failure\" : \"success\",\n                details: details,\n                created_at: new Date().toISOString()\n            });\n        } catch (error) {\n            console.error(\"Error logging payment activity:\", error);\n        // Nie rzucamy błędu, aby nie przerywać głównej operacji\n        }\n    }\n}\n// Eksport instancji domyślnej do użycia w aplikacji\nconst paymentService = new PaymentService();\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvc2VydmljZXMvcGF5bWVudC9wYXltZW50LXNlcnZpY2UuanMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLDBDQUEwQztBQUN1QjtBQUNMO0FBQ047QUFDMUI7QUFFNUI7O0NBRUMsR0FDTSxNQUFNSTtJQUNYOzs7R0FHQyxHQUNEQyxZQUFZQyxPQUFPLENBQUMsQ0FBQyxDQUFFO1FBQ3JCLElBQUksQ0FBQ0osWUFBWSxHQUFHSSxLQUFLSixZQUFZLElBQUlBLDhEQUFZQTtRQUNyRCxJQUFJLENBQUNELFlBQVksR0FBR0ssS0FBS0wsWUFBWSxJQUFJQSxxRUFBWUE7UUFFckQsa0NBQWtDO1FBQ2xDLElBQUksQ0FBQ00sa0JBQWtCLEdBQUcsTUFBTSxLQUFLO0lBQ3ZDO0lBRUE7Ozs7O0dBS0MsR0FDRCxNQUFNQyw0QkFBNEJDLE9BQU8sRUFBRTtRQUN6QyxJQUFJO1lBQ0YsNENBQTRDO1lBQzVDLE1BQU0sRUFBRUMsTUFBTUMsS0FBSyxFQUFFQyxPQUFPQyxVQUFVLEVBQUUsR0FBRyxNQUFNYiwyRUFBYUEsQ0FDM0RjLElBQUksQ0FBQyxjQUNMQyxNQUFNLENBQUMsZ0NBQ1BDLEVBQUUsQ0FBQyxNQUFNUCxTQUNUUSxNQUFNO1lBRVQsMkJBQTJCO1lBQzNCLElBQUlKLFlBQVk7Z0JBQ2RLLFFBQVFOLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixFQUFFSCxRQUFRLENBQUMsQ0FBQyxFQUFFSTtnQkFDbEQsT0FBTyxPQUFPLGdDQUFnQztZQUNoRDtZQUVBLG1DQUFtQztZQUNuQyxJQUFJLENBQUNGLE9BQU87Z0JBQ1ZPLFFBQVFOLEtBQUssQ0FBQyxDQUFDLE1BQU0sRUFBRUgsUUFBUSxVQUFVLENBQUM7Z0JBQzFDLE9BQU8sT0FBTyxnQ0FBZ0M7WUFDaEQ7WUFFQVMsUUFBUUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFVixRQUFRLGdCQUFnQixFQUFFRSxNQUFNUyxlQUFlLENBQUMsQ0FBQyxFQUFFVCxNQUFNVSxXQUFXLENBQUMsQ0FBQztZ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O2dCQUNUcUgsYUFBYUY7Z0JBQ2JHLGVBQWU7Z0JBQ2ZDLGFBQWFDLE9BQU8xSDtnQkFDcEJhLFFBQVF3RyxPQUFPTSxRQUFRLENBQUMsYUFBYSxZQUFZO2dCQUNqREwsU0FBU0E7Z0JBQ1RwRSxZQUFZLElBQUlyRCxPQUFPQyxXQUFXO1lBQ3BDO1FBQ0osRUFBRSxPQUFPcEIsT0FBTztZQUNkTSxRQUFRTixLQUFLLENBQUMsbUNBQW1DQTtRQUNqRCx3REFBd0Q7UUFDMUQ7SUFDRjtBQUNGO0FBRUEsb0RBQW9EO0FBQzdDLE1BQU1rSixpQkFBaUIsSUFBSTFKLGlCQUFpQiIsInNvdXJjZXMiOlsid2VicGFjazovL2dyb3Vwc2hhcmUtcHJvamVjdC8uL3NyYy9zZXJ2aWNlcy9wYXltZW50L3BheW1lbnQtc2VydmljZS5qcz8wNjdhIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9zZXJ2aWNlcy9wYXltZW50L3BheW1lbnQtc2VydmljZS5qc1xyXG5pbXBvcnQgc3VwYWJhc2VBZG1pbiBmcm9tICdAL2xpYi9kYXRhYmFzZS9zdXBhYmFzZS1hZG1pbi1jbGllbnQnO1xyXG5pbXBvcnQgeyB0b2tlblNlcnZpY2UgfSBmcm9tICdAL2xpYi9zZWN1cml0eS90b2tlbi1zZXJ2aWNlJztcclxuaW1wb3J0IHsgb2ZmZXJTZXJ2aWNlIH0gZnJvbSAnLi4vb2ZmZXIvb2ZmZXItc2VydmljZSc7XHJcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcclxuXHJcbi8qKlxyXG4gKiBTZXJ3aXMgcMWCYXRub8WbY2kgLSB6YXJ6xIVkemEgcHJvY2VzZW0gcMWCYXRub8WbY2kgaSBkb3N0xJlwdSBkbyBzdWJza3J5cGNqaVxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFBheW1lbnRTZXJ2aWNlIHtcclxuICAvKipcclxuICAgKiBJbmljamFsaXp1amUgc2Vyd2lzIHDFgmF0bm/Fm2NpXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IGRlcHMgLSBaYWxlxbxub8WbY2kgc2Vyd2lzdVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKGRlcHMgPSB7fSkge1xyXG4gICAgdGhpcy5vZmZlclNlcnZpY2UgPSBkZXBzLm9mZmVyU2VydmljZSB8fCBvZmZlclNlcnZpY2U7XHJcbiAgICB0aGlzLnRva2VuU2VydmljZSA9IGRlcHMudG9rZW5TZXJ2aWNlIHx8IHRva2VuU2VydmljZTtcclxuICAgIFxyXG4gICAgLy8gS29uZmlndXJhY2phIHByb3dpemppIHBsYXRmb3JteVxyXG4gICAgdGhpcy5wbGF0Zm9ybUZlZVBlcmNlbnQgPSAwLjA1OyAvLyA1JVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQmV6cGllY3puZSB6bW5pZWpzemVuaWUgbGljemJ5IGRvc3TEmXBueWNoIG1pZWpzYyB3IG9mZXJjaWVcclxuICAgKiBOaWUgcnp1Y2EgYsWCxJlkdSwgamXFm2xpIG5pZSBtYSBtaWVqc2MgZG8gem1uaWVqc3plbmlhXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9mZmVySWQgLSBJRCBvZmVydHlcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gLSBDenkgb3BlcmFjamEgc2nEmSBwb3dpb2TFgmFcclxuICAgKi9cclxuICBhc3luYyBzYWZlRGVjcmVtZW50QXZhaWxhYmxlU2xvdHMob2ZmZXJJZCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gUG9iaWVyeiBha3R1YWxuxIUgbGljemLEmSBkb3N0xJlwbnljaCBtaWVqc2NcclxuICAgICAgY29uc3QgeyBkYXRhOiBvZmZlciwgZXJyb3I6IGZldGNoRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgICAuZnJvbSgnZ3JvdXBfc3VicycpXHJcbiAgICAgICAgLnNlbGVjdCgnc2xvdHNfYXZhaWxhYmxlLCBzbG90c190b3RhbCcpXHJcbiAgICAgICAgLmVxKCdpZCcsIG9mZmVySWQpXHJcbiAgICAgICAgLnNpbmdsZSgpO1xyXG4gICAgICBcclxuICAgICAgLy8gU3ByYXdkxbogYsWCxJlkeSBwb2JpZXJhbmlhXHJcbiAgICAgIGlmIChmZXRjaEVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgZmV0Y2hpbmcgb2ZmZXIgJHtvZmZlcklkfTpgLCBmZXRjaEVycm9yKTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7IC8vIE5pZSByenVjYWogYsWCxJlkdSwgendyw7PEhyBmYWxzZVxyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvLyBTcHJhd2TFuiBjenkgZGFuZSBvZmVydHkgaXN0bmllasSFXHJcbiAgICAgIGlmICghb2ZmZXIpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGBPZmZlciAke29mZmVySWR9IG5vdCBmb3VuZGApO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTsgLy8gTmllIHJ6dWNhaiBixYLEmWR1LCB6d3LDs8SHIGZhbHNlXHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIGNvbnNvbGUubG9nKGBPZmZlciAke29mZmVySWR9IGN1cnJlbnQgc2xvdHM6ICR7b2ZmZXIuc2xvdHNfYXZhaWxhYmxlfS8ke29mZmVyLnNsb3RzX3RvdGFsfWApO1xyXG4gICAgICBcclxuICAgICAgLy8gVG9sZXJhbmNqYSBuYSBuaWV6Z29kbm/Fm8SHIGRhbnljaCAtIGplxZtsaSBzbG90c19hdmFpbGFibGUgamVzdCBudWxsIGx1YiB1bmRlZmluZWQsIFxyXG4gICAgICAvLyBwcnp5am11amVteSDFvGUgamVzdCB0eWxlIHNhbW8gY28gc2xvdHNfdG90YWxcclxuICAgICAgaWYgKG9mZmVyLnNsb3RzX2F2YWlsYWJsZSA9PT0gbnVsbCB8fCBvZmZlci5zbG90c19hdmFpbGFibGUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIGNvbnNvbGUud2FybihgT2ZmZXIgJHtvZmZlcklkfSBoYXMgbnVsbC91bmRlZmluZWQgc2xvdHNfYXZhaWxhYmxlLCB1c2luZyBzbG90c190b3RhbGApO1xyXG4gICAgICAgIG9mZmVyLnNsb3RzX2F2YWlsYWJsZSA9IG9mZmVyLnNsb3RzX3RvdGFsIHx8IDA7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIC8vIEtvbndlcnNqYSBuYSBsaWN6YnkgZGxhIGJlenBpZWN6ZcWEc3R3YVxyXG4gICAgICBjb25zdCBhdmFpbGFibGVTbG90cyA9IHBhcnNlSW50KG9mZmVyLnNsb3RzX2F2YWlsYWJsZSk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBTcHJhd2TFuiwgY3p5IHPEhSBkb3N0xJlwbmUgbWllanNjYSAtIGplxZtsaSBuaWUsIHp3csOzxIcgZmFsc2UgYmV6IHJ6dWNhbmlhIGLFgsSZZHVcclxuICAgICAgaWYgKGlzTmFOKGF2YWlsYWJsZVNsb3RzKSB8fCBhdmFpbGFibGVTbG90cyA8PSAwKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKGBObyBhdmFpbGFibGUgc2xvdHMgZm9yIG9mZmVyICR7b2ZmZXJJZH06ICR7YXZhaWxhYmxlU2xvdHN9LiBDYW5ub3QgZGVjcmVtZW50LmApO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTsgLy8gTmllIHJ6dWNhaiBixYLEmWR1LCB6d3LDs8SHIGZhbHNlXHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIGNvbnNvbGUubG9nKGBEZWNyZW1lbnRpbmcgc2xvdHMgZm9yIG9mZmVyICR7b2ZmZXJJZH0gZnJvbSAke2F2YWlsYWJsZVNsb3RzfSB0byAke2F2YWlsYWJsZVNsb3RzIC0gMX1gKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFptbmllanN6IGxpY3pixJkgZG9zdMSZcG55Y2ggbWllanNjIC0gdcW8eXdhbXkgcsOzd25hbmlhIHNsb3RzX2F2YWlsYWJsZSA9IHNsb3RzX2F2YWlsYWJsZSAtIDFcclxuICAgICAgLy8gemFtaWFzdCB3cGlzeXdhbmlhIGtvbmtyZXRuZWogd2FydG/Fm2NpLCBhYnkgdW5pa27EhcSHIHJhY2UgY29uZGl0aW9uXHJcbiAgICAgIGNvbnN0IHsgZGF0YTogdXBkYXRlZE9mZmVyLCBlcnJvcjogdXBkYXRlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgICAuZnJvbSgnZ3JvdXBfc3VicycpXHJcbiAgICAgICAgLnVwZGF0ZSh7XHJcbiAgICAgICAgICBzbG90c19hdmFpbGFibGU6IGF2YWlsYWJsZVNsb3RzIC0gMSxcclxuICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmVxKCdpZCcsIG9mZmVySWQpXHJcbiAgICAgICAgLnNlbGVjdCgnc2xvdHNfYXZhaWxhYmxlJylcclxuICAgICAgICAuc2luZ2xlKCk7XHJcbiAgICAgIFxyXG4gICAgICBpZiAodXBkYXRlRXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciB1cGRhdGluZyBzbG90cyBmb3Igb2ZmZXIgJHtvZmZlcklkfTpgLCB1cGRhdGVFcnJvcik7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBOaWUgcnp1Y2FqIGLFgsSZZHUsIHp3csOzxIcgZmFsc2VcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgY29uc29sZS5sb2coYFN1Y2Nlc3NmdWxseSB1cGRhdGVkIHNsb3RzIGZvciBvZmZlciAke29mZmVySWR9LCBuZXcgdmFsdWU6ICR7dXBkYXRlZE9mZmVyLnNsb3RzX2F2YWlsYWJsZX1gKTtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBzYWZlRGVjcmVtZW50QXZhaWxhYmxlU2xvdHM6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7IC8vIE5pZSByenVjYWogYsWCxJlkdSwgendyw7PEhyBmYWxzZVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbi8qKlxyXG4gKiBQcnpldHdhcnphIHDFgmF0bm/Fm8SHIGRsYSB6YWt1cHUgc3Vic2tyeXBjamlcclxuICogQHBhcmFtIHtzdHJpbmd9IHB1cmNoYXNlSWQgLSBJRCB6YWt1cHVcclxuICogQHBhcmFtIHtzdHJpbmd9IHBheW1lbnRNZXRob2QgLSBNZXRvZGEgcMWCYXRub8WbY2lcclxuICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIElEIHXFvHl0a293bmlrYVxyXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3Q+fSAtIERhbmUgZG9zdMSZcHVcclxuICovXHJcbmFzeW5jIHByb2Nlc3NQYXltZW50KHB1cmNoYXNlSWQsIHBheW1lbnRNZXRob2QsIHVzZXJJZCkge1xyXG4gIC8vIEZsYWcgZGxhIHVrb8WEY3pvbnljaCBqdcW8IGV0YXDDs3csIMW8ZWJ5IG1vxbxuYSBiecWCbyBiZXpwaWVjem5pZSB6YWtvxYRjennEhyBwxYJhdG5vxZvEhyBcclxuICAvLyBuYXdldCBqZcWbbGkgem1uaWVqc3plbmllIGxpY3pieSBtaWVqc2Mgc2nEmSBuaWUgcG93aWVkemllXHJcbiAgY29uc3QgY29tcGxldGVkU3RlcHMgPSB7XHJcbiAgICB0cmFuc2FjdGlvbkNyZWF0ZWQ6IGZhbHNlLFxyXG4gICAgcGF5bWVudFByb2Nlc3NlZDogZmFsc2UsXHJcbiAgICBwdXJjaGFzZVVwZGF0ZWQ6IGZhbHNlLFxyXG4gICAgc2xvdHNVcGRhdGVkOiBmYWxzZSxcclxuICAgIHRva2VuR2VuZXJhdGVkOiBmYWxzZSxcclxuICAgIGdyb3VwTWVtYmVyQWRkZWQ6IGZhbHNlXHJcbiAgfTtcclxuXHJcbiAgLy8gRmxhZyBzcHJhd2R6YWrEhWN5IGN6eSBkZWtyZW1lbnRhY2phIG1pZWpzYyB6b3N0YcWCYSBqdcW8IHd5a29uYW5hXHJcbiAgbGV0IHNsb3RzQWxyZWFkeURlY3JlbWVudGVkID0gZmFsc2U7XHJcblxyXG4gIHRyeSB7XHJcbiAgICBjb25zb2xlLmxvZyhgUHJvY2Vzc2luZyBwYXltZW50IGZvciBwdXJjaGFzZSAke3B1cmNoYXNlSWR9LCB1c2VyICR7dXNlcklkfSwgbWV0aG9kICR7cGF5bWVudE1ldGhvZH1gKTtcclxuICAgIFxyXG4gICAgLy8gMS4gUG9iaWVyeiBkYW5lIHpha3VwdVxyXG4gICAgY29uc3QgcHVyY2hhc2UgPSBhd2FpdCB0aGlzLmdldFB1cmNoYXNlUmVjb3JkKHB1cmNoYXNlSWQpO1xyXG4gICAgY29uc29sZS5sb2coYEZvdW5kIHB1cmNoYXNlIHJlY29yZDogJHtwdXJjaGFzZUlkfSwgc3RhdHVzOiAke3B1cmNoYXNlLnN0YXR1c31gKTtcclxuICAgIFxyXG4gICAgLy8gMS4xIFNwcmF3ZMW6LCBjenkgbWllanNjYSBuaWUgem9zdGHFgnkganXFvCB6ZGVrcmVtZW10b3dhbmUgZGxhIHRlZ28gemFrdXB1XHJcbiAgICBpZiAocHVyY2hhc2Uuc2xvdHNfZGVjcmVtZW50ZWQpIHtcclxuICAgICAgY29uc29sZS5sb2coYFNsb3RzIGFscmVhZHkgZGVjcmVtZW50ZWQgZm9yIHB1cmNoYXNlICR7cHVyY2hhc2VJZH0sIHdpbGwgc2tpcCBkZWNyZW1lbnRgKTtcclxuICAgICAgc2xvdHNBbHJlYWR5RGVjcmVtZW50ZWQgPSB0cnVlO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyAyLiBTcHJhd2TFuiwgY3p5IHpha3VwIG5hbGXFvHkgZG8gdcW8eXRrb3duaWthXHJcbiAgICBpZiAocHVyY2hhc2UudXNlcl9pZCAhPT0gdXNlcklkKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybihgVXNlciAke3VzZXJJZH0gYXR0ZW1wdGVkIHRvIHByb2Nlc3MgcGF5bWVudCBmb3IgcHVyY2hhc2UgJHtwdXJjaGFzZUlkfSBiZWxvbmdpbmcgdG8gdXNlciAke3B1cmNoYXNlLnVzZXJfaWR9YCk7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignQnJhayB1cHJhd25pZcWEIGRvIHByemV0d29yemVuaWEgdGVqIHDFgmF0bm/Fm2NpJyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIDMuIFNwcmF3ZMW6LCBjenkgemFrdXAgamVzdCB3IHN0YW5pZSBvY3pla2l3YW5pYSBuYSBwxYJhdG5vxZvEh1xyXG4gICAgaWYgKHB1cmNoYXNlLnN0YXR1cyAhPT0gJ3BlbmRpbmdfcGF5bWVudCcpIHtcclxuICAgICAgY29uc29sZS53YXJuKGBJbnZhbGlkIHB1cmNoYXNlIHN0YXR1cyBmb3IgJHtwdXJjaGFzZUlkfTogJHtwdXJjaGFzZS5zdGF0dXN9YCk7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignWmFrdXAgbmllIGplc3QgdyBzdGFuaWUgb2N6ZWtpd2FuaWEgbmEgcMWCYXRub8WbxIcnKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gNC4gU3ByYXdkxbosIGN6eSBvZmVydGEgamVzdCBuYWRhbCBha3R5d25hIGkgbWEgZG9zdMSZcG5lIG1pZWpzY2FcclxuICAgIGNvbnN0IG9mZmVyID0gcHVyY2hhc2UuZ3JvdXBfc3ViO1xyXG4gICAgXHJcbiAgICBpZiAoIW9mZmVyKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYE5vIGdyb3VwX3N1YiBmb3VuZCBmb3IgcHVyY2hhc2UgJHtwdXJjaGFzZUlkfWApO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05pZSB6bmFsZXppb25vIHN6Y3plZ8OzxYLDs3cgb2ZlcnR5IGRsYSB0ZWdvIHpha3VwdScpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zb2xlLmxvZyhgQ2hlY2tpbmcgb2ZmZXIgJHtvZmZlci5pZH06IHN0YXR1cz0ke29mZmVyLnN0YXR1c30sIHNsb3RzPSR7b2ZmZXIuc2xvdHNfYXZhaWxhYmxlfS8ke29mZmVyLnNsb3RzX3RvdGFsfWApO1xyXG4gICAgXHJcbiAgICBpZiAob2ZmZXIuc3RhdHVzICE9PSAnYWN0aXZlJykge1xyXG4gICAgICBjb25zb2xlLndhcm4oYE9mZmVyICR7b2ZmZXIuaWR9IGlzIG5vdCBhY3RpdmUsIHN0YXR1czogJHtvZmZlci5zdGF0dXN9YCk7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignT2ZlcnRhIG5pZSBqZXN0IGp1xbwgYWt0eXduYScpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyA1LiBVdHfDs3J6IHRyYW5zYWtjasSZXHJcbiAgICBjb25zb2xlLmxvZyhgQ3JlYXRpbmcgdHJhbnNhY3Rpb24gZm9yIHB1cmNoYXNlICR7cHVyY2hhc2VJZH1gKTtcclxuICAgIGNvbnN0IHRyYW5zYWN0aW9uSWQgPSBhd2FpdCB0aGlzLmNyZWF0ZVRyYW5zYWN0aW9uKFxyXG4gICAgICB1c2VySWQsXHJcbiAgICAgIG9mZmVyLmdyb3Vwcz8ub3duZXJfaWQsXHJcbiAgICAgIG9mZmVyLmlkLFxyXG4gICAgICBwdXJjaGFzZUlkLFxyXG4gICAgICBvZmZlci5wcmljZV9wZXJfc2xvdCxcclxuICAgICAgcGF5bWVudE1ldGhvZFxyXG4gICAgKTtcclxuICAgIGNvbnNvbGUubG9nKGBUcmFuc2FjdGlvbiBjcmVhdGVkOiAke3RyYW5zYWN0aW9uSWR9YCk7XHJcbiAgICBjb21wbGV0ZWRTdGVwcy50cmFuc2FjdGlvbkNyZWF0ZWQgPSB0cnVlO1xyXG4gICAgXHJcbiAgICAvLyA2LiBQcnpldHfDs3J6IHDFgmF0bm/Fm8SHIChzeW11bGFjamEpXHJcbiAgICBhd2FpdCB0aGlzLnNpbXVsYXRlUGF5bWVudFByb2Nlc3NpbmcodHJhbnNhY3Rpb25JZCk7XHJcbiAgICBjb25zb2xlLmxvZyhgUGF5bWVudCBwcm9jZXNzZWQgZm9yIHRyYW5zYWN0aW9uICR7dHJhbnNhY3Rpb25JZH1gKTtcclxuICAgIGNvbXBsZXRlZFN0ZXBzLnBheW1lbnRQcm9jZXNzZWQgPSB0cnVlO1xyXG4gICAgXHJcbiAgICAvLyA3LiBaYWt0dWFsaXp1aiBzdGF0dXMgemFrdXB1XHJcbiAgICBhd2FpdCB0aGlzLnVwZGF0ZVB1cmNoYXNlU3RhdHVzKHB1cmNoYXNlSWQsICdjb21wbGV0ZWQnKTtcclxuICAgIGNvbnNvbGUubG9nKGBQdXJjaGFzZSBzdGF0dXMgdXBkYXRlZCB0byBjb21wbGV0ZWQ6ICR7cHVyY2hhc2VJZH1gKTtcclxuICAgIGNvbXBsZXRlZFN0ZXBzLnB1cmNoYXNlVXBkYXRlZCA9IHRydWU7XHJcbiAgICBcclxuICAgIC8vIDguIFptbmllanN6IGxpY3pixJkgZG9zdMSZcG55Y2ggbWllanNjIHcgb2ZlcmNpZSBUWUxLTyBqZcWbbGkgbmllIHpvc3RhxYJvIHRvIHdjemXFm25pZWogd3lrb25hbmVcclxuICAgIGlmICghc2xvdHNBbHJlYWR5RGVjcmVtZW50ZWQpIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBzbG90c1VwZGF0ZWQgPSBhd2FpdCB0aGlzLnNhZmVEZWNyZW1lbnRBdmFpbGFibGVTbG90cyhvZmZlci5pZCk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYFNsb3RzIHVwZGF0ZSByZXN1bHQgZm9yIG9mZmVyICR7b2ZmZXIuaWR9OiAke3Nsb3RzVXBkYXRlZCA/ICdzdWNjZXNzJyA6ICdmYWlsZWQnfWApO1xyXG4gICAgICAgIGNvbXBsZXRlZFN0ZXBzLnNsb3RzVXBkYXRlZCA9IHNsb3RzVXBkYXRlZDtcclxuICAgICAgICBcclxuICAgICAgICAvLyBPem5hY3ogdyByZWtvcmR6aWUgemFrdXB1LCDFvGUgZGVrcmVtZW50YWNqYSB6b3N0YcWCYSB3eWtvbmFuYVxyXG4gICAgICAgIGlmIChzbG90c1VwZGF0ZWQpIHtcclxuICAgICAgICAgIGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgICAgICAgLmZyb20oJ3B1cmNoYXNlX3JlY29yZHMnKVxyXG4gICAgICAgICAgICAudXBkYXRlKHsgc2xvdHNfZGVjcmVtZW50ZWQ6IHRydWUgfSlcclxuICAgICAgICAgICAgLmVxKCdpZCcsIHB1cmNoYXNlSWQpO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYFB1cmNoYXNlICR7cHVyY2hhc2VJZH0gbWFya2VkIGFzIHNsb3RzX2RlY3JlbWVudGVkYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoIChzbG90RXJyb3IpIHtcclxuICAgICAgICAvLyBMb2d1amVteSBixYLEhWQsIGFsZSBrb250eW51dWplbXkgcHJvY2VzXHJcbiAgICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gdXBkYXRlIGF2YWlsYWJsZSBzbG90cyBmb3Igb2ZmZXIgJHtvZmZlci5pZH06ICR7c2xvdEVycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICAgICAgY29uc29sZS53YXJuKCdDb250aW51aW5nIHBheW1lbnQgcHJvY2VzcyByZWdhcmRsZXNzIG9mIHNsb3QgdXBkYXRlIGZhaWx1cmUnKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc29sZS5sb2coYFNraXBwaW5nIHNsb3QgZGVjcmVtZW50IGZvciBvZmZlciAke29mZmVyLmlkfSBhcyBpdCB3YXMgYWxyZWFkeSBkZWNyZW1lbnRlZGApO1xyXG4gICAgICBjb21wbGV0ZWRTdGVwcy5zbG90c1VwZGF0ZWQgPSB0cnVlOyAvLyBPem5hY3phbXkgamFrbyB3eWtvbmFuZSwgcG9uaWV3YcW8IG5pZSBtdXNpbXkgdGVnbyByb2JpxIdcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gOS4gRG9kYWogdcW8eXRrb3duaWthIGRvIGdydXB5IChOT1dZIEtST0spXHJcbiAgICB0cnkge1xyXG4gICAgICBpZiAob2ZmZXIuZ3JvdXBzICYmIG9mZmVyLmdyb3Vwcy5pZCkge1xyXG4gICAgICAgIGNvbnN0IGFkZGVkVG9Hcm91cCA9IGF3YWl0IHRoaXMuYWRkVXNlclRvR3JvdXAodXNlcklkLCBvZmZlci5ncm91cHMuaWQpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBVc2VyICR7dXNlcklkfSBhZGRlZCB0byBncm91cCAke29mZmVyLmdyb3Vwcy5pZH06ICR7YWRkZWRUb0dyb3VwID8gJ3N1Y2Nlc3MnIDogJ2ZhaWxlZCd9YCk7XHJcbiAgICAgICAgY29tcGxldGVkU3RlcHMuZ3JvdXBNZW1iZXJBZGRlZCA9IGFkZGVkVG9Hcm91cDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oYE5vIGdyb3VwIElEIGZvdW5kIGZvciBvZmZlciAke29mZmVyLmlkfSwgY2Fubm90IGFkZCB1c2VyIHRvIGdyb3VwYCk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGdyb3VwRXJyb3IpIHtcclxuICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gYWRkIHVzZXIgJHt1c2VySWR9IHRvIGdyb3VwOiAke2dyb3VwRXJyb3IubWVzc2FnZX1gKTtcclxuICAgICAgY29uc29sZS53YXJuKCdDb250aW51aW5nIHBheW1lbnQgcHJvY2VzcyByZWdhcmRsZXNzIG9mIGdyb3VwIG1lbWJlcnNoaXAgZmFpbHVyZScpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyAxMC4gV3lnZW5lcnVqIHRva2VuIGRvc3TEmXB1XHJcbiAgICBjb25zdCB7IHRva2VuLCB0b2tlbklkLCBhY2Nlc3NVcmwgfSA9IGF3YWl0IHRoaXMuZ2VuZXJhdGVBY2Nlc3NUb2tlbihwdXJjaGFzZUlkLCB1c2VySWQpO1xyXG4gICAgY29uc29sZS5sb2coYEFjY2VzcyB0b2tlbiBnZW5lcmF0ZWQ6ICR7dG9rZW5JZH1gKTtcclxuICAgIGNvbXBsZXRlZFN0ZXBzLnRva2VuR2VuZXJhdGVkID0gdHJ1ZTtcclxuICAgIFxyXG4gICAgLy8gMTEuIFphbG9ndWogb3BlcmFjasSZXHJcbiAgICBhd2FpdCB0aGlzLmxvZ1BheW1lbnRBY3Rpdml0eSgncGF5bWVudF9wcm9jZXNzZWQnLCBwdXJjaGFzZUlkLCB1c2VySWQsIHtcclxuICAgICAgdHJhbnNhY3Rpb25faWQ6IHRyYW5zYWN0aW9uSWQsXHJcbiAgICAgIHBheW1lbnRfbWV0aG9kOiBwYXltZW50TWV0aG9kLFxyXG4gICAgICBjb21wbGV0ZWRfc3RlcHM6IGNvbXBsZXRlZFN0ZXBzXHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3VjY2VzczogdHJ1ZSxcclxuICAgICAgcHVyY2hhc2VJZCxcclxuICAgICAgdHJhbnNhY3Rpb25JZCxcclxuICAgICAgYWNjZXNzVXJsXHJcbiAgICB9O1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBwcm9jZXNzaW5nIHBheW1lbnQ6JywgZXJyb3IpO1xyXG4gICAgXHJcbiAgICAvLyBKZcWbbGkgd3lrb25hbGnFm215IGp1xbwgZ8WCw7N3bmUga3Jva2kgcMWCYXRub8WbY2ksIGFsZSB3eXN0xIVwacWCIGLFgsSFZCBwcnp5IHptbmllanN6YW5pdSBtaWVqc2NcclxuICAgIC8vIGx1YiBnZW5lcm93YW5pdSB0b2tlbnUsIG1vxbxlbXkgcHLDs2Jvd2HEhyB6YWtvxYRjennEhyBwcm9jZXMgbWltbyB0b1xyXG4gICAgaWYgKGNvbXBsZXRlZFN0ZXBzLnRyYW5zYWN0aW9uQ3JlYXRlZCAmJiBcclxuICAgICAgICBjb21wbGV0ZWRTdGVwcy5wYXltZW50UHJvY2Vzc2VkICYmIFxyXG4gICAgICAgIGNvbXBsZXRlZFN0ZXBzLnB1cmNoYXNlVXBkYXRlZCkge1xyXG4gICAgICBcclxuICAgICAgY29uc29sZS53YXJuKCdFcnJvciBvY2N1cnJlZCBidXQgbWFpbiBwYXltZW50IHN0ZXBzIGNvbXBsZXRlZC4gQXR0ZW1wdGluZyB0byByZWNvdmVyLi4uJyk7XHJcbiAgICAgIFxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIC8vIEplxZtsaSB0b2tlbiBuaWUgem9zdGHFgiB3eWdlbmVyb3dhbnksIHpyw7NibXkgdG8gdGVyYXpcclxuICAgICAgICBpZiAoIWNvbXBsZXRlZFN0ZXBzLnRva2VuR2VuZXJhdGVkKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnR2VuZXJhdGluZyBhY2Nlc3MgdG9rZW4gYXMgcGFydCBvZiByZWNvdmVyeScpO1xyXG4gICAgICAgICAgY29uc3QgeyB0b2tlbiwgdG9rZW5JZCwgYWNjZXNzVXJsIH0gPSBhd2FpdCB0aGlzLmdlbmVyYXRlQWNjZXNzVG9rZW4ocHVyY2hhc2VJZCwgdXNlcklkKTtcclxuICAgICAgICAgIFxyXG4gICAgICAgICAgLy8gWmFsb2d1aiBjesSZxZtjaW93eSBzdWtjZXNcclxuICAgICAgICAgIGF3YWl0IHRoaXMubG9nUGF5bWVudEFjdGl2aXR5KCdwYXltZW50X3JlY292ZXJlZCcsIHB1cmNoYXNlSWQsIHVzZXJJZCwge1xyXG4gICAgICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcclxuICAgICAgICAgICAgY29tcGxldGVkX3N0ZXBzOiBjb21wbGV0ZWRTdGVwcyxcclxuICAgICAgICAgICAgcmVjb3Zlcnk6IHRydWVcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgXHJcbiAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICAgICAgICBwdXJjaGFzZUlkLFxyXG4gICAgICAgICAgICB0cmFuc2FjdGlvbklkOiBudWxsLCAvLyBNb8W8ZW15IG5pZSBtaWXEhyBJRCB0cmFuc2FrY2ppIHcgdHJ5YmllIG9kenlza2l3YW5pYVxyXG4gICAgICAgICAgICBhY2Nlc3NVcmwsXHJcbiAgICAgICAgICAgIHJlY292ZXJlZDogdHJ1ZVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gY2F0Y2ggKHJlY292ZXJ5RXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdSZWNvdmVyeSBhdHRlbXB0IGZhaWxlZDonLCByZWNvdmVyeUVycm9yKTtcclxuICAgICAgICAvLyBLb250eW51dWogZG8gcnp1Y2VuaWEgZ8WCw7N3bmVnbyBixYLEmWR1XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gWmFsb2d1aiBixYLEhWQgcMWCYXRub8WbY2lcclxuICAgIGlmICh1c2VySWQgJiYgcHVyY2hhc2VJZCkge1xyXG4gICAgICBhd2FpdCB0aGlzLmxvZ1BheW1lbnRBY3Rpdml0eSgncGF5bWVudF9mYWlsZWQnLCBwdXJjaGFzZUlkLCB1c2VySWQsIHtcclxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcclxuICAgICAgICBjb21wbGV0ZWRfc3RlcHM6IGNvbXBsZXRlZFN0ZXBzXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBEb2RhamUgdcW8eXRrb3duaWthIGRvIGdydXB5IHBvIHpha2/FhGN6ZW5pdSBwxYJhdG5vxZtjaVxyXG4gKiBAcGFyYW0ge3N0cmluZ30gdXNlcklkIC0gSUQgdcW8eXRrb3duaWthXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBncm91cElkIC0gSUQgZ3J1cHlcclxuICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IC0gQ3p5IG9wZXJhY2phIHNpxJkgcG93aW9kxYJhXHJcbiAqL1xyXG5hc3luYyBhZGRVc2VyVG9Hcm91cCh1c2VySWQsIGdyb3VwSWQpIHtcclxuICBpZiAoIXVzZXJJZCB8fCAhZ3JvdXBJZCkge1xyXG4gICAgY29uc29sZS53YXJuKCdNaXNzaW5nIHVzZXJJZCBvciBncm91cElkLCBjYW5ub3QgYWRkIHVzZXIgdG8gZ3JvdXAnKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbiAgXHJcbiAgdHJ5IHtcclxuICAgIC8vIFNwcmF3ZMW6LCBjenkgdcW8eXRrb3duaWsganXFvCBqZXN0IGN6xYJvbmtpZW0gZ3J1cHlcclxuICAgIGNvbnN0IHsgZGF0YTogZXhpc3RpbmdNZW1iZXIgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgLmZyb20oJ2dyb3VwX21lbWJlcnMnKVxyXG4gICAgICAuc2VsZWN0KCdpZCwgc3RhdHVzJylcclxuICAgICAgLmVxKCd1c2VyX2lkJywgdXNlcklkKVxyXG4gICAgICAuZXEoJ2dyb3VwX2lkJywgZ3JvdXBJZClcclxuICAgICAgLm1heWJlU2luZ2xlKCk7XHJcbiAgICBcclxuICAgIGlmIChleGlzdGluZ01lbWJlcikge1xyXG4gICAgICAvLyBKZcWbbGkgY3rFgm9uZWsganXFvCBpc3RuaWVqZSwgemFrdHVhbGl6dWogc3RhdHVzIG5hIGFrdHl3bnlcclxuICAgICAgaWYgKGV4aXN0aW5nTWVtYmVyLnN0YXR1cyAhPT0gJ2FjdGl2ZScpIHtcclxuICAgICAgICBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgICAuZnJvbSgnZ3JvdXBfbWVtYmVycycpXHJcbiAgICAgICAgICAudXBkYXRlKHtcclxuICAgICAgICAgICAgc3RhdHVzOiAnYWN0aXZlJyxcclxuICAgICAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmVxKCdpZCcsIGV4aXN0aW5nTWVtYmVyLmlkKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zb2xlLmxvZyhgVXBkYXRlZCBleGlzdGluZyBtZW1iZXIgJHtleGlzdGluZ01lbWJlci5pZH0gc3RhdHVzIHRvIGFjdGl2ZWApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBVc2VyICR7dXNlcklkfSBpcyBhbHJlYWR5IGFuIGFjdGl2ZSBtZW1iZXIgb2YgZ3JvdXAgJHtncm91cElkfWApO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBEb2RhaiBub3d5IHJla29yZCBjesWCb25rb3N0d2FcclxuICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgLmZyb20oJ2dyb3VwX21lbWJlcnMnKVxyXG4gICAgICAuaW5zZXJ0KHtcclxuICAgICAgICBncm91cF9pZDogZ3JvdXBJZCxcclxuICAgICAgICB1c2VyX2lkOiB1c2VySWQsXHJcbiAgICAgICAgcm9sZTogJ21lbWJlcicsXHJcbiAgICAgICAgc3RhdHVzOiAnYWN0aXZlJyxcclxuICAgICAgICBqb2luZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH0pO1xyXG4gICAgXHJcbiAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYWRkaW5nIHVzZXIgdG8gZ3JvdXA6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnNvbGUubG9nKGBVc2VyICR7dXNlcklkfSBzdWNjZXNzZnVsbHkgYWRkZWQgdG8gZ3JvdXAgJHtncm91cElkfWApO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ0V4Y2VwdGlvbiBhZGRpbmcgdXNlciB0byBncm91cDonLCBlcnJvcik7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG59XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogUG9iaWVyYSByZWtvcmQgemFrdXB1IHplIHN6Y3plZ8OzxYJhbWlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHVyY2hhc2VJZCAtIElEIHpha3VwdVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59IC0gRGFuZSB6YWt1cHVcclxuICAgKi9cclxuICBhc3luYyBnZXRQdXJjaGFzZVJlY29yZChwdXJjaGFzZUlkKSB7XHJcbiAgICBjb25zdCB7IGRhdGE6IHB1cmNoYXNlLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAuZnJvbSgncHVyY2hhc2VfcmVjb3JkcycpXHJcbiAgICAgIC5zZWxlY3QoYFxyXG4gICAgICAgICosXHJcbiAgICAgICAgZ3JvdXBfc3ViOmdyb3VwX3N1YnMoXHJcbiAgICAgICAgICAqLFxyXG4gICAgICAgICAgc3Vic2NyaXB0aW9uX3BsYXRmb3JtcygqKSxcclxuICAgICAgICAgIGdyb3VwcyhpZCwgbmFtZSwgb3duZXJfaWQpXHJcbiAgICAgICAgKVxyXG4gICAgICBgKVxyXG4gICAgICAuZXEoJ2lkJywgcHVyY2hhc2VJZClcclxuICAgICAgLnNpbmdsZSgpO1xyXG4gICAgXHJcbiAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdOaWUgdWRhxYJvIHNpxJkgcG9icmHEhyBkYW55Y2ggemFrdXB1OiAnICsgZXJyb3IubWVzc2FnZSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGlmICghcHVyY2hhc2UpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdaYWt1cCBuaWUgaXN0bmllamUnKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcmV0dXJuIHB1cmNoYXNlO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBUd29yenkgcmVrb3JkIHRyYW5zYWtjamlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gYnV5ZXJJZCAtIElEIGt1cHVqxIVjZWdvXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNlbGxlcklkIC0gSUQgc3ByemVkYWrEhWNlZ29cclxuICAgKiBAcGFyYW0ge3N0cmluZ30gZ3JvdXBTdWJJZCAtIElEIG9mZXJ0eVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwdXJjaGFzZVJlY29yZElkIC0gSUQgemFrdXB1XHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIEt3b3RhIHRyYW5zYWtjamlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcGF5bWVudE1ldGhvZCAtIE1ldG9kYSBwxYJhdG5vxZtjaVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZz59IC0gSUQgdHJhbnNha2NqaVxyXG4gICAqL1xyXG4gIGFzeW5jIGNyZWF0ZVRyYW5zYWN0aW9uKGJ1eWVySWQsIHNlbGxlcklkLCBncm91cFN1YklkLCBwdXJjaGFzZVJlY29yZElkLCBhbW91bnQsIHBheW1lbnRNZXRob2QpIHtcclxuICAgIC8vIE9ibGljeiBwcm93aXpqxJkgcGxhdGZvcm15XHJcbiAgICBjb25zdCBwbGF0Zm9ybUZlZSA9IGFtb3VudCAqIHRoaXMucGxhdGZvcm1GZWVQZXJjZW50O1xyXG4gICAgY29uc3Qgc2VsbGVyQW1vdW50ID0gYW1vdW50IC0gcGxhdGZvcm1GZWU7XHJcbiAgICBcclxuICAgIC8vIEdlbmVydWogSUQgcMWCYXRub8WbY2kgKHcgcnplY3p5d2lzdG/Fm2NpIG90cnp5bWFuZSBvZCBkb3N0YXdjeSBwxYJhdG5vxZtjaSlcclxuICAgIGNvbnN0IHBheW1lbnRJZCA9ICdwbXRfJyArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KTtcclxuICAgIFxyXG4gICAgLy8gVXR3w7NyeiB0cmFuc2FrY2rEmVxyXG4gICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAuZnJvbSgndHJhbnNhY3Rpb25zJylcclxuICAgICAgLmluc2VydCh7XHJcbiAgICAgICAgYnV5ZXJfaWQ6IGJ1eWVySWQsXHJcbiAgICAgICAgc2VsbGVyX2lkOiBzZWxsZXJJZCxcclxuICAgICAgICBncm91cF9zdWJfaWQ6IGdyb3VwU3ViSWQsXHJcbiAgICAgICAgcHVyY2hhc2VfcmVjb3JkX2lkOiBwdXJjaGFzZVJlY29yZElkLFxyXG4gICAgICAgIGFtb3VudDogYW1vdW50LFxyXG4gICAgICAgIHBsYXRmb3JtX2ZlZTogcGxhdGZvcm1GZWUsXHJcbiAgICAgICAgc2VsbGVyX2Ftb3VudDogc2VsbGVyQW1vdW50LFxyXG4gICAgICAgIGN1cnJlbmN5OiAnUExOJywgLy8gRG9tecWbbG5hIHdhbHV0YVxyXG4gICAgICAgIHBheW1lbnRfbWV0aG9kOiBwYXltZW50TWV0aG9kLFxyXG4gICAgICAgIHBheW1lbnRfcHJvdmlkZXI6ICdzdHJpcGUnLCAvLyBEb215xZtsbnkgZG9zdGF3Y2FcclxuICAgICAgICBwYXltZW50X2lkOiBwYXltZW50SWQsXHJcbiAgICAgICAgc3RhdHVzOiAncGVuZGluZycsXHJcbiAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICB9KVxyXG4gICAgICAuc2VsZWN0KCdpZCcpXHJcbiAgICAgIC5zaW5nbGUoKTtcclxuICAgIFxyXG4gICAgaWYgKGVycm9yKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignTmllIHVkYcWCbyBzacSZIHV0d29yennEhyB0cmFuc2FrY2ppOiAnICsgZXJyb3IubWVzc2FnZSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHJldHVybiBkYXRhLmlkO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBTeW11bHVqZSBwcnpldHdhcnphbmllIHDFgmF0bm/Fm2NpICh3IHJ6ZWN6eXdpc3RvxZtjaSBpbnRlZ3JhY2phIHogZG9zdGF3Y8SFIHDFgmF0bm/Fm2NpKVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB0cmFuc2FjdGlvbklkIC0gSUQgdHJhbnNha2NqaVxyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSAtIEN6eSBwxYJhdG5vxZvEhyBzacSZIHBvd2lvZMWCYVxyXG4gICAqL1xyXG4gIGFzeW5jIHNpbXVsYXRlUGF5bWVudFByb2Nlc3NpbmcodHJhbnNhY3Rpb25JZCkge1xyXG4gICAgLy8gVyByemVjenl3aXN0ZWogaW1wbGVtZW50YWNqaTogd3l3b8WCYW5pZSBkb3N0YXdjeSBwxYJhdG5vxZtjaVxyXG4gICAgLy8gU3ltdWxhY2phIHVkYW5laiBwxYJhdG5vxZtjaVxyXG4gICAgXHJcbiAgICAvLyBBa3R1YWxpenVqIHN0YXR1cyB0cmFuc2FrY2ppXHJcbiAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgIC5mcm9tKCd0cmFuc2FjdGlvbnMnKVxyXG4gICAgICAudXBkYXRlKHtcclxuICAgICAgICBzdGF0dXM6ICdjb21wbGV0ZWQnLFxyXG4gICAgICAgIGNvbXBsZXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICB9KVxyXG4gICAgICAuZXEoJ2lkJywgdHJhbnNhY3Rpb25JZCk7XHJcbiAgICBcclxuICAgIGlmIChlcnJvcikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05pZSB1ZGHFgm8gc2nEmSB6YWt0dWFsaXpvd2HEhyBzdGF0dXN1IHRyYW5zYWtjamk6ICcgKyBlcnJvci5tZXNzYWdlKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIEFrdHVhbGl6dWplIHN0YXR1cyB6YWt1cHVcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHVyY2hhc2VJZCAtIElEIHpha3VwdVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzdGF0dXMgLSBOb3d5IHN0YXR1c1xyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59IC0gWmFrdHVhbGl6b3dhbnkgemFrdXBcclxuICAgKi9cclxuICBhc3luYyB1cGRhdGVQdXJjaGFzZVN0YXR1cyhwdXJjaGFzZUlkLCBzdGF0dXMpIHtcclxuICAgIGNvbnN0IHVwZGF0ZXMgPSB7XHJcbiAgICAgIHN0YXR1cyxcclxuICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICAvLyBEb2RhdGtvd2UgcG9sYSBkbGEgc3RhdHVzdSBcImNvbXBsZXRlZFwiXHJcbiAgICBpZiAoc3RhdHVzID09PSAnY29tcGxldGVkJykge1xyXG4gICAgICB1cGRhdGVzLmFjY2Vzc19wcm92aWRlZCA9IHRydWU7XHJcbiAgICAgIHVwZGF0ZXMuYWNjZXNzX3Byb3ZpZGVkX2F0ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgIC5mcm9tKCdwdXJjaGFzZV9yZWNvcmRzJylcclxuICAgICAgLnVwZGF0ZSh1cGRhdGVzKVxyXG4gICAgICAuZXEoJ2lkJywgcHVyY2hhc2VJZClcclxuICAgICAgLnNlbGVjdCgpXHJcbiAgICAgIC5zaW5nbGUoKTtcclxuICAgIFxyXG4gICAgaWYgKGVycm9yKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignTmllIHVkYcWCbyBzacSZIHpha3R1YWxpem93YcSHIHN0YXR1c3UgemFrdXB1OiAnICsgZXJyb3IubWVzc2FnZSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBHZW5lcnVqZSB0b2tlbiBkb3N0xJlwdSBkbGEgemFrdXB1XHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHB1cmNoYXNlSWQgLSBJRCB6YWt1cHVcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXNlcklkIC0gSUQgdcW8eXRrb3duaWthXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0Pn0gLSBUb2tlbiBpIFVSTCBkb3N0xJlwdVxyXG4gICAqL1xyXG4gIGFzeW5jIGdlbmVyYXRlQWNjZXNzVG9rZW4ocHVyY2hhc2VJZCwgdXNlcklkKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBVxbx5d2FteSB1bGVwc3pvbmVqIHdlcnNqaSBnZW5lcmF0ZUFjY2Vzc1Rva2VuLCBrdMOzcmEgamVzdCBvZHBvcm5hIG5hIGJyYWsga29sdW1ueSBjcmVhdGVkX2J5XHJcbiAgICAgIGNvbnN0IHsgdG9rZW4sIHRva2VuSWQsIGFjY2Vzc1VybCB9ID0gYXdhaXQgdGhpcy50b2tlblNlcnZpY2UuZ2VuZXJhdGVBY2Nlc3NUb2tlbihcclxuICAgICAgICBwdXJjaGFzZUlkLFxyXG4gICAgICAgIHVzZXJJZCxcclxuICAgICAgICAzMCAvLyAzMCBtaW51dCB3YcW8bm/Fm2NpXHJcbiAgICAgICk7XHJcbiAgICAgIFxyXG4gICAgICByZXR1cm4geyB0b2tlbiwgdG9rZW5JZCwgYWNjZXNzVXJsIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBnZW5lcmF0aW5nIGFjY2VzcyB0b2tlbjonLCBlcnJvcik7XHJcbiAgICAgIFxyXG4gICAgICAvLyBGYWxsYmFjayB3IHByenlwYWRrdSBixYLEmWR1IC0gZ2VuZXJvd2FuaWUgdG9rZW51IGJleiB0b2tlblNlcnZpY2VcclxuICAgICAgY29uc29sZS5sb2coJ1VzaW5nIGZhbGxiYWNrIHRva2VuIGdlbmVyYXRpb24gbWV0aG9kJyk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBHZW5lcnVqIHRva2VuIHNhbW9kemllbG5pZVxyXG4gICAgICBjb25zdCB0b2tlbiA9IGNyeXB0by5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xyXG4gICAgICBcclxuICAgICAgLy8gT2JsaWN6IGhhc2ggdG9rZW51XHJcbiAgICAgIGNvbnN0IHRva2VuSGFzaCA9IGNyeXB0b1xyXG4gICAgICAgIC5jcmVhdGVIYXNoKCdzaGEyNTYnKVxyXG4gICAgICAgIC51cGRhdGUodG9rZW4gKyAocHJvY2Vzcy5lbnYuVE9LRU5fU0FMVCB8fCAnJykpXHJcbiAgICAgICAgLmRpZ2VzdCgnaGV4Jyk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBaYXBpc3ogdG9rZW4gdyBiYXppZSBkYW55Y2ggKHVwcm9zemN6b25hIHdlcnNqYSlcclxuICAgICAgY29uc3QgZXhwaXJlc0F0ID0gbmV3IERhdGUoKTtcclxuICAgICAgZXhwaXJlc0F0LnNldE1pbnV0ZXMoZXhwaXJlc0F0LmdldE1pbnV0ZXMoKSArIDMwKTsgLy8gMzAgbWludXRcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3I6IGluc2VydEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgLmZyb20oJ2FjY2Vzc190b2tlbnMnKVxyXG4gICAgICAgIC5pbnNlcnQoe1xyXG4gICAgICAgICAgcHVyY2hhc2VfcmVjb3JkX2lkOiBwdXJjaGFzZUlkLFxyXG4gICAgICAgICAgdG9rZW5faGFzaDogdG9rZW5IYXNoLFxyXG4gICAgICAgICAgZXhwaXJlc19hdDogZXhwaXJlc0F0LnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgICB1c2VkOiBmYWxzZSxcclxuICAgICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnNlbGVjdCgnaWQnKVxyXG4gICAgICAgIC5zaW5nbGUoKTtcclxuICAgICAgXHJcbiAgICAgIGlmIChpbnNlcnRFcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNyZWF0aW5nIGZhbGxiYWNrIHRva2VuOicsIGluc2VydEVycm9yKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBnZW5lcmF0ZSBhY2Nlc3MgdG9rZW46ICcgKyBpbnNlcnRFcnJvci5tZXNzYWdlKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgLy8gR2VuZXJ1aiBVUkwgZG9zdMSZcHVcclxuICAgICAgY29uc3QgYmFzZVVybCA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX0FQUF9VUkwgfHwgJyc7XHJcbiAgICAgIGNvbnN0IGFjY2Vzc1VybCA9IGAke2Jhc2VVcmx9L2FjY2Vzcz9pZD0ke3B1cmNoYXNlSWR9JnRva2VuPSR7dG9rZW59YDtcclxuICAgICAgXHJcbiAgICAgIC8vIExvZ3VqIG9wZXJhY2rEmVxyXG4gICAgICBhd2FpdCB0aGlzLmxvZ1BheW1lbnRBY3Rpdml0eSgndG9rZW5fZ2VuZXJhdGVkX2ZhbGxiYWNrJywgcHVyY2hhc2VJZCwgdXNlcklkKTtcclxuICAgICAgXHJcbiAgICAgIHJldHVybiB7IHRva2VuLCB0b2tlbklkOiBkYXRhLmlkLCBhY2Nlc3NVcmwgfTtcclxuICAgIH1cclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogUG90d2llcmR6YSBwb3ByYXdub8WbxIcgZG9zdMSZcHUgZG8gc3Vic2tyeXBjamlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHVyY2hhc2VJZCAtIElEIHpha3VwdVxyXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNXb3JraW5nIC0gQ3p5IGRvc3TEmXAgZHppYcWCYSBwb3ByYXduaWVcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXNlcklkIC0gSUQgdcW8eXRrb3duaWthXHJcbiAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0Pn0gLSBXeW5payBwb3R3aWVyZHplbmlhXHJcbiAgICovXHJcbiAgYXN5bmMgY29uZmlybUFjY2VzcyhwdXJjaGFzZUlkLCBpc1dvcmtpbmcsIHVzZXJJZCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gMS4gUG9iaWVyeiBkYW5lIHpha3VwdVxyXG4gICAgICBjb25zdCBwdXJjaGFzZSA9IGF3YWl0IHRoaXMuZ2V0UHVyY2hhc2VSZWNvcmQocHVyY2hhc2VJZCk7XHJcbiAgICAgIFxyXG4gICAgICAvLyAyLiBTcHJhd2TFuiwgY3p5IHpha3VwIG5hbGXFvHkgZG8gdcW8eXRrb3duaWthXHJcbiAgICAgIGlmIChwdXJjaGFzZS51c2VyX2lkICE9PSB1c2VySWQpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JyYWsgdXByYXduaWXFhCBkbyBwb3R3aWVyZHplbmlhIHRlZ28gZG9zdMSZcHUnKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgLy8gMy4gU3ByYXdkxbosIGN6eSBkb3N0xJlwIHpvc3RhxYIgdWRvc3TEmXBuaW9ueVxyXG4gICAgICBpZiAoIXB1cmNoYXNlLmFjY2Vzc19wcm92aWRlZCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRG9zdMSZcCBuaWUgem9zdGHFgiBqZXN6Y3plIHVkb3N0xJlwbmlvbnknKTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgLy8gNC4gWmFrdHVhbGl6dWogc3RhdHVzIHBvdHdpZXJkemVuaWFcclxuICAgICAgYXdhaXQgc3VwYWJhc2VBZG1pblxyXG4gICAgICAgIC5mcm9tKCdwdXJjaGFzZV9yZWNvcmRzJylcclxuICAgICAgICAudXBkYXRlKHtcclxuICAgICAgICAgIGFjY2Vzc19jb25maXJtZWQ6IHRydWUsXHJcbiAgICAgICAgICBhY2Nlc3NfY29uZmlybWVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5lcSgnaWQnLCBwdXJjaGFzZUlkKTtcclxuICAgICAgXHJcbiAgICAgIC8vIDUuIEplxZtsaSBkb3N0xJlwIG5pZSBkemlhxYJhLCB1dHfDs3J6IHNww7NyXHJcbiAgICAgIGlmICghaXNXb3JraW5nKSB7XHJcbiAgICAgICAgY29uc3QgZGlzcHV0ZUlkID0gYXdhaXQgdGhpcy5jcmVhdGVBY2Nlc3NEaXNwdXRlKHB1cmNoYXNlSWQsIHVzZXJJZCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIGNvbmZpcm1lZDogdHJ1ZSxcclxuICAgICAgICAgIGRpc3B1dGVDcmVhdGVkOiB0cnVlLFxyXG4gICAgICAgICAgZGlzcHV0ZUlkXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgLy8gNi4gWmFsb2d1aiBvcGVyYWNqxJlcclxuICAgICAgYXdhaXQgdGhpcy5sb2dQYXltZW50QWN0aXZpdHkoJ2FjY2Vzc19jb25maXJtYXRpb24nLCBwdXJjaGFzZUlkLCB1c2VySWQsIHtcclxuICAgICAgICBpc1dvcmtpbmdcclxuICAgICAgfSk7XHJcbiAgICAgIFxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGNvbmZpcm1lZDogdHJ1ZSxcclxuICAgICAgICBkaXNwdXRlQ3JlYXRlZDogZmFsc2VcclxuICAgICAgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNvbmZpcm1pbmcgYWNjZXNzOicsIGVycm9yKTtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIFR3b3J6eSBzcMOzciBkb3R5Y3rEhWN5IHByb2JsZW3Ds3cgeiBkb3N0xJlwZW1cclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHVyY2hhc2VJZCAtIElEIHpha3VwdVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VySWQgLSBJRCB1xbx5dGtvd25pa2FcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxzdHJpbmc+fSAtIElEIHV0d29yem9uZWdvIHNwb3J1XHJcbiAgICovXHJcbiAgYXN5bmMgY3JlYXRlQWNjZXNzRGlzcHV0ZShwdXJjaGFzZUlkLCB1c2VySWQpIHtcclxuICAgIC8vIFpuYWpkxbogdHJhbnNha2NqxJkgcG93acSFemFuxIUgeiB6YWt1cGVtXHJcbiAgICBjb25zdCB7IGRhdGE6IHRyYW5zYWN0aW9uIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgIC5mcm9tKCd0cmFuc2FjdGlvbnMnKVxyXG4gICAgICAuc2VsZWN0KCdpZCwgZ3JvdXBfc3ViX2lkLCBzZWxsZXJfaWQnKVxyXG4gICAgICAuZXEoJ3B1cmNoYXNlX3JlY29yZF9pZCcsIHB1cmNoYXNlSWQpXHJcbiAgICAgIC5zaW5nbGUoKTtcclxuICAgIFxyXG4gICAgaWYgKCF0cmFuc2FjdGlvbikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05pZSB6bmFsZXppb25vIHRyYW5zYWtjamkgZGxhIHRlZ28gemFrdXB1Jyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIFV0d8Ozcnogc3DDs3JcclxuICAgIGNvbnN0IHsgZGF0YTogZGlzcHV0ZSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgLmZyb20oJ2Rpc3B1dGVzJylcclxuICAgICAgLmluc2VydCh7XHJcbiAgICAgICAgcmVwb3J0ZXJfaWQ6IHVzZXJJZCxcclxuICAgICAgICByZXBvcnRlZF9lbnRpdHlfdHlwZTogJ3N1YnNjcmlwdGlvbicsXHJcbiAgICAgICAgcmVwb3J0ZWRfZW50aXR5X2lkOiB0cmFuc2FjdGlvbi5ncm91cF9zdWJfaWQsXHJcbiAgICAgICAgdHJhbnNhY3Rpb25faWQ6IHRyYW5zYWN0aW9uLmlkLFxyXG4gICAgICAgIGRpc3B1dGVfdHlwZTogJ2FjY2VzcycsXHJcbiAgICAgICAgZGVzY3JpcHRpb246ICdBdXRvbWF0eWN6bmUgemfFgm9zemVuaWU6IHByb2JsZW0geiBkb3N0xJlwZW0gZG8gc3Vic2tyeXBjamknLFxyXG4gICAgICAgIHN0YXR1czogJ29wZW4nLFxyXG4gICAgICAgIGV2aWRlbmNlX3JlcXVpcmVkOiB0cnVlLFxyXG4gICAgICAgIHJlc29sdXRpb25fZGVhZGxpbmU6IG5ldyBEYXRlKERhdGUubm93KCkgKyAzICogMjQgKiA2MCAqIDYwICogMTAwMCkudG9JU09TdHJpbmcoKSwgLy8gMyBkbmlcclxuICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH0pXHJcbiAgICAgIC5zZWxlY3QoJ2lkJylcclxuICAgICAgLnNpbmdsZSgpO1xyXG4gICAgXHJcbiAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdOaWUgdWRhxYJvIHNpxJkgdXR3b3J6ecSHIHNwb3J1OiAnICsgZXJyb3IubWVzc2FnZSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIFBvd2lhZG9taWVuaWFcclxuICAgIGF3YWl0IHRoaXMuY3JlYXRlTm90aWZpY2F0aW9ucyhkaXNwdXRlLmlkLCB1c2VySWQsIHRyYW5zYWN0aW9uLnNlbGxlcl9pZCk7XHJcbiAgICBcclxuICAgIHJldHVybiBkaXNwdXRlLmlkO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBUd29yenkgcG93aWFkb21pZW5pYSBvIHNwb3J6ZVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkaXNwdXRlSWQgLSBJRCBzcG9ydVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBidXllcklkIC0gSUQga3VwdWrEhWNlZ29cclxuICAgKiBAcGFyYW0ge3N0cmluZ30gc2VsbGVySWQgLSBJRCBzcHJ6ZWRhasSFY2Vnb1xyXG4gICAqL1xyXG4gIGFzeW5jIGNyZWF0ZU5vdGlmaWNhdGlvbnMoZGlzcHV0ZUlkLCBidXllcklkLCBzZWxsZXJJZCkge1xyXG4gICAgLy8gUG93aWFkb21pZW5pZSBkbGEga3VwdWrEhWNlZ29cclxuICAgIGF3YWl0IHN1cGFiYXNlQWRtaW5cclxuICAgICAgLmZyb20oJ25vdGlmaWNhdGlvbnMnKVxyXG4gICAgICAuaW5zZXJ0KHtcclxuICAgICAgICB1c2VyX2lkOiBidXllcklkLFxyXG4gICAgICAgIHR5cGU6ICdkaXNwdXRlX2NyZWF0ZWQnLFxyXG4gICAgICAgIHRpdGxlOiAnWmfFgm9zemVuaWUgcHJvYmxlbXUgeiBkb3N0xJlwZW0nLFxyXG4gICAgICAgIGNvbnRlbnQ6ICdUd29qZSB6Z8WCb3N6ZW5pZSB6b3N0YcWCbyB6YXJlamVzdHJvd2FuZS4gU2tvbnRha3R1amVteSBzacSZIHogVG9ixIUgd2tyw7N0Y2UuJyxcclxuICAgICAgICByZWxhdGVkX2VudGl0eV90eXBlOiAnZGlzcHV0ZScsXHJcbiAgICAgICAgcmVsYXRlZF9lbnRpdHlfaWQ6IGRpc3B1dGVJZCxcclxuICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgaXNfcmVhZDogZmFsc2VcclxuICAgICAgfSk7XHJcbiAgICBcclxuICAgIC8vIFBvd2lhZG9taWVuaWUgZGxhIHNwcnplZGFqxIVjZWdvXHJcbiAgICBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgIC5mcm9tKCdub3RpZmljYXRpb25zJylcclxuICAgICAgLmluc2VydCh7XHJcbiAgICAgICAgdXNlcl9pZDogc2VsbGVySWQsXHJcbiAgICAgICAgdHlwZTogJ2Rpc3B1dGVfZmlsZWQnLFxyXG4gICAgICAgIHRpdGxlOiAnWmfFgm9zem9ubyBwcm9ibGVtIHogZG9zdMSZcGVtJyxcclxuICAgICAgICBjb250ZW50OiAnS3VwdWrEhWN5IHpnxYJvc2nFgiBwcm9ibGVtIHogZG9zdMSZcGVtIGRvIFR3b2plaiBzdWJza3J5cGNqaS4gUHJvc2lteSBvIHBpbG7EhSB3ZXJ5ZmlrYWNqxJkuJyxcclxuICAgICAgICByZWxhdGVkX2VudGl0eV90eXBlOiAnZGlzcHV0ZScsXHJcbiAgICAgICAgcmVsYXRlZF9lbnRpdHlfaWQ6IGRpc3B1dGVJZCxcclxuICAgICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgaXNfcmVhZDogZmFsc2VcclxuICAgICAgfSk7XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIExvZ3VqZSBha3R5d25vxZvEhyB6d2nEhXphbsSFIHogcMWCYXRub8WbY2nEhVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhY3Rpb24gLSBUeXAgYWtjamlcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHVyY2hhc2VJZCAtIElEIHpha3VwdVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VySWQgLSBJRCB1xbx5dGtvd25pa2FcclxuICAgKiBAcGFyYW0ge09iamVjdH0gZGV0YWlscyAtIERvZGF0a293ZSBzemN6ZWfDs8WCeVxyXG4gICAqL1xyXG4gIGFzeW5jIGxvZ1BheW1lbnRBY3Rpdml0eShhY3Rpb24sIHB1cmNoYXNlSWQsIHVzZXJJZCwgZGV0YWlscyA9IHt9KSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCBzdXBhYmFzZUFkbWluXHJcbiAgICAgICAgLmZyb20oJ3NlY3VyaXR5X2xvZ3MnKVxyXG4gICAgICAgIC5pbnNlcnQoe1xyXG4gICAgICAgICAgdXNlcl9pZDogdXNlcklkLFxyXG4gICAgICAgICAgYWN0aW9uX3R5cGU6IGFjdGlvbixcclxuICAgICAgICAgIHJlc291cmNlX3R5cGU6ICdwdXJjaGFzZV9yZWNvcmQnLFxyXG4gICAgICAgICAgcmVzb3VyY2VfaWQ6IFN0cmluZyhwdXJjaGFzZUlkKSxcclxuICAgICAgICAgIHN0YXR1czogYWN0aW9uLmluY2x1ZGVzKCdfZmFpbGVkJykgPyAnZmFpbHVyZScgOiAnc3VjY2VzcycsXHJcbiAgICAgICAgICBkZXRhaWxzOiBkZXRhaWxzLFxyXG4gICAgICAgICAgY3JlYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBsb2dnaW5nIHBheW1lbnQgYWN0aXZpdHk6JywgZXJyb3IpO1xyXG4gICAgICAvLyBOaWUgcnp1Y2FteSBixYLEmWR1LCBhYnkgbmllIHByemVyeXdhxIcgZ8WCw7N3bmVqIG9wZXJhY2ppXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vLyBFa3Nwb3J0IGluc3RhbmNqaSBkb215xZtsbmVqIGRvIHXFvHljaWEgdyBhcGxpa2FjamlcclxuZXhwb3J0IGNvbnN0IHBheW1lbnRTZXJ2aWNlID0gbmV3IFBheW1lbnRTZXJ2aWNlKCk7Il0sIm5hbWVzIjpbInN1cGFiYXNlQWRtaW4iLCJ0b2tlblNlcnZpY2UiLCJvZmZlclNlcnZpY2UiLCJjcnlwdG8iLCJQYXltZW50U2VydmljZSIsImNvbnN0cnVjdG9yIiwiZGVwcyIsInBsYXRmb3JtRmVlUGVyY2VudCIsInNhZmVEZWNyZW1lbnRBdmFpbGFibGVTbG90cyIsIm9mZmVySWQiLCJkYXRhIiwib2ZmZXIiLCJlcnJvciIsImZldGNoRXJyb3IiLCJmcm9tIiwic2VsZWN0IiwiZXEiLCJzaW5nbGUiLCJjb25zb2xlIiwibG9nIiwic2xvdHNfYXZhaWxhYmxlIiwic2xvdHNfdG90YWwiLCJ1bmRlZmluZWQiLCJ3YXJuIiwiYXZhaWxhYmxlU2xvdHMiLCJwYXJzZUludCIsImlzTmFOIiwidXBkYXRlZE9mZmVyIiwidXBkYXRlRXJyb3IiLCJ1cGRhdGUiLCJ1cGRhdGVkX2F0IiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwicHJvY2Vzc1BheW1lbnQiLCJwdXJjaGFzZUlkIiwicGF5bWVudE1ldGhvZCIsInVzZXJJZCIsImNvbXBsZXRlZFN0ZXBzIiwidHJhbnNhY3Rpb25DcmVhdGVkIiwicGF5bWVudFByb2Nlc3NlZCIsInB1cmNoYXNlVXBkYXRlZCIsInNsb3RzVXBkYXRlZCIsInRva2VuR2VuZXJhdGVkIiwiZ3JvdXBNZW1iZXJBZGRlZCIsInNsb3RzQWxyZWFkeURlY3JlbWVudGVkIiwicHVyY2hhc2UiLCJnZXRQdXJjaGFzZVJlY29yZCIsInN0YXR1cyIsInNsb3RzX2RlY3JlbWVudGVkIiwidXNlcl9pZCIsIkVycm9yIiwiZ3JvdXBfc3ViIiwiaWQiLCJ0cmFuc2FjdGlvbklkIiwiY3JlYXRlVHJhbnNhY3Rpb24iLCJncm91cHMiLCJvd25lcl9pZCIsInByaWNlX3Blcl9zbG90Iiwic2ltdWxhdGVQYXltZW50UHJvY2Vzc2luZyIsInVwZGF0ZVB1cmNoYXNlU3RhdHVzIiwic2xvdEVycm9yIiwibWVzc2FnZSIsImFkZGVkVG9Hcm91cCIsImFkZFVzZXJUb0dyb3VwIiwiZ3JvdXBFcnJvciIsInRva2VuIiwidG9rZW5JZCIsImFjY2Vzc1VybCIsImdlbmVyYXRlQWNjZXNzVG9rZW4iLCJsb2dQYXltZW50QWN0aXZpdHkiLCJ0cmFuc2FjdGlvbl9pZCIsInBheW1lbnRfbWV0aG9kIiwiY29tcGxldGVkX3N0ZXBzIiwic3VjY2VzcyIsInJlY292ZXJ5IiwicmVjb3ZlcmVkIiwicmVjb3ZlcnlFcnJvciIsImdyb3VwSWQiLCJleGlzdGluZ01lbWJlciIsIm1heWJlU2luZ2xlIiwiaW5zZXJ0IiwiZ3JvdXBfaWQiLCJyb2xlIiwiam9pbmVkX2F0IiwiY3JlYXRlZF9hdCIsImJ1eWVySWQiLCJzZWxsZXJJZCIsImdyb3VwU3ViSWQiLCJwdXJjaGFzZVJlY29yZElkIiwiYW1vdW50IiwicGxhdGZvcm1GZWUiLCJzZWxsZXJBbW91bnQiLCJwYXltZW50SWQiLCJNYXRoIiwicmFuZG9tIiwidG9TdHJpbmciLCJzdWJzdHIiLCJidXllcl9pZCIsInNlbGxlcl9pZCIsImdyb3VwX3N1Yl9pZCIsInB1cmNoYXNlX3JlY29yZF9pZCIsInBsYXRmb3JtX2ZlZSIsInNlbGxlcl9hbW91bnQiLCJjdXJyZW5jeSIsInBheW1lbnRfcHJvdmlkZXIiLCJwYXltZW50X2lkIiwiY29tcGxldGVkX2F0IiwidXBkYXRlcyIsImFjY2Vzc19wcm92aWRlZCIsImFjY2Vzc19wcm92aWRlZF9hdCIsInJhbmRvbUJ5dGVzIiwidG9rZW5IYXNoIiwiY3JlYXRlSGFzaCIsInByb2Nlc3MiLCJlbnYiLCJUT0tFTl9TQUxUIiwiZGlnZXN0IiwiZXhwaXJlc0F0Iiwic2V0TWludXRlcyIsImdldE1pbnV0ZXMiLCJpbnNlcnRFcnJvciIsInRva2VuX2hhc2giLCJleHBpcmVzX2F0IiwidXNlZCIsImJhc2VVcmwiLCJORVhUX1BVQkxJQ19BUFBfVVJMIiwiY29uZmlybUFjY2VzcyIsImlzV29ya2luZyIsImFjY2Vzc19jb25maXJtZWQiLCJhY2Nlc3NfY29uZmlybWVkX2F0IiwiZGlzcHV0ZUlkIiwiY3JlYXRlQWNjZXNzRGlzcHV0ZSIsImNvbmZpcm1lZCIsImRpc3B1dGVDcmVhdGVkIiwidHJhbnNhY3Rpb24iLCJkaXNwdXRlIiwicmVwb3J0ZXJfaWQiLCJyZXBvcnRlZF9lbnRpdHlfdHlwZSIsInJlcG9ydGVkX2VudGl0eV9pZCIsImRpc3B1dGVfdHlwZSIsImRlc2NyaXB0aW9uIiwiZXZpZGVuY2VfcmVxdWlyZWQiLCJyZXNvbHV0aW9uX2RlYWRsaW5lIiwibm93IiwiY3JlYXRlTm90aWZpY2F0aW9ucyIsInR5cGUiLCJ0aXRsZSIsImNvbnRlbnQiLCJyZWxhdGVkX2VudGl0eV90eXBlIiwicmVsYXRlZF9lbnRpdHlfaWQiLCJpc19yZWFkIiwiYWN0aW9uIiwiZGV0YWlscyIsImFjdGlvbl90eXBlIiwicmVzb3VyY2VfdHlwZSIsInJlc291cmNlX2lkIiwiU3RyaW5nIiwiaW5jbHVkZXMiLCJwYXltZW50U2VydmljZSJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/services/payment/payment-service.js\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/@clerk","vendor-chunks/next","vendor-chunks/tslib","vendor-chunks/cookie","vendor-chunks/map-obj","vendor-chunks/no-case","vendor-chunks/lower-case","vendor-chunks/snakecase-keys","vendor-chunks/snake-case","vendor-chunks/dot-case","vendor-chunks/@supabase","vendor-chunks/tr46","vendor-chunks/whatwg-url","vendor-chunks/webidl-conversions"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fpayments%2Froute&page=%2Fapi%2Fpayments%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fpayments%2Froute.js&appDir=C%3A%5CUsers%5Cbacze%5CProject%5CGroupShare%5Cgroupshare-project%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5Cbacze%5CProject%5CGroupShare%5Cgroupshare-project&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();